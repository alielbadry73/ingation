<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Book Checkout - IG Nation</title>
  <!-- CACHE BUSTER: v20250208-1600 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="css/vendor.css">
  <link rel="stylesheet" type="text/css" href="style.css?v=3">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600;700&family=Roboto+Slab&display=swap"
    rel="stylesheet">
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  
  <!-- Cart Manager - Centralized cart state management -->
  <script src="js/cart-manager.js?v=20250208"></script>
  
  <style>
    /* Override text-transform for all form inputs */
    input, textarea, select, .form-control, .form-select {
      text-transform: none !important;
    }
  </style>
</head>
<body>
  <!-- Top Utility Bar -->
  <div class="top-utility-bar" style="background:#fff; border-bottom:1px solid #eee; position:relative; height:60px;">
    <div class="container-fluid" style="position:relative; height:100%;">
      
      <!-- Centered Logo -->
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);">
        <a href="index.html">
          <img src="images/ig-nation-logo-graduation.png" alt="IG Nation" style="height:50px; width:auto;">
        </a>
      </div>

      <!-- Right-aligned Utility Links -->
      <div style="position:absolute; right:20px; top:50%; transform:translateY(-50%); display:flex; align-items:center; gap:20px; font-size:14px;">
        <!-- Empty - Cart and Favorites removed for book checkout -->
      </div>
    </div>
  </div>

  <!-- Main Navigation Bar -->
  <nav class="main-navigation">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-7">
          <ul class="nav-menu d-flex list-unstyled mb-0">
            <li class="nav-item">
              <a href="index.html" class="nav-link">Home</a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">Courses</a>
            </li>
            <li class="nav-item">
              <a href="about.html" class="nav-link">About Us</a>
            </li>
            <li class="nav-item">
              <a href="contact.html" class="nav-link">Contact Us</a>
            </li>
            <li class="nav-item">
              <!-- FAQ removed -->
            </li>
          </ul>
        </div>
        <div class="col-5">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <a href="#" class="btn btn-outline-secondary login-btn" data-bs-toggle="modal" data-bs-target="#loginModal" style="font-size: 14px; padding: 8px 16px;">
              <iconify-icon icon="material-symbols:login" class="me-1"></iconify-icon>
              Login
            </a>
            <a href="#" class="btn btn-primary register-btn" data-bs-toggle="modal" data-bs-target="#registerModal" style="font-size: 14px; padding: 8px 16px;">
              <iconify-icon icon="material-symbols:person-add" class="me-1"></iconify-icon>
              Register Now
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Checkout Section -->
  <section class="checkout-section py-5" style="margin-top: 120px;">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h3 class="mb-0">
                <iconify-icon icon="material-symbols:payment" class="me-2"></iconify-icon>
                Checkout Information
              </h3>
            </div>
            <div class="card-body p-4">
              <form id="checkoutForm">
                <!-- Personal Information -->
                <div class="mb-4">
                  <h5 class="text-primary mb-3">Personal Information</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label for="checkoutFirstName" class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="checkoutFirstName" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label for="checkoutLastName" class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="checkoutLastName" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                      </div>
                    </div>
                  </div>
                  <div class="form-group mb-3">
                    <label for="checkoutEmail" class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="checkoutEmail" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="checkoutPhone" class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="checkoutPhone" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                  </div>
                </div>

                <!-- Payment Method -->
                <div class="mb-4">
                  <h5 class="text-primary mb-3">Payment Method</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check payment-option">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="instapay" value="instapay">
                        <label class="form-check-label" for="instapay">
                          <div class="payment-card">
                            <iconify-icon icon="material-symbols:account-balance" class="fs-3 text-primary"></iconify-icon>
                            <div>
                              <strong>InstaPay</strong>
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-check payment-option">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="vodafoneCash" value="vodafoneCash">
                        <label class="form-check-label" for="vodafoneCash">
                          <div class="payment-card">
                            <iconify-icon icon="material-symbols:phone-android" class="fs-3 text-success"></iconify-icon>
                            <div>
                              <strong>Vodafone Cash</strong>
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Payment Details -->
                <div class="mb-4" id="paymentDetails" style="display: none;">
                  <h5 class="text-primary mb-3">Payment Details</h5>
                  <div id="instapayDetails" class="payment-details" style="display: none;">
                    <div class="alert alert-info">
                      <h6>InstaPay Transfer Details:</h6>
                      <p><strong>Bank:</strong> National Bank of Egypt</p>
                      <p><strong>Account Name:</strong> IG Way Education</p>
                      <p><strong>Account Number:</strong> 1234567890</p>
                      <p><strong>Amount:</strong> <span id="instapayAmount"></span></p>
                    </div>
                  </div>
                  <div id="vodafoneCashDetails" class="payment-details" style="display: none;">
                    <div class="alert alert-success">
                      <h6>Vodafone Cash Details:</h6>
                      <p><strong>Phone Number:</strong> +201027500835</p>
                      <p><strong>Amount:</strong> <span id="vodafoneAmount"></span></p>
                    </div>
                  </div>
                </div>

                <!-- Payment Screenshot Upload -->
                <div class="mb-4" id="screenshotUpload" style="display: none;">
                  <h5 class="text-primary mb-3">
                    <iconify-icon icon="material-symbols:upload" class="me-2"></iconify-icon>
                    Upload Payment Screenshot
                  </h5>
                  <div class="form-group">
                    <label for="paymentScreenshot" class="form-label">Payment Screenshot *</label>
                    <input type="file" class="form-control" id="paymentScreenshot" accept="image/*" required>
                    <div class="form-text">
                      <iconify-icon icon="material-symbols:info" class="me-1"></iconify-icon>
                      Please upload a clear screenshot of your payment confirmation. This will be sent to WhatsApp for verification.
                    </div>
                    <div class="alert alert-warning mt-2">
                      <iconify-icon icon="material-symbols:warning" class="me-2"></iconify-icon>
                      <strong>Important:</strong> After submitting your order, you'll be redirected to WhatsApp where you'll need to attach this screenshot manually.
                    </div>
                  </div>
                </div>

                <div class="d-flex gap-3">
                  <button type="button" class="btn btn-secondary" onclick="window.history.back()">Back to Cart</button>
                  <button type="button" class="btn btn-success" id="submitOrderBtn" disabled>Submit Order</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <iconify-icon icon="material-symbols:shopping-cart" class="me-2 text-primary"></iconify-icon>
                <span id="orderSummaryTitle">Order Summary</span>
              </h5>
            </div>
            <div class="card-body">
              <div id="orderSummary">
                <div class="text-center text-muted py-4">
                  <iconify-icon icon="material-symbols:shopping-cart-outline" class="fs-1 mb-3"></iconify-icon>
                  <p>Loading order details...</p>
                </div>
              </div>
              
              <!-- Add More Books Button -->
              <div class="mt-3 pt-3 border-top">
                <button class="btn btn-outline-primary w-100" onclick="showEnrolledCoursesBooks()">
                  <iconify-icon icon="material-symbols:add-shopping-cart" class="me-2"></iconify-icon>
                  Add Books from My Courses
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="js/jquery-1.11.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>

  <script>
    // Global variables
    console.log('ðŸ”µ CHECKOUT PAGE: Starting cart initialization...');
    console.log('ðŸ”µ localStorage.cart:', localStorage.getItem('bookCart'));
    console.log('ðŸ”µ localStorage.enrollCourse:', localStorage.getItem('enrollCourse'));
    console.log('ðŸ”µ sessionStorage.cart:', localStorage.getItem('bookCart'));
    console.log('ðŸ”µ sessionStorage.currentCourse:', sessionStorage.getItem('currentCourse'));
    
    // ONLY USE bookCart - completely separate from course cart
    let cart = JSON.parse(localStorage.getItem('bookCart') || '[]');
    
    // DEDUPLICATE CART - Remove duplicate items by ID
    if (cart && cart.length > 0) {
      const seen = new Map();
      const deduplicated = [];
      
      cart.forEach(item => {
        if (!seen.has(item.id)) {
          seen.set(item.id, true);
          deduplicated.push(item);
          console.log('✅ Keeping item:', item.id, item.title);
        } else {
          console.warn('⚠️ Removing duplicate item:', item.id, item.title);
        }
      });
      
      if (deduplicated.length < cart.length) {
        console.log(`🔧 Removed ${cart.length - deduplicated.length} duplicate(s)`);
        cart = deduplicated;
        localStorage.setItem('bookCart', JSON.stringify(cart));
      }
    }
    
    // Check for book cart if coming from library
    const urlParams = new URLSearchParams(window.location.search);
    const cartType = urlParams.get('type');
    
    if (cartType === 'books') {
      const bookCart = JSON.parse(localStorage.getItem('bookCart') || '[]');
      if (bookCart && bookCart.length > 0) {
        cart = bookCart;
        console.log('ðŸ“š Book cart loaded:', cart);
        // Update page title and header for books
        document.title = 'Checkout - Digital Books | IG Nation';
        const orderSummaryTitle = document.getElementById('orderSummaryTitle');
        if (orderSummaryTitle) {
          orderSummaryTitle.textContent = 'Book Order Summary';
        }
      }
    }
    
    // If still empty, try enrollCourse
    if (!cart || cart.length === 0) {
      const enrollCourse = JSON.parse(localStorage.getItem('enrollCourse') || sessionStorage.getItem('currentCourse') || 'null');
      if (enrollCourse) {
        cart = [enrollCourse];
        console.log('ðŸ”µ Cart loaded from backup:', cart);
      }
    }
    
    // DEBUG: Log cart loading
    console.log('ðŸ›’ Cart loaded from localStorage:', cart);
    console.log('ðŸ›’ Cart length:', cart.length);
    console.log('ðŸ›’ Cart contents:', JSON.stringify(cart, null, 2));
    
    // Fetch course data from homenocourses.html if needed
    let homenocoursesData = null;

    // Course data
    const courses = {
      mathematics: {
        title: 'IGCSE Mathematics (Extended)',
        instructor: 'Dr. Sarah Mitchell',
        board: 'Cambridge Board',
        price: '299.00 EGP',
        originalPrice: '399.00 EGP',
        image: 'images/teacher1.PNG'
      },
      physics: {
        title: 'IGCSE Physics',
        instructor: 'Prof. Michael Chen',
        board: 'Cambridge Board',
        price: '279.00 EGP',
        originalPrice: '349.00 EGP',
        image: 'images/teacher2.PNG'
      },
      english: {
        title: 'IGCSE English Language',
        instructor: 'Dr. Emily Rodriguez',
        board: 'Cambridge Board',
        price: '249.00 EGP',
        originalPrice: '329.00 EGP',
        image: 'images/teacher3.PNG'
      },
      chemistry: {
        title: 'IGCSE Chemistry',
        instructor: 'Dr. James Wilson',
        board: 'Cambridge Board',
        price: '269.00 EGP',
        originalPrice: '339.00 EGP',
        image: 'images/teacher4.PNG'
      },
      biology: {
        title: 'IGCSE Biology',
        instructor: 'Dr. Lisa Anderson',
        board: 'Cambridge Board',
        price: '259.00 EGP',
        originalPrice: '319.00 EGP',
        image: 'images/teacher5.PNG'
      }
    };

    // Check login state and update UI
    // Determine if the user is logged in (support multiple possible keys)
    function isUserLoggedIn() {
      return !!(
        localStorage.getItem('userLoggedIn') ||
        localStorage.getItem('authToken') ||
        localStorage.getItem('userId') ||
        localStorage.getItem('userEmail')
      );
    }

    // Check login state and update UI
    function checkLoginState() {
      const isLoggedIn = isUserLoggedIn();
      const userName = localStorage.getItem('userName');

      if (isLoggedIn) {
        // Show user name in utility bar
        const userNameDisplay = document.getElementById('userNameDisplay');
        const displayUserName = document.getElementById('displayUserName');
        if (userNameDisplay && displayUserName) {
          userNameDisplay.style.display = 'block';
          displayUserName.textContent = userName || 'User';
        }

        // Hide login and register buttons
        const loginBtn = document.querySelector('.login-btn');
        const registerBtn = document.querySelector('.register-btn');

        if (loginBtn) loginBtn.style.display = 'none';
        if (registerBtn) registerBtn.style.display = 'none';

        console.log('✓ User logged in - Login and Register buttons hidden');
      } else {
        // Hide user name
        const userNameDisplay = document.getElementById('userNameDisplay');
        if (userNameDisplay) userNameDisplay.style.display = 'none';

        // Show login and register buttons
        const loginBtn = document.querySelector('.login-btn');
        const registerBtn = document.querySelector('.register-btn');

        if (loginBtn) loginBtn.style.display = 'inline-block';
        if (registerBtn) registerBtn.style.display = 'inline-block';
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('userLoggedIn');
      localStorage.removeItem('userName');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('enrolledCourses');
      window.location.href = 'index.html';
    }

    // Fetch course data function
    async function fetchCourseData() {
      try {
        const response = await fetch('/api/courses');
        if (response.ok) {
          const data = await response.json();
          homenocoursesData = data;
          console.log('Fetched course data:', homenocoursesData);
        }
      } catch (error) {
        console.error('Error fetching course data:', error);
        // Fallback to hardcoded data
        homenocoursesData = [
          {
            id: 115,
            title: 'IGCSE Mathematics (Extended)',
            instructor: 'Dr. Sarah Mitchell',
            board: 'Cambridge Board',
            price: 299.00,
            image: 'images/teacher1.PNG',
            subject: 'mathematics'
          },
          {
            id: 116,
            title: 'IGCSE Physics (Extended)',
            instructor: 'Prof. Michael Chen',
            board: 'Cambridge Board',
            price: 289.00,
            image: 'images/teacher2.PNG',
            subject: 'physics'
          },
          {
            id: 117,
            title: 'IGCSE English Language',
            instructor: 'Dr. Emily Rodriguez',
            board: 'Cambridge Board',
            price: 279.00,
            image: 'images/teacher3.PNG',
            subject: 'english'
          }
        ];
        console.log('Using fallback course data:', homenocoursesData);
      }
    }

    // Get course by ID from fetched data or fallback
    function getCourseById(courseId) {
      console.log('getCourseById called with:', courseId, 'homenocoursesData:', homenocoursesData);
      if (homenocoursesData) {
        const course = homenocoursesData.find(c => c.id == courseId);
        console.log('Found course in homenocoursesData:', course);
        if (course) {
          const result = {
            title: course.title,
            instructor: course.instructor,
            board: course.board || 'Cambridge Board',
            price: `${course.price.toFixed(2)} EGP`,
            image: course.image || 'images/teacher1.PNG'
          };
          console.log('Returning course data:', result);
          return result;
        }
      }
      console.log('No course found for ID:', courseId);
      return null;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('ðŸ”µ DOMContentLoaded event fired');
      console.log('ðŸ”µ Current URL:', window.location.href);
      console.log('ðŸ”µ URL Parameters:', new URLSearchParams(window.location.search).toString());
      console.log('ðŸ”µ Cart at DOMContentLoaded:', cart);
      console.log('ðŸ”µ Cart from localStorage:', JSON.parse(localStorage.getItem('bookCart')) || []);
      
      // CRITICAL: Check if cart is empty and try to reload it
      if (!cart || cart.length === 0) {
        console.warn('ðŸš¨ Cart is empty on page load! Attempting to reload...');
        cart = JSON.parse(localStorage.getItem('bookCart') || '[]');
        console.log('ðŸ”„ Reloaded cart:', cart);
        
        // If still empty, check for enrollCourse backup
        if (!cart || cart.length === 0) {
          const enrollCourse = JSON.parse(localStorage.getItem('enrollCourse') || 'null');
          if (enrollCourse) {
            console.log('ðŸ†˜ Found backup enrollCourse:', enrollCourse);
            cart = [enrollCourse];
            localStorage.setItem('cart', JSON.stringify(cart));
            localStorage.removeItem('enrollCourse'); // Clean up backup
            console.log('âœ… Cart restored from enrollCourse backup:', cart);
          }
        }
        
        // If STILL empty, check for URL parameter
        if (!cart || cart.length === 0) {
          const urlParams = new URLSearchParams(window.location.search);
          const courseParam = urlParams.get('course');
          if (courseParam) {
            console.log('ðŸŽ¯ Found course parameter:', courseParam);
            // Try to find course data and add to cart
            // This is a fallback for direct "Enroll Now" clicks
            const fallbackCourse = getCourseById(courseParam);
            if (fallbackCourse) {
              console.log('ðŸ†˜ Creating fallback cart item from URL:', fallbackCourse);
              cart = [{
                courseId: courseParam,
                id: courseParam,
                title: fallbackCourse.title,
                price: parseFloat(fallbackCourse.price.replace(/EGP|£/g, '').replace(/\s/g, '').trim()),
                instructor: fallbackCourse.instructor,
                board: fallbackCourse.board,
                image: fallbackCourse.image,
                quantity: 1
              }];
              localStorage.setItem('cart', JSON.stringify(cart));
              console.log('âœ… Fallback cart created from URL:', cart);
            }
          }
        }
      }
      
      // Check login state
      checkLoginState();
      
      // Fetch course data
      await fetchCourseData();
      
      console.log('Cart items:', cart);
      console.log('Homenocourses data loaded:', homenocoursesData);
      console.log('Testing getCourseById with 115:', getCourseById('115'));
      
      console.log('🔍 FINAL CART CHECK:', cart);
      console.log('🔍 CART LENGTH:', cart.length);
      console.log('🔍 localStorage.bookCart:', localStorage.getItem('bookCart'));
      
      if (cart.length === 0) {
        console.error('❌ Cart is empty! Redirecting to index.html');
        // Redirect to home if cart is empty
        // TEMPORARILY DISABLED FOR DEBUGGING
        // window.location.href = 'index.html';
        // return;
      }
      
      updateOrderSummary();
      console.log('updateOrderSummary called, checking if orderSummary element exists:', document.getElementById('orderSummary'));
      setupCheckoutEventListeners();
    });

    function updateOrderSummary() {
      const orderSummary = document.getElementById('orderSummary');
      if (!orderSummary) {
        console.error('Order summary element not found!');
        return;
      }
      
      console.log('=== UPDATE ORDER SUMMARY ===');
      console.log('Cart:', cart);
      console.log('Cart length:', cart.length);
      
      if (!cart || cart.length === 0) {
        orderSummary.innerHTML = '<div class="alert alert-warning">Your cart is empty</div>';
        return;
      }
      
      let total = 0;
      
      const summaryHTML = cart.map(item => {
        console.log('Processing cart item:', item);
        
        // Check if this is a book item
        if (item.type === 'book') {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          
          return `
            <div class="d-flex justify-content-between align-items-start mb-3 p-3 border rounded">
              <div class="d-flex align-items-center flex-grow-1">
                <div class="me-3">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <iconify-icon icon="material-symbols:menu-book" style="font-size: 1.5rem; color: white;"></iconify-icon>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-bold text-primary">${item.title}</div>
                  <div class="text-muted small">${item.author} - ${item.subject}</div>
                  <div class="text-muted small mt-1">${item.price} EGP each</div>
                  
                  <!-- Quantity Controls -->
                  <div class="d-flex align-items-center mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity('${item.id}', ${item.quantity - 1})" style="padding: 2px 8px;">
                      <iconify-icon icon="material-symbols:remove"></iconify-icon>
                    </button>
                    <span class="mx-3 fw-bold">${item.quantity}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity('${item.id}', ${item.quantity + 1})" style="padding: 2px 8px;">
                      <iconify-icon icon="material-symbols:add"></iconify-icon>
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-3" onclick="removeFromCart('${item.id}')" style="padding: 2px 8px;">
                      <iconify-icon icon="material-symbols:delete"></iconify-icon> Remove
                    </button>
                  </div>
                </div>
              </div>
              <div class="text-end ms-3">
                <div class="fw-bold">${itemTotal.toFixed(2)} EGP</div>
              </div>
            </div>
          `;
        }
        
        // Handle course items - prioritize data already in cart item
        let courseTitle = item.title || 'Unknown Course';
        let courseInstructor = item.instructor || 'Unknown Instructor';
        let courseBoard = item.board || 'Cambridge Board';
        let courseImage = item.image || 'images/teacher1.PNG';
        let coursePrice = item.price || 299.00;
        
        // If price is a string, parse it
        if (typeof coursePrice === 'string') {
          coursePrice = parseFloat(coursePrice.replace(/EGP|£|Â£/g, '').replace(',', '').trim());
        }
        
        console.log('Course data:', { courseTitle, courseInstructor, courseBoard, courseImage, coursePrice });
        
        const itemTotal = coursePrice * (item.quantity || 1);
        total += itemTotal;
        
        return `
          <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
            <div class="d-flex align-items-center">
              <img src="${courseImage}" alt="${courseTitle}" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
              <div>
                <div class="fw-bold text-primary">${courseTitle}</div>
                <div class="text-muted small">${courseInstructor} - ${courseBoard}</div>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold">${itemTotal.toFixed(2)} EGP</div>
            </div>
          </div>
        `;
      }).join('') + `
        <hr>
        <div class="d-flex justify-content-between align-items-center fw-bold fs-5">
          <span>Total</span>
          <span class="text-primary">${total.toFixed(2)} EGP</span>
        </div>
      `;
      
      console.log('Generated summaryHTML:', summaryHTML);
      console.log('Order summary element:', orderSummary);
      orderSummary.innerHTML = summaryHTML;
      
      // Update payment amounts
      document.getElementById('instapayAmount').textContent = `${total.toFixed(2)} EGP`;
      document.getElementById('vodafoneAmount').textContent = `${total.toFixed(2)} EGP`;
    }

    // Update quantity of a book in cart
    function updateQuantity(bookId, newQuantity) {
      if (newQuantity < 1) {
        removeFromCart(bookId);
        return;
      }
      
      const itemIndex = cart.findIndex(item => item.id === bookId);
      if (itemIndex !== -1) {
        cart[itemIndex].quantity = newQuantity;
        localStorage.setItem('bookCart', JSON.stringify(cart));
        updateOrderSummary();
      }
    }

    // Remove item from cart
    function removeFromCart(bookId) {
      cart = cart.filter(item => item.id !== bookId);
      localStorage.setItem('bookCart', JSON.stringify(cart));
      
      if (cart.length === 0) {
        alert('Your cart is empty. Redirecting to home...');
        window.location.href = 'index.html';
      } else {
        updateOrderSummary();
      }
    }

    // Get enrolled courses for the current user
    async function getEnrolledCourses() {
      try {
        const userEmail = localStorage.getItem('userEmail');
        const userId = localStorage.getItem('userId');
        
        console.log('🔍 Fetching enrolled courses for:', { userEmail, userId });
        
        if (!userEmail && !userId) {
          console.warn('⚠️ No user email or ID found');
          return [];
        }
        
        // Try to fetch from API
        const response = await fetch(`http://localhost:3000/api/enrollments/${userId || userEmail}`);
        console.log('📡 API Response status:', response.status);
        
        if (!response.ok) {
          console.warn('⚠️ API request failed, checking localStorage fallback');
          // Fallback to localStorage
          const enrolledCourses = localStorage.getItem('enrolledCourses');
          if (enrolledCourses) {
            const courses = JSON.parse(enrolledCourses);
            console.log('✅ Found enrolled courses in localStorage:', courses);
            return Array.isArray(courses) ? courses : [];
          }
          return [];
        }
        
        const enrollments = await response.json();
        console.log('✅ Fetched enrollments from API:', enrollments);
        
        // Extract course IDs from enrollments
        const courseIds = enrollments.map(e => e.courseId || e.course_id || e.id);
        console.log('📚 Extracted course IDs:', courseIds);
        
        return courseIds;
      } catch (error) {
        console.error('❌ Error fetching enrolled courses:', error);
        
        // Fallback to localStorage
        const enrolledCourses = localStorage.getItem('enrolledCourses');
        if (enrolledCourses) {
          const courses = JSON.parse(enrolledCourses);
          console.log('✅ Using localStorage fallback:', courses);
          return Array.isArray(courses) ? courses : [];
        }
        
        return [];
      }
    }

    // Show modal to browse books from enrolled courses
    async function showEnrolledCoursesBooks() {
      console.log('🔍 showEnrolledCoursesBooks called');
      const enrolledCourseIds = await getEnrolledCourses();
      console.log('📚 Enrolled course IDs:', enrolledCourseIds);
      
      if (enrolledCourseIds.length === 0) {
        alert('You have no enrolled courses yet. Please enroll in a course first.');
        return;
      }
      
      // Get list of book IDs already in cart
      const booksInCart = new Set(
        cart
          .filter(item => item.type === 'book')
          .map(item => item.id)
      );
      console.log('📦 Books already in cart:', Array.from(booksInCart));
      
      // Define available books for each subject
      const availableBooks = {
        'physics': {
          id: 'physics-book-1',
          title: 'IGCSE Physics Complete Guide',
          author: 'Dr. Ahmed Hassan',
          price: 150,
          subject: 'Physics'
        },
        'chemistry': {
          id: 'chemistry-book-1',
          title: 'IGCSE Chemistry Essentials',
          author: 'Prof. Sarah Ahmed',
          price: 150,
          subject: 'Chemistry'
        },
        'mathematics': {
          id: 'math-book-1',
          title: 'IGCSE Mathematics Mastery',
          author: 'Dr. Mohamed Ali',
          price: 150,
          subject: 'Mathematics'
        },
        'english': {
          id: 'english-book-1',
          title: 'IGCSE English Language & Literature',
          author: 'Ms. Fatima Ibrahim',
          price: 150,
          subject: 'English'
        },
        'biology': {
          id: 'biology-book-1',
          title: 'IGCSE Biology Comprehensive Guide',
          author: 'Dr. Layla Hassan',
          price: 150,
          subject: 'Biology'
        }
      };
      
      // Create modal HTML
      let booksHTML = '<div class="row">';
      let booksFound = false;
      let booksSkipped = 0;
      
      enrolledCourseIds.forEach(courseId => {
        console.log('🔍 Processing course ID:', courseId);
        
        // Map course IDs to subjects - improved mapping
        let subject = '';
        const courseIdStr = String(courseId).toLowerCase();
        
        // Map numeric IDs (1-10) and string IDs (115+) to subjects
        // Adjust these mappings based on your actual course IDs
        if (courseIdStr.includes('physics') || courseIdStr === '115' || courseIdStr === '116' || courseIdStr === '1') {
          subject = 'physics';
        } else if (courseIdStr.includes('chemistry') || courseIdStr === '118' || courseIdStr === '3') {
          subject = 'chemistry';
        } else if (courseIdStr.includes('math') || courseIdStr === '115' || courseIdStr === '117' || courseIdStr === '2') {
          subject = 'mathematics';
        } else if (courseIdStr.includes('english') || courseIdStr === '117' || courseIdStr === '119' || courseIdStr === '4') {
          subject = 'english';
        } else if (courseIdStr.includes('biology') || courseIdStr === '120' || courseIdStr === '5') {
          subject = 'biology';
        }
        
        console.log('📖 Mapped to subject:', subject);
        
        if (subject && availableBooks[subject]) {
          const book = availableBooks[subject];
          
          // Check if book is already in cart
          if (booksInCart.has(book.id)) {
            console.log('⏭️ Skipping book already in cart:', book.title);
            booksSkipped++;
            return; // Skip this book
          }
          
          booksFound = true;
          booksHTML += `
            <div class="col-md-6 mb-3">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-3">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                      <iconify-icon icon="material-symbols:menu-book" style="font-size: 2rem; color: white;"></iconify-icon>
                    </div>
                    <div>
                      <h6 class="mb-0">${book.title}</h6>
                      <small class="text-muted">${book.author}</small>
                    </div>
                  </div>
                  <p class="text-muted small mb-2">Subject: ${book.subject}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-primary">${book.price} EGP</span>
                    <button class="btn btn-sm btn-primary" onclick="addBookToCart('${book.id}', '${book.title}', '${book.author}', ${book.price}, '${book.subject}')">
                      <iconify-icon icon="material-symbols:add-shopping-cart"></iconify-icon> Add to Cart
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      });
      
      if (!booksFound) {
        if (booksSkipped > 0) {
          booksHTML += `
            <div class="col-12">
              <div class="alert alert-success">
                <iconify-icon icon="material-symbols:check-circle" class="me-2"></iconify-icon>
                <strong>All books already in cart!</strong>
                <p class="mb-0 mt-2">You've already added all available books for your enrolled courses to the cart.</p>
              </div>
            </div>
          `;
        } else {
          booksHTML += `
            <div class="col-12">
              <div class="alert alert-info">
                <iconify-icon icon="material-symbols:info" class="me-2"></iconify-icon>
                <strong>No books available yet</strong>
                <p class="mb-0 mt-2">Books for your enrolled courses will be available soon. Please check back later!</p>
                <p class="mb-0 mt-2 small text-muted">Enrolled courses: ${enrolledCourseIds.join(', ')}</p>
              </div>
            </div>
          `;
        }
      }
      
      booksHTML += '</div>';
      
      // Show modal
      const modalHTML = `
        <div class="modal fade" id="enrolledBooksModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                  <iconify-icon icon="material-symbols:menu-book" class="me-2"></iconify-icon>
                  Books from Your Enrolled Courses
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${booksHTML}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('enrolledBooksModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('enrolledBooksModal'));
      modal.show();
    }

    // Add book to cart from enrolled courses modal
    function addBookToCart(id, title, author, price, subject) {
      console.log('📚 Adding book to cart:', { id, title, author, price, subject });
      
      // Check if book already in cart
      const existingItem = cart.find(item => item.id === id);
      
      if (existingItem) {
        existingItem.quantity += 1;
        console.log('✅ Increased quantity for existing book:', existingItem);
      } else {
        const newBook = {
          id: id,
          title: title,
          author: author,
          price: price,
          subject: subject,
          quantity: 1,
          type: 'book',
          format: 'digital'
        };
        cart.push(newBook);
        console.log('✅ Added new book to cart:', newBook);
      }
      
      localStorage.setItem('bookCart', JSON.stringify(cart));
      console.log('💾 Cart saved to localStorage:', cart);
      
      updateOrderSummary();
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('enrolledBooksModal'));
      if (modal) modal.hide();
      
      // Show success toast
      showToast(`${title} added to cart!`, 'success');
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      
      const toastId = 'toast-' + Date.now();
      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              <iconify-icon icon="material-symbols:${type === 'success' ? 'check-circle' : type === 'error' ? 'error' : 'info'}" class="me-2"></iconify-icon>
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
      toast.show();
      
      // Remove toast element after it's hidden
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }
    
    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '9999';
      document.body.appendChild(container);
      return container;
    }

    function setupCheckoutEventListeners() {
      // Payment method change
      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updatePaymentDetails();
        });
      });

      // Submit order button
      document.getElementById('submitOrderBtn').addEventListener('click', function() {
        console.log('Submit button clicked');
        submitOrder();
      });
    }

    function updatePaymentDetails() {
      const paymentDetails = document.getElementById('paymentDetails');
      const screenshotUpload = document.getElementById('screenshotUpload');
      const instapayDetails = document.getElementById('instapayDetails');
      const vodafoneCashDetails = document.getElementById('vodafoneCashDetails');
      const submitOrderBtn = document.getElementById('submitOrderBtn');
      
      const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
      
      if (selectedPayment) {
        paymentDetails.style.display = 'block';
        screenshotUpload.style.display = 'block';
        submitOrderBtn.disabled = false;
        
        if (selectedPayment.value === 'instapay') {
          instapayDetails.style.display = 'block';
          vodafoneCashDetails.style.display = 'none';
        } else if (selectedPayment.value === 'vodafoneCash') {
          instapayDetails.style.display = 'none';
          vodafoneCashDetails.style.display = 'block';
        }
      } else {
        paymentDetails.style.display = 'none';
        screenshotUpload.style.display = 'none';
        submitOrderBtn.disabled = true;
      }
    }

    async function submitOrder() {
      console.log('ðŸŸ¡ ============ SUBMIT ORDER CALLED ============');
      
      // CRITICAL: ALWAYS reload cart from ALL sources at the VERY START
      console.log('ðŸŸ¡ Step 1: Checking all storage sources...');
      console.log('   - cart variable:', cart);
      console.log('   - localStorage.cart:', localStorage.getItem('bookCart'));
      console.log('   - localStorage.enrollCourse:', localStorage.getItem('enrollCourse'));
      console.log('   - sessionStorage.cart:', localStorage.getItem('bookCart'));
      console.log('   - sessionStorage.currentCourse:', sessionStorage.getItem('currentCourse'));
      
      // FORCE reload from ALL sources - ALWAYS check enrollCourse FIRST since it's most reliable
      let recoveredCart = null;
      
      // Priority 1: enrollCourse (most reliable)
      const enrollCourse = JSON.parse(localStorage.getItem('enrollCourse') || 'null');
      if (enrollCourse) {
        recoveredCart = [enrollCourse];
        console.log('ðŸŸ¡ Using enrollCourse (Priority 1):', recoveredCart);
      }
      
      // Priority 2: sessionStorage.currentCourse
      if (!recoveredCart || recoveredCart.length === 0) {
        const currentCourse = JSON.parse(sessionStorage.getItem('currentCourse') || 'null');
        if (currentCourse) {
          recoveredCart = [currentCourse];
          console.log('ðŸŸ¡ Using sessionStorage.currentCourse (Priority 2):', recoveredCart);
        }
      }
      
      // Priority 3: localStorage.cart
      if (!recoveredCart || recoveredCart.length === 0) {
        recoveredCart = JSON.parse(localStorage.getItem('bookCart') || 'null');
        if (recoveredCart && recoveredCart.length > 0) {
          console.log('ðŸŸ¡ Using localStorage.cart (Priority 3):', recoveredCart);
        }
      }
      
      // Priority 4: sessionStorage.cart
      if (!recoveredCart || recoveredCart.length === 0) {
        recoveredCart = JSON.parse(localStorage.getItem('bookCart') || 'null');
        if (recoveredCart && recoveredCart.length > 0) {
          console.log('ðŸŸ¡ Using sessionStorage.cart (Priority 4):', recoveredCart);
        }
      }
      
      // Override cart variable with recovered data
      if (recoveredCart && recoveredCart.length > 0) {
        cart = recoveredCart;
        console.log('ðŸŸ¡ âœ… Cart recovered from storage:', cart);
      } else {
        console.error('ðŸŸ¡ âŒ NO CART DATA FOUND IN ANY SOURCE!');
        // ABSOLUTE LAST RESORT
        const urlParams = new URLSearchParams(window.location.search);
        const courseParam = urlParams.get('course');
        if (courseParam) {
          console.log('ðŸŸ¡ Attempting URL parameter recovery...');
          await fetchCourseData();
          const course = getCourseById(courseParam);
          if (course) {
            cart = [{
              courseId: courseParam,
              id: courseParam,
              title: course.title,
              price: parseFloat(course.price.replace(/EGP|£/g, '').replace(/\s/g, '').trim()),
              instructor: course.instructor,
              board: course.board,
              image: course.image,
              quantity: 1
            }];
            console.log('ðŸŸ¡ Cart created from URL:', cart);
          }
        }
        
        // FINAL FALLBACK
        if (!cart || cart.length === 0) {
          console.error('ðŸŸ¡ USING HARDCODED FALLBACK!');
          cart = [{
            courseId: 1,
            id: 1,
            title: 'Mathematics IGCSE',
            price: 299.00,
            instructor: 'Dr. Smith',
            board: 'Cambridge Board',
            image: 'images/teacher1.PNG',
            quantity: 1
          }];
        }
      }
      
      console.log('ðŸŸ¡ Final cart before processing:', cart);
      console.log('ðŸŸ¡ Final cart length:', cart.length);
      
      const form = document.getElementById('checkoutForm');
      
      // Validate form
      if (!form.checkValidity()) {
        console.log('Form validation failed');
        form.reportValidity();
        return;
      }
      
      console.log('Form validation passed');
      
      // Get payment screenshot
      const screenshot = document.getElementById('paymentScreenshot').files[0];
      if (!screenshot) {
        showToast('Please upload a payment screenshot', 'warning');
        return;
      }
      
      // Get form data
      const firstName = document.getElementById('checkoutFirstName').value;
      const lastName = document.getElementById('checkoutLastName').value;
      const email = document.getElementById('checkoutEmail').value;
      const phone = document.getElementById('checkoutPhone').value;
      
      // CRITICAL: ALWAYS force reload cart from enrollCourse - don't trust the cart variable
      console.log('ðŸ”µ ===== EMERGENCY CART RELOAD =====');
      console.log('ðŸ”µ Cart value:', cart);
      console.log('ðŸ”µ Cart type:', typeof cart);
      console.log('ðŸ”µ Cart length:', cart ? cart.length : 'N/A');
      console.log('ðŸ”µ Cart is array?:', Array.isArray(cart));
      
      // ALWAYS reload from enrollCourse to be 100% sure
      const enrollCourseBackup = localStorage.getItem('enrollCourse');
      console.log('ðŸ”µ Raw enrollCourse from localStorage:', enrollCourseBackup);
      
      if (enrollCourseBackup) {
        const parsed = JSON.parse(enrollCourseBackup);
        cart = [parsed];
        console.log('ðŸ”µ âœ… FORCED cart from enrollCourse:', cart);
        console.log('ðŸ”µ âœ… Cart[0]:', cart[0]);
      } else {
        console.error('ðŸ”µ âŒ No enrollCourse in localStorage!');
      }
      
      console.log('ðŸ”µ Final cart before order items:', cart);
      console.log('ðŸ”µ =================================');
      
      // Get order summary
      const orderItems = cart.map(item => {
        let course;
        if (item.title) {
          course = {
            title: item.title,
            price: item.price ? `${item.price.toFixed(2)} EGP` : '299.00 EGP'
          };
        } else {
          course = getCourseById(item.courseId) || courses[item.courseId];
        }
        return `${course.title} - ${course.price}`;
      }).join('\n');
      
      const total = cart.reduce((sum, item) => {
        let course;
        if (item.title) {
          course = {
            price: item.price ? `${item.price.toFixed(2)} EGP` : '299.00 EGP'
          };
        } else {
          course = getCourseById(item.courseId) || courses[item.courseId];
        }
        return sum + parseFloat(course.price.replace(/EGP|£/g, '').replace(/\s/g, '').trim());
      }, 0);
      
      // Get payment method
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
      const paymentType = paymentMethod ? paymentMethod.value : 'unknown';
      
      try {
        console.log('ðŸ“‹ Preparing order from cart:', cart);
        console.log('ðŸ“‹ Cart length:', cart.length);
        console.log('ðŸ“‹ Cart JSON:', JSON.stringify(cart));
        
        // ABSOLUTE FINAL CHECK: If cart is STILL empty here, FORCE load from enrollCourse
        if (!cart || cart.length === 0) {
          console.error('ðŸš¨ CRITICAL: Cart is empty at mapping stage! Force loading from enrollCourse...');
          const forceEnrollCourse = JSON.parse(localStorage.getItem('enrollCourse') || 'null');
          if (forceEnrollCourse) {
            cart = [forceEnrollCourse];
            console.log('ðŸš¨ FORCED cart from enrollCourse:', cart);
          } else {
            console.error('ðŸš¨ FINAL ERROR: No enrollCourse found either!');
            showToast('CRITICAL ERROR: No course data found. Please try again.', 'error');
            return;
          }
        }
        
        console.log('ðŸ“‹ Cart items:', cart.map(item => ({ courseId: item.courseId, title: item.title, quantity: item.quantity })));
        
        // SIMPLE APPROACH: Use cart data directly without complex mapping
        const coursesForOrder = cart.map((item, index) => {
          console.log(`ðŸ” Processing cart item ${index + 1}:`, item);
          console.log(`   - item.title: "${item.title}"`);
          console.log(`   - item.courseId: ${item.courseId}`);
          console.log(`   - item.id: ${item.id}`);
          console.log(`   - All item keys:`, Object.keys(item));
          
          // Use cart item data directly - no complex mapping
          const courseData = {
            id: item.courseId || item.id || index + 1,
            courseId: item.courseId || item.id || index + 1,
            title: item.title || item.name || item.courseName || 'Unknown Course',
            instructor: item.instructor || 'Expert Instructor',
            board: item.board || 'Cambridge Board',
            price: item.price || 299.00,
            image: item.image || 'images/teacher1.PNG',
            quantity: item.quantity || 1
          };
          
          console.log('âœ… Simple course data created:', courseData);
          console.log('   - Final title:', courseData.title);
          return courseData;
        });
        
        console.log('ðŸ“¦ Courses prepared for order:', coursesForOrder);
        console.log('ðŸ“¦ Courses count:', coursesForOrder.length);
        console.log('ðŸ“¦ Courses details:', coursesForOrder.map(c => ({ id: c.id, title: c.title, price: c.price })));
        
        // CRITICAL VALIDATION: Ensure courses are not empty
        if (!coursesForOrder || coursesForOrder.length === 0) {
          console.error('âŒ CRITICAL: coursesForOrder is empty!');
          console.error('âŒ cart variable:', cart);
          console.error('âŒ cart length:', cart ? cart.length : 'undefined');
          console.error('âŒ cart JSON:', JSON.stringify(cart));
          alert('CRITICAL ERROR: Cart is empty! Check console for details.');
          return;
        }
        
        // Use coursesForOrder directly - no filtering needed since we create valid data
        const validCourses = coursesForOrder;
        console.log('âœ… Using courses directly:', validCourses.length);
        console.log('âœ… validCourses:', validCourses);
        console.log('âœ… validCourses[0]:', validCourses[0]);
        
        // FINAL SAFETY CHECK before creating orderData
        if (!validCourses || validCourses.length === 0 || !validCourses[0] || !validCourses[0].title) {
          console.error('âŒ CRITICAL: validCourses is invalid!');
          console.error('âŒ validCourses:', validCourses);
          alert('CRITICAL ERROR: Course data is invalid! Check console.');
          return;
        }
        
        // ABSOLUTE FINAL CHECK: Ensure validCourses is not empty before saving
        if (!validCourses || validCourses.length === 0 || !validCourses[0]?.title) {
          console.error('âŒâŒâŒ CRITICAL: validCourses is invalid! Using enrollCourse as absolute fallback');
          const absoluteFallback = JSON.parse(localStorage.getItem('enrollCourse') || 'null');
          if (absoluteFallback) {
            validCourses = [absoluteFallback];
            console.log('âœ… Used enrollCourse fallback:', validCourses);
          }
        }
        
        // Create order in database
        const orderData = {
          customer_name: `${firstName} ${lastName}`,
          customer_email: email,
          customer_phone: phone,
          courses: JSON.stringify(validCourses),
          total_amount: total,
          payment_method: paymentType,
          payment_screenshot: screenshot.name
        };
        
        console.log('ðŸ’¾ðŸ’¾ðŸ’¾ FINAL orderData.courses:', orderData.courses);
        console.log('ðŸ’¾ðŸ’¾ðŸ’¾ FINAL parsed courses:', JSON.parse(orderData.courses));
        
        console.log('ðŸ’¾ Saving order to database:', orderData);
        console.log('   Courses JSON:', orderData.courses);
        console.log('   Courses parsed:', JSON.parse(orderData.courses));
        console.log('   Total amount:', orderData.total_amount);
        console.log('   Valid courses count:', validCourses.length);
        console.log('   Valid courses:', validCourses);
        
        // FINAL SAFETY CHECK: Ensure courses array is not empty
        const parsedCourses = JSON.parse(orderData.courses);
        if (!parsedCourses || parsedCourses.length === 0) {
          console.error('âŒ CRITICAL: Courses array is empty before saving!');
          showToast('Error: Course data is missing. Please try again.', 'error');
          return;
        }
        
        const orderResponse = await fetch('/api/orders', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify(orderData)
        });
        
        if (orderResponse.ok) {
          const orderResult = await orderResponse.json();
          console.log('Order saved to database successfully:', orderResult);
          console.log('âœ… Order ID:', orderResult.orderId);
          console.log('âœ… Courses in order:', validCourses);
          
          // Save complete order details to localStorage
          const orderDetails = {
            id: orderResult.orderId,
            created_at: new Date().toISOString(),
            courses: validCourses,
            total_amount: total,
            customer_name: `${firstName} ${lastName}`,
            customer_email: email
          };
          
          localStorage.setItem('lastOrder', JSON.stringify(orderDetails));
          console.log('âœ… Saved to lastOrder:', orderDetails);
          
          // Save purchased cart for display on order processing page
          localStorage.setItem('lastPurchasedCart', JSON.stringify(validCourses));
          console.log('âœ… Saved to lastPurchasedCart:', validCourses);
          
          showToast('Order created successfully! Redirecting to WhatsApp...', 'success');
          
          // Create WhatsApp message with order details
          const whatsappMessage = `
ðŸŽ“ *New Order from IG Nation*

*Customer Details:*
Name: ${firstName} ${lastName}
Email: ${email}
Phone: ${phone}

*Order Details:*
${orderItems}

*Total Amount:* ${total.toFixed(2)} EGP
*Payment Method:* ${paymentType === 'instapay' ? 'Instapay' : 'Vodafone Cash'}
*Order ID:* ${orderResult.orderId}

âœ… Payment screenshot will be attached separately`;
          
          // Clear cart
          cart = [];
          localStorage.setItem('cart', JSON.stringify(cart));
          
          // Redirect to WhatsApp with instructions to upload screenshot
          redirectToWhatsApp(whatsappMessage, screenshot);
          
          return;
        } else {
          const errorData = await orderResponse.json();
          console.error('Failed to save order:', errorData);
          showToast('Failed to create order. Please try again.', 'error');
          return;
        }
        
      } catch (error) {
        console.error('Error creating order:', error);
        showToast('Error creating order. Please try again.', 'error');
        return;
      }
    }

    // testRedirect function removed - no longer needed

    function redirectToWhatsApp(message, screenshot) {
      const phoneNumber = '201027500835'; // Remove + for WhatsApp URL
      const encodedMessage = encodeURIComponent(message);
      
      // Store screenshot in localStorage as data URL for user reference
      if (screenshot) {
        const reader = new FileReader();
        reader.onload = function(e) {
          localStorage.setItem('paymentScreenshot', e.target.result);
          localStorage.setItem('paymentScreenshotName', screenshot.name);
        };
        reader.readAsDataURL(screenshot);
      }
      
      // Create WhatsApp URL
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      // Show enhanced instructions modal with screenshot preview
      showWhatsAppInstructions(screenshot, whatsappUrl);
    }

    function showWhatsAppInstructions(screenshot, whatsappUrl) {
      // Create screenshot preview
      let screenshotPreview = '';
      if (screenshot) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('screenshotPreviewImg').src = e.target.result;
        };
        reader.readAsDataURL(screenshot);
        
        screenshotPreview = `
          <div class="card mt-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <iconify-icon icon="material-symbols:image" class="me-2"></iconify-icon>
                Your Payment Screenshot
              </h6>
            </div>
            <div class="card-body text-center">
              <img id="screenshotPreviewImg" src="" alt="Payment Screenshot" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;">
              <p class="mt-2 text-muted small">
                <iconify-icon icon="material-symbols:info"></iconify-icon>
                Please attach this screenshot when you open WhatsApp
              </p>
              <button class="btn btn-sm btn-outline-primary" onclick="downloadScreenshot()">
                <iconify-icon icon="material-symbols:download"></iconify-icon>
                Download Screenshot
              </button>
            </div>
          </div>
        `;
      }
      
      // Create modal for instructions
      const modalHtml = `
        <div class="modal fade" id="whatsappInstructionsModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                  <iconify-icon icon="logos:whatsapp-icon" class="me-2"></iconify-icon>
                  Complete Your Order via WhatsApp
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-success">
                  <h6><iconify-icon icon="material-symbols:check-circle" class="me-2"></iconify-icon>Order Submitted Successfully!</h6>
                  <p class="mb-0">Now let's send your payment proof to our team.</p>
                </div>
                
                <div class="alert alert-info">
                  <h6><iconify-icon icon="material-symbols:info" class="me-2"></iconify-icon>Next Steps:</h6>
                  <ol class="mb-0">
                    <li>Click the <strong>"Open WhatsApp"</strong> button below</li>
                    <li>Your order details will be pre-filled in the message</li>
                    <li><strong>Click the attachment icon (ðŸ“Ž) in WhatsApp</strong></li>
                    <li><strong>Attach your payment screenshot</strong> from your device</li>
                    <li>Send the message to complete your order</li>
                  </ol>
                </div>
                
                ${screenshotPreview}
                
                <div class="text-center mt-4">
                  <p class="mb-3">
                    <iconify-icon icon="logos:whatsapp-icon" style="font-size: 24px;"></iconify-icon>
                    <br>
                    <strong>WhatsApp Number:</strong> +201027500835
                  </p>
                  <button class="btn btn-success btn-lg" onclick="window.open('${whatsappUrl}', '_blank')">
                    <iconify-icon icon="logos:whatsapp-icon" class="me-2"></iconify-icon>
                    Open WhatsApp Now
                  </button>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="window.location.href='index.html'">
                  Close & Go Home
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('whatsappInstructionsModal'));
      modal.show();
      
      // Cleanup when modal is closed
      document.getElementById('whatsappInstructionsModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
      });
    }
    
    function downloadScreenshot() {
      const screenshotData = localStorage.getItem('paymentScreenshot');
      const screenshotName = localStorage.getItem('paymentScreenshotName') || 'payment-screenshot.png';
      
      if (screenshotData) {
        const link = document.createElement('a');
        link.href = screenshotData;
        link.download = screenshotName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Screenshot downloaded!', 'success');
      }
    }

    function openWhatsAppDirectly() {
      const phoneNumber = '201027500835'; // Remove + for WhatsApp URL
      const message = `ðŸŽ“ *IG Way IGCSE Tutoring - Course Purchase Confirmation*

ðŸ‘¤ *Student Details:*
â€¢ Name: ${document.getElementById('checkoutFirstName').value} ${document.getElementById('checkoutLastName').value}
â€¢ Email: ${document.getElementById('checkoutEmail').value}
â€¢ Phone: ${document.getElementById('checkoutPhone').value}

ðŸ“š *Courses Purchased:*
${cart.map(item => {
  const course = courses[item.courseId];
  return `${course.title} - ${course.price}`;
}).join('\n')}

ðŸ’° *Total Amount: ${cart.reduce((sum, item) => {
  const course = courses[item.courseId];
  return sum + parseFloat(course.price.replace(/EGP|£/g, '').replace(/\s/g, '').trim());
}, 0).toFixed(2)} EGP*

ðŸ“¸ *Payment Screenshot Attached*

Please verify the payment and activate my courses. Thank you!`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      let icon = 'material-symbols:info';
      let title = 'Notification';
      let bgClass = 'bg-primary';
      
      if (type === 'warning') {
        icon = 'material-symbols:warning';
        title = 'Warning!';
        bgClass = 'bg-warning';
      } else if (type === 'success') {
        icon = 'material-symbols:check-circle';
        title = 'Success!';
        bgClass = 'bg-success';
      }
      
      const toastHTML = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header ${bgClass} text-white">
            <iconify-icon icon="${icon}" class="me-2"></iconify-icon>
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000
      });
      
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    }
  </script>
</body>
</html>



