<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemistry Teacher Dashboard - Professional Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Header */
        .teacher-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .header-title p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-assistant-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
        }

        .header-assistant-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-assistant-btn:active {
            transform: translateY(0);
        }

        .notification-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-section:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .profile-info h6 {
            margin: 0;
            font-weight: 600;
        }

        .profile-info small {
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success-color), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning-color), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger-color), #dc2626); }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
        }

        .stat-content p {
            color: var(--text-secondary);
            margin: 0.25rem 0 0 0;
            font-size: 0.9rem;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title iconify-icon {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .action-btn.success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .action-btn.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }


        /* File Upload Section Styles */
        .file-upload-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .file-upload-info h6 {
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .file-upload-info ul li {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #64748b;
        }

        .file-upload-info ul li iconify-icon {
            margin-right: 0.5rem;
        }

        .action-btn iconify-icon {
            font-size: 2rem;
        }

        .action-btn h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }

        .action-btn p {
            margin: 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Daily Practice Questions Styles */
        .questions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .questions-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
            width: 100%;
        }

        /* Ensure questions display modal appears above daily practice modal */
        #questionsDisplayModal {
            z-index: 1060 !important;
        }
        
        #questionsDisplayModal .modal-backdrop {
            z-index: 1059 !important;
        }

        .question-creator.compact {
            padding: 0;
            background: transparent;
        }
        .question-creator.compact .form-label {
            font-size: 0.8rem;
            font-weight: 600;
        }
        .question-creator.compact .form-control-sm {
            max-width: 120px;
        }
        
        .question-types-compact {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .question-type-compact {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        .question-type-compact.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .question-type-compact:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Weekly Schedule Styles */
        .weekly-schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .day-schedule {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .day-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .session-slot {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .session-slot:last-child {
            margin-bottom: 0;
        }
        
        .question-item {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            padding: 1.5rem;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .question-item:last-child {
            margin-bottom: 0;
        }
        
        .question-item .form-control {
            width: 100%;
        }
        
        .question-item .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: white;
            transition: all 0.3s ease;
        }

        .question-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .question-content {
            flex: 1;
            margin-right: 1rem;
        }

        .question-content h6 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .question-content p {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .question-meta {
            display: flex;
            gap: 0.5rem;
        }

        .question-actions {
            display: flex;
            gap: 0.5rem;
        }

        .stat-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        /* Tabs */
        .content-tabs {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            background: var(--light-color);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
        }

        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Assessment Cards */
        .assessments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .assessment-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .assessment-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .assessment-type {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .assessment-type.quiz { background: var(--success-color); }
        .assessment-type.exam { background: var(--warning-color); }

        .assessment-menu {
            position: relative;
        }

        .menu-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            background: var(--light-color);
            color: var(--text-primary);
        }

        .assessment-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .assessment-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .assessment-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .assessment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Grading Table */
        .grading-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: var(--light-color);
            border: none;
            padding: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table tbody td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .student-details h6 {
            margin: 0;
            font-weight: 600;
            color: var(--text-primary);
        }

        .student-details small {
            color: var(--text-secondary);
        }

        .grade-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-graded {
            background: #d1fae5;
            color: #065f46;
        }

        .status-late {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Grading Tabs */
        .grading-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .grading-tab-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .grading-tab-btn:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .grading-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .grading-tab-btn .badge {
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        .grading-tab-btn.active .badge {
            background: var(--primary-color);
        }

        /* Grade Conversion */
        .grade-conversion {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .grade-letter {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            min-width: 40px;
            text-align: center;
        }

        .grade-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Submission Cards */
        .submission-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .submission-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .submission-info h5 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .submission-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .submission-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .submission-actions {
            display: flex;
            gap: 0.5rem;
        }

        .submission-details {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        /* Question Grading */
        .question-grading {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .question-header h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .question-text {
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .student-answer {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .answer-content {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }

        .grading-section {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .grading-summary {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            position: sticky;
            top: 2rem;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 700;
            margin: 0;
        }

        .btn-close {
            filter: invert(1);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-control {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Question Creator */
        .question-creator {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .question-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .question-type-btn {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-type-btn:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .question-type-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .question-type-btn iconify-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .question-type-btn h6 {
            margin: 0;
            font-weight: 600;
        }

        .question-type-btn p {
            margin: 0.25rem 0 0 0;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                flex-direction: column;
            }

            .assessments-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            min-width: 300px;
        }

        .toast-header {
            background: var(--light-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 8px 8px 0 0;
        }

        .toast-body {
            padding: 1rem;
        }

        .toast.success .toast-header {
            background: #d1fae5;
            color: #065f46;
        }

        .toast.error .toast-header {
            background: #fee2e2;
            color: #991b1b;
        }

        .toast.warning .toast-header {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="teacher-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <iconify-icon icon="material-symbols:science-outline"></iconify-icon>
                </div>
                <div class="header-title">
                    <h1>Chemistry Teacher Dashboard</h1>
                    <p id="teacherWelcome">Professional Assessment & Grading System</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-assistant-btn" onclick="showCourseAssistants()">
                    <iconify-icon icon="material-symbols:people" style="font-size: 1.2rem;"></iconify-icon>
                    <span>Course Assistants</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon danger">
                    <iconify-icon icon="material-symbols:grading"></iconify-icon>
                    </div>
                    <div class="stat-trend trend-up">
                        <iconify-icon icon="material-symbols:trending-up"></iconify-icon>
                        +15%
                    </div>
                </div>
                <div class="stat-content">
                    <h3 id="pendingGrading">8</h3>
                    <p>Pending Grading</p>
                </div>
            </div>
        </div>


        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2 class="section-title">
                <iconify-icon icon="material-symbols:flash-on"></iconify-icon>
                Quick Actions
            </h2>
            <div class="actions-grid">
                <button class="action-btn danger" onclick="openGradingPanel()">
                    <iconify-icon icon="material-symbols:grading"></iconify-icon>
                    <h6>Grade Submissions</h6>
                    <p>Review & grade work</p>
                </button>
                <button class="action-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="openPushLecturesModal()">
                    <iconify-icon icon="material-symbols:upload"></iconify-icon>
                    <h6>Push Lectures</h6>
                    <p>Upload to lecture page</p>
                </button>
                <button class="action-btn primary" onclick="openPracticeQuestionModal()">
                    <iconify-icon icon="material-symbols:edit-note"></iconify-icon>
                    <h6>Practice Questions</h6>
                    <p>Create today's questions</p>
                </button>
                <button class="action-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;" onclick="openFlashcardsModal()">
                    <iconify-icon icon="material-symbols:style"></iconify-icon>
                    <h6>Flashcards</h6>
                    <p>Create study cards</p>
                </button>
                <button class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" onclick="openChatChoiceModal()">
                    <iconify-icon icon="material-symbols:forum"></iconify-icon>
                    <h6>Community Chat</h6>
                    <p>Join subject discussion</p>
                </button>
                <button class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;" onclick="navigateToPastPapers()">
                    <iconify-icon icon="material-symbols:description"></iconify-icon>
                    <h6>Past Papers</h6>
                    <p>View exam papers</p>
                </button>
            </div>
        </div>



        <!-- Main Content Tabs -->
        <div class="content-tabs">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('grading')">
                    <iconify-icon icon="material-symbols:grading"></iconify-icon>
                    Grading Center
                </button>
                <button class="tab-btn" onclick="switchTab('analytics')">
                    <iconify-icon icon="material-symbols:analytics"></iconify-icon>
                    Analytics
                </button>
                <button class="tab-btn" onclick="switchTab('students')">
                    <iconify-icon icon="material-symbols:groups"></iconify-icon>
                    Students
                </button>
                <button class="tab-btn" onclick="switchTab('schedule')">
                    <iconify-icon icon="material-symbols:schedule"></iconify-icon>
                    Session Schedule
                            </button>
                </div>

            <div class="tab-content">
                <!-- Grading Tab -->
                <div id="grading" class="tab-pane active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Grading Center</h3>
                        <div class="d-flex gap-2">
                            <select class="form-control" style="width: auto;" onchange="filterGrading(this.value)">
                                <option value="all">All Submissions</option>
                                <option value="pending">Pending</option>
                                <option value="graded">Graded</option>
                                <option value="late">Late</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Grading Tabs -->
                    <div class="grading-tabs mb-4">
                        <button class="grading-tab-btn active" onclick="switchGradingTab('assignments')">
                            <iconify-icon icon="material-symbols:assignment"></iconify-icon>
                            Assignments
                            <span class="badge" id="assignmentGradingCount">0</span>
                        </button>
                        <button class="grading-tab-btn" onclick="switchGradingTab('quizzes')">
                            <iconify-icon icon="material-symbols:quiz"></iconify-icon>
                            Quizzes
                            <span class="badge" id="quizGradingCount">0</span>
                        </button>
                        <button class="grading-tab-btn" onclick="switchGradingTab('exams')">
                            <iconify-icon icon="material-symbols:school"></iconify-icon>
                            Exams
                            <span class="badge" id="examGradingCount">0</span>
                        </button>
                    </div>
                    
                    <!-- Grading Content -->
                    <div id="gradingContainer">
                        <!-- Grading content will be loaded here -->
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div id="analytics" class="tab-pane">
                    <h3>Analytics & Reports</h3>
                    <div class="loading">
                        <div class="spinner"></div>
                        Analytics dashboard coming soon...
                    </div>
                </div>

                <!-- Students Tab -->
                <div id="students" class="tab-pane">
                    <h3>Student Management</h3>
                    <div class="loading">
                        <div class="spinner"></div>
                        Student management coming soon...
                    </div>
                </div>

                <!-- Session Schedule Tab -->
                <div id="schedule" class="tab-pane">
                    <div class="section-header">
                        <h3>
                            <iconify-icon icon="material-symbols:schedule"></iconify-icon>
                            Session Schedule Management
                        </h3>
                        <p>Set up and manage your class session schedules</p>
            </div>

                    <!-- Add New Session Button -->
                    <div class="mb-4">
                        <button class="btn btn-primary me-2" onclick="openSessionScheduleModal()">
                            <iconify-icon icon="material-symbols:add"></iconify-icon>
                            Add New Session
                        </button>
                        <button class="btn btn-outline-primary" onclick="openWeeklyScheduleModal()">
                            <iconify-icon icon="material-symbols:calendar-month"></iconify-icon>
                            Set Weekly Schedule
                        </button>
        </div>

                    <!-- Schedule Overview -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-primary" id="totalSessions">0</h5>
                                    <p class="card-text">Total Sessions</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success" id="upcomingSessions">0</h5>
                                    <p class="card-text">Upcoming</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-warning" id="todaySessions">0</h5>
                                    <p class="card-text">Today</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-info" id="weeklySessions">0</h5>
                                    <p class="card-text">This Week</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Overview (auto-filled after saving weekly schedule) -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Weekly Overview</h5>
                                <small id="weeklyOverviewRange" class="text-muted"></small>
                            </div>
                            <div class="row" id="weeklyOverview"></div>
                        </div>
                    </div>

                    <!-- Sessions List -->
                    <div class="sessions-list" id="sessionsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading sessions...
                        </div>
                    </div>
                </div>
            </div>

    <!-- Create Assessment Modal -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalTitle">Create Assessment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Assessment Title</label>
                                    <input type="text" class="form-control" id="assessmentTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="assessmentDescription" rows="3"></textarea>
                                </div>

                                <!-- File Upload Section (Hidden by default) -->
                                <div id="fileUploadSection" class="mb-4" style="display: none;">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <iconify-icon icon="material-symbols:upload-file" class="me-2"></iconify-icon>
                                                File-Based Assessment Setup
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <div class="mb-3">
                                                        <label class="form-label">Question File</label>
                                                        <input type="file" class="form-control" id="questionFile" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(this)">
                                                        <div class="form-text">Upload your question file (PDF, Word, or Text format)</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Answer Template (Optional)</label>
                                                        <input type="file" class="form-control" id="answerTemplate" accept=".pdf,.doc,.docx,.txt">
                                                        <div class="form-text">Provide a template for students to fill out</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="file-upload-info">
                                                        <h6>File Requirements:</h6>
                                                        <ul class="list-unstyled">
                                                            <li><iconify-icon icon="material-symbols:check-circle" style="color: #10b981;"></iconify-icon> PDF, Word, or Text files</li>
                                                            <li><iconify-icon icon="material-symbols:check-circle" style="color: #10b981;"></iconify-icon> Max size: 10MB</li>
                                                            <li><iconify-icon icon="material-symbols:check-circle" style="color: #10b981;"></iconify-icon> Clear question numbering</li>
                                                            <li><iconify-icon icon="material-symbols:check-circle" style="color: #10b981;"></iconify-icon> Include point values</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Total Points</label>
                                            <input type="number" class="form-control" id="totalPoints" min="1" value="100">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Time Limit (minutes)</label>
                                            <input type="number" class="form-control" id="timeLimit" placeholder="Optional" min="1" max="180" onchange="updateCountdownDisplay()">
                                            <small class="form-text text-muted">Leave empty for no time limit. Max 180 minutes (3 hours).</small>
                                            <div id="countdownDisplay" class="mt-2" style="display: none;">
                                                <div class="alert alert-info d-flex align-items-center">
                                                    <iconify-icon icon="material-symbols:timer" class="me-2"></iconify-icon>
                                                    <div>
                                                        <strong id="durationLabel">Duration:</strong>
                                                        <span id="countdownText">0 minutes</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3" id="numberOfQuestionsSection">
                                            <label class="form-label">Number of Questions</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="numberOfQuestions" min="1" max="50" value="5" placeholder="Auto-generate questions">
                                                <div class="input-group-text">
                                                    <input type="checkbox" class="form-check-input" id="autoGenerateQuestions" checked>
                                                    <label class="form-check-label ms-2" for="autoGenerateQuestions">Auto-generate</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Due Date</label>
                                            <input type="datetime-local" class="form-control" id="dueDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Difficulty</label>
                                            <select class="form-control" id="difficulty">
                                                <option value="easy">Easy</option>
                                                <option value="medium" selected>Medium</option>
                                                <option value="hard">Hard</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="question-creator">
                                    <h6 class="mb-3">Question Types</h6>
                                    <div class="question-types">
                                        <div class="question-type-btn active" data-type="multiple-select" onclick="selectQuestionType('multiple-select')">
                                            <iconify-icon icon="material-symbols:check-box"></iconify-icon>
                                            <h6>Multiple Select</h6>
                                            <p>Multiple answers</p>
                                        </div>
                                        <div class="question-type-btn" data-type="short-answer" onclick="selectQuestionType('short-answer')">
                                            <iconify-icon icon="material-symbols:short-text"></iconify-icon>
                                            <h6>Short Answer</h6>
                                            <p>Text response</p>
                                        </div>
                                        <div class="question-type-btn" data-type="file-based" onclick="selectQuestionType('file-based')">
                                            <iconify-icon icon="material-symbols:upload-file"></iconify-icon>
                                            <h6>File-Based Assessment</h6>
                                            <p>File upload</p>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary flex-fill" onclick="addQuestion()">
                                        <iconify-icon icon="material-symbols:add"></iconify-icon>
                                        Add Question
                                    </button>
                                        <button type="button" class="btn btn-success flex-fill" onclick="generateQuestions()">
                                            <iconify-icon icon="material-symbols:auto-awesome"></iconify-icon>
                                            Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="questionsContainer" class="mt-4">
                            <!-- Questions will be added here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAssessment()">
                        <iconify-icon icon="material-symbols:save"></iconify-icon>
                        Save Draft
                    </button>
                    <button type="button" class="btn btn-success" id="publishBtn">
                        <iconify-icon icon="material-symbols:publish"></iconify-icon>
                        Publish to Course
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Grading Modal -->
    <div class="modal fade" id="gradingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gradingModalTitle">Grade Submission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="gradingModalBody">
                    <!-- Grading content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="saveGrade()">
                        <iconify-icon icon="material-symbols:save"></iconify-icon>
                        Save Grade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Live Session Modal -->
    <div class="modal fade" id="liveSessionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <iconify-icon icon="material-symbols:video-call" style="margin-right: 0.5rem;"></iconify-icon>
                        Start Live Session
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="liveSessionForm">
                        <div class="mb-3">
                            <label class="form-label">Session Title</label>
                            <input type="text" class="form-control" id="sessionTitle" placeholder="e.g., Mechanics - Newton's Laws" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Topic</label>
                            <input type="text" class="form-control" id="sessionTopic" placeholder="e.g., Mechanics, Thermodynamics, Electricity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="sessionDescription" rows="3" placeholder="Brief description of what will be covered in this session"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" class="form-control" id="sessionDuration" min="15" max="180" value="60">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Max Participants</label>
                                    <input type="number" class="form-control" id="maxParticipants" min="2" max="100" value="30">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="recordSession" checked>
                                <label class="form-check-label" for="recordSession">
                                    Record session for later viewing
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createLiveSession()">
                        <iconify-icon icon="material-symbols:video-call"></iconify-icon>
                        Start Live Session
                    </button>
                </div>
            </div>
    </div>
</div>

<!-- Questions Display Modal -->
<div class="modal fade" id="questionsDisplayModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionsModalTitle">
                    <iconify-icon icon="material-symbols:quiz" style="margin-right: 0.5rem;"></iconify-icon>
                    Questions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="questionsDisplayContainer">
                    <!-- Questions will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Chat Choice Modal -->
    <div class="modal fade" id="chatChoiceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 2rem;">
                    <h5 class="modal-title d-flex align-items-center">
                        <div class="me-3" style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center;">
                            <iconify-icon icon="material-symbols:forum" style="font-size: 1.8rem;"></iconify-icon>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">Choose Chat Type</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Select how you'd like to connect</div>
                        </div>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="font-size: 1.5rem; opacity: 0.8;"></button>
                </div>
                <div class="modal-body" style="padding: 2.5rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                    <p class="text-center mb-4" style="font-size: 1.1rem; color: #64748b; font-weight: 500;">
                        Choose your preferred chat experience:
                    </p>
                    <div class="d-grid gap-4">
                        <a href="community-chat.html?subject=Chemistry" class="btn btn-lg text-decoration-none p-4 chat-option-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 16px; transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <div class="d-flex align-items-center">
                                <div class="me-4" style="background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                                    <iconify-icon icon="material-symbols:forum" style="font-size: 2rem;"></iconify-icon>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem;">Community Chat</div>
                                    <div style="font-size: 0.95rem; opacity: 0.9;">Join subject discussions with students</div>
                                </div>
                                <div>
                                    <iconify-icon icon="material-symbols:arrow-forward" style="font-size: 1.5rem;"></iconify-icon>
                                </div>
                            </div>
                            <div class="chat-option-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.3s ease;"></div>
                        </a>
                        <a href="resources-chat.html?subject=Chemistry" class="btn btn-lg text-decoration-none p-4 chat-option-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 16px; transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <div class="d-flex align-items-center">
                                <div class="me-4" style="background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                                    <iconify-icon icon="material-symbols:library-books" style="font-size: 2rem;"></iconify-icon>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem;">Resources Chat</div>
                                    <div style="font-size: 0.95rem; opacity: 0.9;">Share and access study materials</div>
                                </div>
                                <div>
                                    <iconify-icon icon="material-symbols:arrow-forward" style="font-size: 1.5rem;"></iconify-icon>
                                </div>
                            </div>
                            <div class="chat-option-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.3s ease;"></div>
                        </a>
                    </div>
                </div>
                <div class="modal-footer" style="background: #f8fafc; border: none; padding: 1.5rem 2.5rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 0.75rem 2rem; border-radius: 12px; font-weight: 500;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .chat-option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chat-option-btn:hover .chat-option-overlay {
            opacity: 1;
        }
        
        .chat-option-btn:active {
            transform: translateY(0);
        }
        
        #chatChoiceModal .modal-dialog {
            max-width: 600px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #chatChoiceModal .modal-body .chat-option-btn {
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }
        
        #chatChoiceModal .modal-body .chat-option-btn:nth-child(1) {
            animation-delay: 0.1s;
        }
        
        #chatChoiceModal .modal-body .chat-option-btn:nth-child(2) {
            animation-delay: 0.2s;
        }
    </style>

    <!-- Practice Questions Modal -->
    <div class="modal fade" id="practiceQuestionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <iconify-icon icon="material-symbols:quiz" style="margin-right: 0.5rem;"></iconify-icon>
                        Practice Questions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-4" id="practiceQuestionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-pane" type="button" role="tab" aria-controls="create-pane" aria-selected="true">
                                <iconify-icon icon="material-symbols:add" class="me-1"></iconify-icon>
                                Create Questions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="view-tab" data-bs-toggle="tab" data-bs-target="#view-pane" type="button" role="tab" aria-controls="view-pane" aria-selected="false">
                                <iconify-icon icon="material-symbols:visibility" class="me-1"></iconify-icon>
                                View All Questions
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="practiceQuestionTabContent">
                        <!-- Create Questions Tab -->
                        <div class="tab-pane fade show active" id="create-pane" role="tabpanel" aria-labelledby="create-tab">
                            <form id="practiceQuestionForm">
                                <!-- Question Type Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold mb-3">Question Type</label>
                                    <div class="question-types">
                                        <button type="button" class="btn btn-outline-primary question-type active" data-type="multiple-choice" onclick="selectPracticeQuestionType('multiple-choice')">
                                            <iconify-icon icon="material-symbols:check-box"></iconify-icon>
                                            Multiple Choice
                                        </button>
                                        <button type="button" class="btn btn-outline-primary question-type" data-type="short-answer" onclick="selectPracticeQuestionType('short-answer')">
                                            <iconify-icon icon="material-symbols:short-text"></iconify-icon>
                                            Short Answer
                                        </button>
                                        <button type="button" class="btn btn-outline-primary question-type" data-type="file-based" onclick="selectPracticeQuestionType('file-based')">
                                            <iconify-icon icon="material-symbols:upload-file"></iconify-icon>
                                            File-Based
                                        </button>
                                        <button type="button" class="btn btn-outline-primary question-type" data-type="bullet-points" onclick="selectPracticeQuestionType('bullet-points')">
                                            <iconify-icon icon="material-symbols:format-list-bulleted"></iconify-icon>
                                            Bullet Points
                                        </button>
                                    </div>
                                </div>

                        <!-- Question Creator -->
                        <div class="question-creator mb-4">
                            <div class="d-flex align-items-end gap-3 mb-3">
                                <div class="flex-grow-1">
                                    <label class="form-label fw-bold">Question Content</label>
                                    <textarea class="form-control" id="practiceQuestionText" rows="3" placeholder="Enter your question here..."></textarea>
                                </div>
                                <div>
                                    <label class="form-label fw-bold">Points</label>
                                    <input type="number" class="form-control" id="practiceQuestionPoints" value="10" min="1" max="100">
                                </div>
                                <div>
                                    <label class="form-label fw-bold">Difficulty</label>
                                    <select class="form-control" id="practiceQuestionDifficulty">
                                        <option value="Easy">Easy</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="Hard">Hard</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label fw-bold">Topic</label>
                                    <input type="text" class="form-control" id="practiceQuestionTopic" placeholder="Topic">
                                </div>
                                <div>
                                    <label class="form-label fw-bold">Folder</label>
                                    <div class="input-group">
                                        <select class="form-select" id="practiceQuestionFolder">
                                            <option value="">Select a folder...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="createNewFolder()">
                                            <iconify-icon icon="material-symbols:add"></iconify-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Answer Options (Dynamic based on type) -->
                            <div id="practiceAnswerOptions">
                                <!-- Multiple Choice Options -->
                                <div id="practiceMultipleChoiceOptions" class="answer-options">
                                    <label class="form-label fw-bold">Answer Options</label>
                                    <div id="practiceMultipleChoiceList">
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="text" class="form-control me-2" placeholder="Option A">
                                            <input type="radio" name="practiceCorrectAnswer" value="A" class="me-2">
                                            <label class="form-label mb-0">Correct</label>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="text" class="form-control me-2" placeholder="Option B">
                                            <input type="radio" name="practiceCorrectAnswer" value="B" class="me-2">
                                            <label class="form-label mb-0">Correct</label>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPracticeOption()">
                                        <iconify-icon icon="material-symbols:add"></iconify-icon>
                                        Add Option
                                    </button>
                                </div>

                                <!-- Short Answer Options -->
                                <div id="practiceShortAnswerOptions" class="answer-options" style="display: none;">
                                    <label class="form-label fw-bold">Expected Answer</label>
                                    <input type="text" class="form-control" id="practiceExpectedAnswer" placeholder="Enter expected answer">
                                </div>

                                <!-- File-Based Options -->
                                <div id="practiceFileBasedOptions" class="answer-options" style="display: none;">
                                    <label class="form-label fw-bold">File Upload Settings</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Allowed File Types</label>
                                            <select class="form-control" id="practiceAllowedFileTypes" multiple>
                                                <option value="jpg">JPG</option>
                                                <option value="png">PNG</option>
                                                <option value="pdf">PDF</option>
                                                <option value="doc">DOC</option>
                                                <option value="docx">DOCX</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Max File Size (MB)</label>
                                            <input type="number" class="form-control" id="practiceMaxFileSize" value="5" min="1" max="50">
                                        </div>
                                    </div>
                                </div>

                                <!-- Bullet Points Options -->
                                <div id="practiceBulletPointsOptions" class="answer-options" style="display: none;">
                                    <label class="form-label fw-bold">Expected Bullet Points</label>
                                    <div id="practiceBulletPointsList">
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="text" class="form-control me-2" placeholder="Bullet point 1">
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePracticeBulletPoint(this)">
                                                <iconify-icon icon="material-symbols:close"></iconify-icon>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPracticeBulletPoint()">
                                        <iconify-icon icon="material-symbols:add"></iconify-icon>
                                        Add Bullet Point
                                    </button>
                                </div>
                            </div>

                            <!-- Time Limit -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Time Limit (minutes)</label>
                                    <input type="number" class="form-control" id="practiceTimeLimit" placeholder="Optional" min="1" max="180">
                                    <small class="form-text text-muted">Leave empty for no time limit. Max 180 minutes (3 hours).</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Explanation</label>
                                    <textarea class="form-control" id="practiceQuestionExplanation" rows="2" placeholder="Optional explanation for the answer"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Questions List -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Created Questions</h6>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-success" id="savePracticeQuestionBtn" onclick="savePracticeQuestion()">
                                        <iconify-icon icon="material-symbols:save"></iconify-icon>
                                        Save Question
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addPracticeQuestion()">
                                        <iconify-icon icon="material-symbols:add"></iconify-icon>
                                        Add Another
                                    </button>
                                </div>
                            </div>
                            <div id="practiceQuestionsList" class="questions-list">
                                <!-- Questions will be added here -->
                            </div>
                        </div>
                    </form>
                        </div>

                        <!-- View All Questions Tab -->
                        <div class="tab-pane fade" id="view-pane" role="tabpanel" aria-labelledby="view-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">All Practice Questions</h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshAllQuestions()">
                                        <iconify-icon icon="material-symbols:refresh"></iconify-icon>
                                        Refresh
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="forceRefreshAllQuestions()">
                                        <iconify-icon icon="material-symbols:sync"></iconify-icon>
                                        Force Refresh
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="syncToStudentDashboard()">
                                        <iconify-icon icon="material-symbols:upload"></iconify-icon>
                                        Sync to Students
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="addTestQuestion()">
                                        <iconify-icon icon="material-symbols:bug-report"></iconify-icon>
                                        Add Test Question
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="fillFormAndTest()">
                                        <iconify-icon icon="material-symbols:build"></iconify-icon>
                                        Fill Form & Test
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="createNewFolder()">
                                        <iconify-icon icon="material-symbols:create-new-folder"></iconify-icon>
                                        New Folder
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllPracticeQuestions()">
                                        <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="allQuestionsList" class="questions-list">
                                <div class="text-center py-4">
                                    <div class="spinner"></div>
                                    <p class="text-muted mt-2">Loading questions...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAllPracticeQuestions()">
                        <iconify-icon icon="material-symbols:save"></iconify-icon>
                        Save All Questions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Practice Questions Modal -->
    <div class="modal fade" id="dailyPracticeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <iconify-icon icon="material-symbols:quiz" style="margin-right: 0.5rem;"></iconify-icon>
                        Daily Practice Questions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="dailyPracticeForm">
                        <!-- Question Type Selection (Compact) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold mb-2">Question Type</label>
                            <div class="question-types-compact">
                                <button type="button" class="btn btn-outline-primary btn-sm question-type-compact active" data-type="multiple-choice" onclick="selectDailyPracticeQuestionType('multiple-choice')">
                                    <iconify-icon icon="material-symbols:check-box"></iconify-icon>
                                    Multiple Choice
                                            </button>
                                <button type="button" class="btn btn-outline-primary btn-sm question-type-compact" data-type="short-answer" onclick="selectDailyPracticeQuestionType('short-answer')">
                                    <iconify-icon icon="material-symbols:short-text"></iconify-icon>
                                    Short Answer
                                            </button>
                                <button type="button" class="btn btn-outline-primary btn-sm question-type-compact" data-type="file-based" onclick="selectDailyPracticeQuestionType('file-based')">
                                    <iconify-icon icon="material-symbols:upload-file"></iconify-icon>
                                    File-Based
                                            </button>
                                                    </div>
                                            </div>
                                    
                        <!-- Question Creator (Compact) -->
                        <div class="question-creator compact d-flex align-items-end gap-2 mb-3">
                            <div>
                                <label class="form-label mb-1 small">Questions</label>
                                <input type="number" class="form-control form-control-sm" id="questionCountInput" min="1" max="50" value="1" placeholder="Count">
                                        </div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addDailyPracticeQuestions()">
                                <iconify-icon icon="material-symbols:add"></iconify-icon>
                                Add
                                        </button>
                                                    </div>
                                    
                        <!-- Questions Container -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Created Questions</h6>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-success" onclick="saveCurrentlyCreatingQuestions()" title="Save current questions">
                                        <iconify-icon icon="material-symbols:save"></iconify-icon>
                                        Save Questions
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showAllQuestions()">
                                            All Questions
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="showQuestionsByDifficulty('Easy')">
                                            Easy
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="showQuestionsByDifficulty('Medium')">
                                            Medium
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="showQuestionsByDifficulty('Hard')">
                                            Hard
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="dailyPracticeQuestionsContainer" class="questions-container" style="display: block;">
                                <!-- Questions will be added here -->
                            </div>
                        </div>
                            
                    </form>
                                            </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button" class="btn btn-outline-danger" onclick="clearAllDailyPracticeQuestions()" id="clearAllBtn" style="display: none;">
                            <iconify-icon icon="material-symbols:delete-forever"></iconify-icon>
                            Delete All Questions
                        </button>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveDailyPracticeQuestions()">
                                <iconify-icon icon="material-symbols:save"></iconify-icon>
                                Save Questions
                            </button>
                            <button type="button" class="btn btn-success" onclick="publishDailyPracticeQuestions()">
                                <iconify-icon icon="material-symbols:publish"></iconify-icon>
                                Publish to Course
                            </button>
                        </div>
                                    </div>
                                </div>
            </div>
                                        </div>
                                    </div>
                                    
    <!-- Session Schedule Modal -->
    <div class="modal fade" id="sessionScheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <iconify-icon icon="material-symbols:schedule" style="margin-right: 0.5rem;"></iconify-icon>
                        Schedule Session
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sessionScheduleForm">
                        <div class="row">
                                        <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Session Title</label>
                                    <input type="text" class="form-control" id="sessionTitle" placeholder="e.g., Chemistry Basics" required>
                                            </div>
                                        </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Session Type</label>
                                    <select class="form-control" id="sessionType" required>
                                        <option value="">Select Type</option>
                                        <option value="lecture">Lecture</option>
                                        <option value="practice">Practice Session</option>
                                        <option value="quiz">Quiz</option>
                                        <option value="exam">Exam</option>
                                        <option value="review">Review Session</option>
                                            </select>
                                        </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-control" id="sessionDate" required>
                                                    </div>
                                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Time</label>
                                    <input type="time" class="form-control" id="sessionTime" required>
                                        </div>
                                                    </div>
                                            </div>
                            
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" class="form-control" id="sessionDuration" min="15" max="180" value="60" required>
                                        </div>
                                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Max Students</label>
                                    <input type="number" class="form-control" id="maxStudents" min="1" max="50" value="30" required>
                                        </div>
                                    </div>
                                </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="sessionDescription" rows="3" placeholder="Describe what will be covered in this session..."></textarea>
                                            </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Location/Platform</label>
                            <input type="text" class="form-control" id="sessionLocation" placeholder="e.g., Classroom A, Zoom Room, Google Meet">
                                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="recurringSession">
                                <label class="form-check-label" for="recurringSession">
                                    Recurring Session
                                </label>
                                    </div>
                                </div>
                                
                        <div id="recurringOptions" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Repeat Every</label>
                                        <select class="form-control" id="repeatFrequency">
                                            <option value="weekly">Week</option>
                                            <option value="biweekly">2 Weeks</option>
                                            <option value="monthly">Month</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="endDate">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSessionSchedule()">
                                <iconify-icon icon="material-symbols:save"></iconify-icon>
                        Save Session
                                            </button>
                </div>
            </div>
                                        </div>
                                    </div>
                                    
    <!-- Weekly Schedule Modal -->
    <div class="modal fade" id="weeklyScheduleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <iconify-icon icon="material-symbols:calendar-month" style="margin-right: 0.5rem;"></iconify-icon>
                        Set Weekly Schedule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="weeklyScheduleForm">
                        <div class="row mb-4">
                                        <div class="col-md-6">
                                <label class="form-label fw-bold">Week Starting Date</label>
                                <input type="date" class="form-control" id="weekStartDate" required>
                                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Schedule Name</label>
                                <input type="text" class="form-control" id="scheduleName" placeholder="e.g., Fall 2024 Schedule" required>
                            </div>
                        </div>

                        <div class="weekly-schedule-grid">
                            <!-- Sunday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Sunday</h6>
                                <div class="session-slots" id="sunday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="sunday-name">
                                        </div>
                                        <div class="col-md-3">
                                                <input type="time" class="form-control" name="sunday-time">
                                        </div>
                                        <div class="col-md-3">
                                                <select class="form-control" name="sunday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                            </select>
                                        </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('sunday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                </button>
                                    </div>
                                    
                            <!-- Monday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Monday</h6>
                                <div class="session-slots" id="monday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="monday-name">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="time" class="form-control" name="monday-time">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-control" name="monday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                            </button>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('monday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                        </button>
                                    </div>
                                    
                            <!-- Tuesday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Tuesday</h6>
                                <div class="session-slots" id="tuesday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="tuesday-name">
                                    </div>
                                            <div class="col-md-3">
                                                <input type="time" class="form-control" name="tuesday-time">
                                </div>
                                            <div class="col-md-3">
                                                <select class="form-control" name="tuesday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('tuesday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                </button>
                            </div>
                            
                            <!-- Wednesday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Wednesday</h6>
                                <div class="session-slots" id="wednesday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="wednesday-name">
                                    </div>
                                            <div class="col-md-3">
                                                <input type="time" class="form-control" name="wednesday-time">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-control" name="wednesday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                                </select>
                                        </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                                </button>
                                            </div>
                                        </div>
                                            </div>
                                        </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('wednesday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                </button>
                                            </div>

                            <!-- Thursday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Thursday</h6>
                                <div class="session-slots" id="thursday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="thursday-name">
                                        </div>
                                            <div class="col-md-3">
                                                <input type="time" class="form-control" name="thursday-time">
                                    </div>
                                            <div class="col-md-3">
                                                <select class="form-control" name="thursday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('thursday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                </button>
                                </div>
                                
                            <!-- Friday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Friday</h6>
                                <div class="session-slots" id="friday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="friday-name">
                                    </div>
                                            <div class="col-md-3">
                                                <input type="time" class="form-control" name="friday-time">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-control" name="friday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                        </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('friday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                        </button>
                            </div>

                            <!-- Saturday -->
                            <div class="day-schedule">
                                <h6 class="day-header">Saturday</h6>
                                <div class="session-slots" id="saturday-slots">
                                    <div class="session-slot">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" placeholder="Session Name" name="saturday-name">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="time" class="form-control" name="saturday-time">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-control" name="saturday-type">
                                                    <option value="">Select Type</option>
                                                    <option value="lecture">Lecture</option>
                                                    <option value="practice">Practice</option>
                                                    <option value="quiz">Quiz</option>
                                                    <option value="exam">Exam</option>
                                                    <option value="review">Review</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                        </button>
                                    </div>
                                </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSessionSlot('saturday-slots')">
                                    <iconify-icon icon="material-symbols:add"></iconify-icon>
                                    Add Session
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveWeeklySchedule()">
                                <iconify-icon icon="material-symbols:save"></iconify-icon>
                        Save Weekly Schedule
                            </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentAssessmentType = 'assignment';
        let currentQuestionType = 'multiple-choice';
        let questionCounter = 0;
        let assessments = [];
        let submissions = [];
        let ChemistryQuizzes = [];
        let ChemistryAssignments = [];
        let ChemistryExams = [];
        let sessionSchedules = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Authentication guard
            const userLoggedIn = localStorage.getItem('userLoggedIn');
            const userRole = localStorage.getItem('userRole');
            const teacherSubject = localStorage.getItem('teacherSubject');
            
            // Check if user is logged in and is a teacher
            if (!userLoggedIn || userRole !== 'teacher') {
                alert('Access denied. Please login as a teacher.');
                window.location.href = 'backend/public/index.html';
                return;
            }
            
            // Check if teacher's subject matches this dashboard
            if (teacherSubject && teacherSubject.toLowerCase() !== 'Chemistry') {
                alert('Access denied. This dashboard is for Chemistry teachers only.');
                window.location.href = 'backend/public/index.html';
                return;
            }
            
            // Load teacher name
            const teacherName = localStorage.getItem('userName');
            if (teacherName) {
                document.getElementById('teacherWelcome').textContent = `Welcome, ${teacherName}!`;
                // Update profile section
                const profileNameEl = document.getElementById('profileTeacherName');
                const profileRoleEl = document.getElementById('profileTeacherRole');
                if (profileNameEl) profileNameEl.textContent = teacherName;
                if (profileRoleEl && teacherSubject) profileRoleEl.textContent = `${teacherSubject} Teacher`;
            }
            }
            
            loadFolders();
            loadChemistryData();
            loadAssessments();
            updateStats();
            loadSessionSchedules();
            loadDailyQuestions();
            loadPracticeQuestions();
            loadLiveSessions();
            
            // Add event listener for publish button
            document.getElementById('publishBtn').addEventListener('click', function() {
                console.log('Publish button clicked via event listener!');
                publishAssessment();
            });
            
            // Debug: Ensure savePracticeQuestion is accessible
            console.log(' Checking if savePracticeQuestion is accessible:', typeof savePracticeQuestion);
            
            // Add error handler for uncaught errors related to practice questions
            window.addEventListener('error', function(e) {
                if (e.message && (e.message.includes('practiceQuestion') || e.message.includes('Practice Question') || e.message.includes('savePracticeQuestion'))) {
                    console.error(' Error in Practice Questions:', e.message, e);
                    showToast('An error occurred. Please check the console for details.', 'error');
                }
            });
            
            // Add event listener to Save Question button as backup
            const saveBtn = document.getElementById('savePracticeQuestionBtn');
            if (saveBtn) {
                console.log(' Found save button, adding event listener');
                saveBtn.addEventListener('click', function(e) {
                    console.log(' Save button clicked via event listener');
                    e.preventDefault();
                    e.stopPropagation();
                    savePracticeQuestion();
                });
            } else {
                console.log(' Save button not found on page load');
            }
        });

        // Refresh data when page becomes visible (user navigates back)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadChemistryData();
                loadAssessments();
                updateStats();
            }
        });

        // Load Chemistry data from course pages - will be loaded from backend or localStorage
        function loadChemistryData() {
            // Load Chemistry assignments from localStorage
            const assignmentsData = localStorage.getItem('ChemistryAssignments');
            ChemistryAssignments = assignmentsData ? JSON.parse(assignmentsData) : [];
            
            // Load Chemistry quizzes from localStorage
            const quizzesData = localStorage.getItem('ChemistryQuizzes');
            ChemistryQuizzes = quizzesData ? JSON.parse(quizzesData) : [];
            
            // Load Chemistry exams from localStorage
            const examsData = localStorage.getItem('ChemistryExams');
            ChemistryExams = examsData ? JSON.parse(examsData) : [];
            
            console.log('Loaded Chemistry data:', {
                assignments: ChemistryAssignments.length,
                quizzes: ChemistryQuizzes.length,
                exams: ChemistryExams.length
            });
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and panes
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            // Add active class to selected tab and pane
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load content based on tab
            if (tabName === 'grading') {
                loadGradingContent();
            }
        }

        // Open create modal
        function openCreateModal(type) {
            currentAssessmentType = type;
            const modal = new bootstrap.Modal(document.getElementById('createModal'));
            const title = document.getElementById('createModalTitle');
            
            switch(type) {
                case 'assignment':
                    title.textContent = 'Create Chemistry Assignment';
                    break;
                case 'quiz':
                    title.textContent = 'Create Chemistry Quiz';
                    break;
                case 'exam':
                    title.textContent = 'Create Chemistry Exam';
                    break;
            }
            
            // Reset form
            document.getElementById('createForm').reset();
            document.getElementById('questionsContainer').innerHTML = '';
            questionCounter = 0;
            
            // Reset form sections
            document.getElementById('fileUploadSection').style.display = 'none';
            document.getElementById('numberOfQuestionsSection').style.display = 'block';
            
            modal.show();
        }


        // Handle file upload
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file size (10MB limit)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('File size must be less than 10MB', 'error');
                input.value = '';
                return;
            }

            // Validate file type
            const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            if (!allowedTypes.includes(file.type)) {
                showToast('Please upload a PDF, Word, or Text file', 'error');
                input.value = '';
                return;
            }

            showToast('File uploaded successfully!', 'success');
            console.log('File uploaded:', file.name, 'Size:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
        }

        // Question type selection
        function selectQuestionType(type) {
            currentQuestionType = type;
            document.querySelectorAll('.question-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.question-type-btn').classList.add('active');
        }

        // Add question
        function addQuestion() {
            questionCounter++;
            const container = document.getElementById('questionsContainer');
            
            const questionHtml = `
                <div class="question-item mb-4 p-3 border rounded" id="question-${questionCounter}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Question ${questionCounter}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${questionCounter})">
                            <iconify-icon icon="material-symbols:delete"></iconify-icon>
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control" name="questionText" rows="3" placeholder="Enter your question..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control" name="questionPoints" min="1" value="10">
                    </div>
                    <div id="questionOptions-${questionCounter}">
                        ${generateQuestionOptions(currentQuestionType, questionCounter)}
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', questionHtml);
        }

        // Generate question options based on type
        function generateQuestionOptions(type, questionId, options = []) {
            switch(type) {
                case 'multiple-choice':
                case 'multiple-select':
                    const optionHtml = options.length > 0 ? 
                        options.map((option, index) => `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Option ${index + 1}" value="${option}">
                                <div class="input-group-text">
                                    <input type="radio" name="correct-${questionId}" value="${index}">
                                </div>
                            </div>
                        `).join('') :
                        `
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Option 1">
                                    <div class="input-group-text">
                                        <input type="radio" name="correct-${questionId}" value="0">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Option 2">
                                    <div class="input-group-text">
                                        <input type="radio" name="correct-${questionId}" value="1">
                                    </div>
                                </div>
                        `;
                    
                    return `
                        <div class="mb-3">
                            <label class="form-label">Options</label>
                            <div id="options-${questionId}">
                                ${optionHtml}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption(${questionId})">
                                <iconify-icon icon="material-symbols:add"></iconify-icon>
                                Add Option
                            </button>
                        </div>
                    `;
                case 'true-false':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Correct Answer</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct-${questionId}" value="true">
                                <label class="form-check-label">True</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct-${questionId}" value="false">
                                <label class="form-check-label">False</label>
                            </div>
                        </div>
                    `;
                case 'short-answer':
                case 'essay':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Sample Answer (Optional)</label>
                            <textarea class="form-control" name="sampleAnswer" rows="2" placeholder="Provide a sample answer for reference..."></textarea>
                        </div>
                    `;
                case 'file-upload':
                case 'file-based':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Upload Question File (Optional)</label>
                            <div class="file-upload-area" onclick="document.getElementById('questionFile_${questionId}').click()" 
                                 style="border: 2px dashed #667eea; border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; background: #f8f9ff;">
                                <iconify-icon icon="material-symbols:cloud-upload" style="font-size: 2rem; color: #667eea;"></iconify-icon>
                                <div style="margin-top: 0.5rem; color: #667eea;">Click to upload question file (PDF, Image, etc.)</div>
                                <div id="questionFileDisplay_${questionId}" style="margin-top: 0.5rem; font-size: 0.9rem; color: #28a745;"></div>
                            </div>
                            <input type="file" id="questionFile_${questionId}" style="display: none;" 
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" 
                                   onchange="handleQuestionFileUpload('${questionId}', this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Allowed Answer File Types</label>
                            <select class="form-control" name="allowedTypes" multiple>
                                <option value="pdf" selected>PDF</option>
                                <option value="doc" selected>DOC</option>
                                <option value="docx" selected>DOCX</option>
                                <option value="jpg" selected>JPG</option>
                                <option value="png" selected>PNG</option>
                                <option value="txt">TXT</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max File Size (MB)</label>
                            <input type="number" class="form-control" name="maxFileSize" value="10" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Answer Type</label>
                            <select class="form-control" name="answerType" onchange="toggleAnswerOptions('${questionId}')">
                                <option value="file-upload">File Upload Only</option>
                                <option value="file-with-multiple-choice">File Upload + Multiple Choice</option>
                                <option value="multiple-choice-only">Multiple Choice Only</option>
                            </select>
                        </div>
                        <div class="mb-3" id="multipleChoiceOptions_${questionId}" style="display: none;">
                            <label class="form-label">Multiple Choice Options (for file assessment)</label>
                            <div id="fileAnswerOptions_${questionId}">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Option 1" name="fileAnswerOption">
                                    <div class="input-group-text">
                                        <input type="radio" name="correctFileAnswer_${questionId}" value="0">
                                    </div>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeFileAnswerOption(this)">
                                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                                    </button>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Option 2" name="fileAnswerOption">
                                    <div class="input-group-text">
                                        <input type="radio" name="correctFileAnswer_${questionId}" value="1">
                                    </div>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeFileAnswerOption(this)">
                                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFileAnswerOption('${questionId}')">
                                <iconify-icon icon="material-symbols:add"></iconify-icon> Add Option
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instructions for Students</label>
                            <textarea class="form-control" name="fileInstructions" rows="3" placeholder="Provide specific instructions for file submission and/or multiple choice answers..."></textarea>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        // Add option to multiple choice questions
        function addOption(questionId) {
            const container = document.getElementById(`options-${questionId}`);
            const optionCount = container.children.length;
            
            const optionHtml = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control" placeholder="Option ${optionCount + 1}">
                    <div class="input-group-text">
                        <input type="radio" name="correct-${questionId}" value="${optionCount}">
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="removeOption(this)">
                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        // Remove option
        function removeOption(button) {
            button.closest('.input-group').remove();
        }

        // Handle question file upload
        function handleQuestionFileUpload(questionId, input) {
            const file = input.files[0];
            if (file) {
                const display = document.getElementById(`questionFileDisplay_${questionId}`);
                display.innerHTML = `
                    <strong>Uploaded:</strong> ${file.name} (${formatFileSize(file.size)})
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeQuestionFile('${questionId}')">
                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                    </button>
                `;
                
                // Store file data for later use
                const fileData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: file // Store the actual file object
                };
                
                // Store in a temporary storage for this question
                if (!window.questionFiles) window.questionFiles = {};
                window.questionFiles[elementId] = fileData;
            }
        }

        // Remove question file
        function removeQuestionFile(questionId) {
            const input = document.getElementById(`questionFile_${questionId}`);
            const display = document.getElementById(`questionFileDisplay_${questionId}`);
            
            input.value = '';
            display.innerHTML = '';
            
            if (window.questionFiles) {
                delete window.questionFiles[elementId];
            }
        }

        // Toggle answer options for file assessments
        function toggleAnswerOptions(questionId) {
            const answerType = document.querySelector(`select[name="answerType"]`).value;
            const multipleChoiceDiv = document.getElementById(`multipleChoiceOptions_${questionId}`);
            
            if (answerType === 'file-with-multiple-choice' || answerType === 'multiple-choice-only') {
                multipleChoiceDiv.style.display = 'block';
            } else {
                multipleChoiceDiv.style.display = 'none';
            }
        }

        // Add file answer option
        function addFileAnswerOption(questionId) {
            const container = document.getElementById(`fileAnswerOptions_${questionId}`);
            const optionCount = container.children.length;
            
            const optionHtml = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control" placeholder="Option ${optionCount + 1}" name="fileAnswerOption">
                    <div class="input-group-text">
                        <input type="radio" name="correctFileAnswer_${questionId}" value="${optionCount}">
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="removeFileAnswerOption(this)">
                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        // Remove file answer option
        function removeFileAnswerOption(button) {
            const container = button.closest('.input-group').parentElement;
            if (container.children.length > 2) {
                button.closest('.input-group').remove();
            } else {
                showToast('At least 2 options are required', 'warning');
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Generate questions automatically
        function generateQuestions() {
            const numberOfQuestions = parseInt(document.getElementById('numberOfQuestions').value) || 5;
            const autoGenerate = document.getElementById('autoGenerateQuestions').checked;
            
            if (!autoGenerate) {
                showToast('Please enable auto-generation checkbox first!', 'warning');
                return;
            }
            
            // Clear existing questions
            document.getElementById('questionsContainer').innerHTML = '';
            questionCounter = 0;
            
            // Generate questions based on assessment type and subject
            const assessmentType = currentAssessmentType;
            const subject = 'Chemistry';
            
            console.log(`Generating ${numberOfQuestions} questions of type: ${assessmentType}`);
            
            for (let i = 1; i <= numberOfQuestions; i++) {
                questionCounter++;
                const container = document.getElementById('questionsContainer');
                
                // Generate question content based on type and subject
                const questionContent = generateQuestionContent(assessmentType, subject, i);
                
                console.log(`Generating question ${i}:`, questionContent);
                
                const questionHtml = `
                    <div class="question-item mb-4 p-3 border rounded" id="question-${questionCounter}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Question ${questionCounter}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${questionCounter})">
                                <iconify-icon icon="material-symbols:delete"></iconify-icon>
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question Text</label>
                            <textarea class="form-control" name="questionText" rows="3" placeholder="Enter your question...">${questionContent.text}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Points</label>
                            <input type="number" class="form-control" name="questionPoints" min="1" value="${questionContent.points}">
                        </div>
                        <div id="questionOptions-${questionCounter}">
                            ${generateQuestionOptions(questionContent.type, questionCounter, questionContent.options)}
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', questionHtml);
                console.log(`Added question ${i} to container`);
            }
            
            // Verify all questions were added
            const addedQuestions = document.querySelectorAll('.question-item');
            console.log(`Total questions in DOM after generation: ${addedQuestions.length}`);
            
            showToast(`Generated ${numberOfQuestions} questions automatically!`, 'success');
        }
        
        // Generate question content based on assessment type and subject
        function generateQuestionContent(assessmentType, subject, questionNumber) {
            const questionTemplates = {
                mathematics: {
                    assignment: [
                        {
                            text: "Solve for x: 2x + 5 = 13",
                            type: "short-answer",
                            points: 8,
                            options: []
                        },
                        {
                            text: "What is the value of 3 + 4?",
                            type: "multiple-choice",
                            points: 6,
                            options: ["25", "7", "12", "49"]
                        },
                        {
                            text: "Calculate the area of a circle with radius 7cm. (Use  = 3.14)",
                            type: "short-answer",
                            points: 10,
                            options: []
                        },
                        {
                            text: "Which of the following is a prime number?",
                            type: "multiple-choice",
                            points: 5,
                            options: ["15", "17", "21", "25"]
                        },
                        {
                            text: "The sum of angles in a triangle is 180.",
                            type: "true-false",
                            points: 4,
                            options: []
                        }
                    ],
                    quiz: [
                        {
                            text: "What is 15% of 200?",
                            type: "multiple-choice",
                            points: 5,
                            options: ["30", "25", "35", "40"]
                        },
                        {
                            text: "A square has 4 equal sides.",
                            type: "true-false",
                            points: 3,
                            options: []
                        },
                        {
                            text: "Find the slope of the line passing through points (2,3) and (4,7).",
                            type: "short-answer",
                            points: 8,
                            options: []
                        },
                        {
                            text: "What is the next number in the sequence: 2, 4, 8, 16, ?",
                            type: "multiple-choice",
                            points: 6,
                            options: ["24", "32", "20", "18"]
                        },
                        {
                            text: "The derivative of x is 2x.",
                            type: "true-false",
                            points: 4,
                            options: []
                        }
                    ],
                    exam: [
                        {
                            text: "Solve the system of equations: 2x + 3y = 12 and x - y = 1",
                            type: "short-answer",
                            points: 15,
                            options: []
                        },
                        {
                            text: "Find the derivative of f(x) = 3x - 2x + 5x - 1",
                            type: "short-answer",
                            points: 12,
                            options: []
                        },
                        {
                            text: "Calculate the integral of (2x + 3)dx from 0 to 2",
                            type: "short-answer",
                            points: 18,
                            options: []
                        },
                        {
                            text: "Which of the following is the correct formula for the quadratic equation?",
                            type: "multiple-choice",
                            points: 8,
                            options: ["ax + bx + c = 0", "ax + b = 0", "ax + bx + c = 0", "a/x + b = 0"]
                        },
                        {
                            text: "The limit as x approaches 0 of sin(x)/x equals 1.",
                            type: "true-false",
                            points: 6,
                            options: []
                        }
                    ]
                }
            };
            
            const subjectTemplates = questionTemplates[subject] || questionTemplates.mathematics;
            const typeTemplates = subjectTemplates[assessmentType] || subjectTemplates.assignment;
            
            // Cycle through templates or generate random content
            const templateIndex = (questionNumber - 1) % typeTemplates.length;
            return typeTemplates[templateIndex];
        }

        // Remove question
        function removeQuestion(questionId) {
            document.getElementById(`question-${questionId}`).remove();
        }

        // Save assessment
        function saveAssessment() {
            const assessmentType = document.querySelector('input[name="assessmentType"]:checked').value;
            
            const formData = {
                id: Date.now().toString(),
                type: currentAssessmentType,
                assessmentType: assessmentType,
                title: document.getElementById('assessmentTitle').value,
                description: document.getElementById('assessmentDescription').value,
                totalPoints: parseInt(document.getElementById('totalPoints').value),
                timeLimit: document.getElementById('timeLimit').value ? parseInt(document.getElementById('timeLimit').value) : null,
                timeLimitSeconds: getTimeLimitInSeconds(), // Add seconds for countdown
                dueDate: document.getElementById('dueDate').value,
                difficulty: document.getElementById('difficulty').value,
                questions: collectQuestions(),
                createdAt: new Date().toISOString(),
                status: 'draft',
                hasCountdownTimer: !!document.getElementById('timeLimit').value // Flag to indicate countdown timer
            };

            // File-based assessment logic removed since we only use standard assessments now

            assessments.push(formData);
            saveToLocalStorage();
            loadAssessments();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
            modal.hide();
            
            showToast('Assessment saved as draft with countdown timer!', 'success');
        }

        // Publish assessment to course page
        function publishAssessment() {
            console.log('=== PUBLISHING ASSESSMENT ===');
            
            // Default to standard assessment type since we removed the selection
            const assessmentType = 'standard';
            
            const collectedQuestions = collectQuestions();
            console.log('Collected questions:', collectedQuestions);
            console.log('Number of questions collected:', collectedQuestions.length);
            
            const formData = {
                id: Date.now().toString(),
                type: currentAssessmentType,
                assessmentType: assessmentType,
                title: document.getElementById('assessmentTitle').value,
                description: document.getElementById('assessmentDescription').value,
                totalPoints: parseInt(document.getElementById('totalPoints').value),
                timeLimit: document.getElementById('timeLimit').value ? parseInt(document.getElementById('timeLimit').value) : null,
                timeLimitSeconds: getTimeLimitInSeconds(), // Add seconds for countdown
                dueDate: document.getElementById('dueDate').value,
                difficulty: document.getElementById('difficulty').value,
                questions: collectedQuestions,
                status: 'published',
                createdAt: new Date().toISOString(),
                subject: 'Chemistry',
                hasCountdownTimer: !!document.getElementById('timeLimit').value // Flag to indicate countdown timer
            };
            
            console.log('Form data to publish:', formData);

            // File-based assessment logic removed since we only use standard assessments now

            // Save to assessments (for teacher dashboard)
            assessments.push(formData);
            saveToLocalStorage();

            // Publish to course page based on type
            publishToCoursePage(formData);

            loadAssessments();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
            modal.hide();
            
            showToast('Assessment published with countdown timer!', 'success');
        }

        // Publish assessment to the appropriate course page
        function publishToCoursePage(assessment) {
            const courseData = {
                id: assessment.id,
                title: assessment.title,
                description: assessment.description,
                points: assessment.totalPoints,
                dueDate: assessment.dueDate,
                difficulty: assessment.difficulty.charAt(0).toUpperCase() + assessment.difficulty.slice(1),
                estimatedTime: assessment.timeLimit ? `${assessment.timeLimit} minutes` : 'No time limit',
                timeLimit: assessment.timeLimit, // Add timeLimit as a number
                timeLimitSeconds: assessment.timeLimitSeconds, // Include countdown timer data
                questions: assessment.questions,
                status: 'published',
                type: assessment.type, // Add the type field
                subject: 'Chemistry', // Add the subject field for fallback compatibility
                createdAt: new Date().toISOString(),
                publishedOn: new Date().toISOString(), // Add publishedOn field
                hasCountdownTimer: assessment.hasCountdownTimer // Include countdown flag
            };

            // Determine the localStorage key based on assessment type
            let storageKey;
            switch(assessment.type) {
                case 'assignment':
                    storageKey = 'ChemistryAssignments';
                    break;
                case 'quiz':
                    storageKey = 'ChemistryQuizzes';
                    break;
                case 'exam':
                    storageKey = 'ChemistryExams';
                    break;
                default:
                    console.error('Unknown assessment type:', assessment.type);
                    return;
            }

            // Load existing data and add new assessment
            const existingData = JSON.parse(localStorage.getItem(storageKey)) || [];
            existingData.push(courseData);
            localStorage.setItem(storageKey, JSON.stringify(existingData));

            console.log(`Published ${assessment.type} to ${storageKey}:`, courseData);
        }

        // Collect questions from form
        function collectQuestions() {
            const questions = [];
            const questionElements = document.querySelectorAll('.question-item');
            
            console.log('Collecting questions. Total question elements found:', questionElements.length);
            
            questionElements.forEach((element, index) => {
                const questionTextElement = element.querySelector('[name="questionText"]');
                const questionPointsElement = element.querySelector('[name="questionPoints"]');
                
                if (!questionTextElement || !questionPointsElement) {
                    console.warn(`Question ${index + 1} is missing required fields, skipping...`);
                    return;
                }
                
                // Determine question type by checking the DOM structure
                let questionType = 'short-answer'; // default
                
                // Check if it has multiple choice options
                if (element.querySelector('.input-group input[type="text"]')) {
                    questionType = 'multiple-choice';
                }
                // Check if it's true/false
                else if (element.querySelector('input[type="radio"][value="true"]')) {
                    questionType = 'true-false';
                }
                // Check if it's file upload
                else if (element.querySelector('input[type="file"]')) {
                    questionType = 'file-upload';
                }
                // Check if it's essay (has sampleAnswer field)
                else if (element.querySelector('[name="sampleAnswer"]')) {
                    questionType = 'essay';
                }
                
                const questionData = {
                    id: `q${index + 1}`,
                    type: questionType,
                    text: questionTextElement.value,
                    points: parseInt(questionPointsElement.value) || 1,
                    options: [],
                    correctAnswer: null,
                    sampleAnswer: element.querySelector('[name="sampleAnswer"]')?.value || null
                };

                console.log(`Question ${index + 1}: type=${questionType}, text="${questionTextElement.value.substring(0, 30)}..."`);

                // Collect options for multiple choice questions
                if (questionType === 'multiple-choice' || questionType === 'multiple-select') {
                    const optionInputs = element.querySelectorAll('.input-group input[type="text"]');
                    optionInputs.forEach((input, optionIndex) => {
                        if (input.value.trim()) {
                            questionData.options.push(input.value.trim());
                        }
                    });
                    
                    // Find correct answer
                    const correctRadio = element.querySelector('input[type="radio"]:checked');
                    if (correctRadio) {
                        questionData.correctAnswer = parseInt(correctRadio.value);
                    }
                } else if (questionType === 'true-false') {
                    const correctRadio = element.querySelector('input[type="radio"]:checked');
                    if (correctRadio) {
                        questionData.correctAnswer = correctRadio.value;
                    }
                }

                questions.push(questionData);
            });

            console.log(`Total questions collected: ${questions.length}`);
            return questions;
        }

        // Load assessments
        function loadAssessments() {
            const container = document.getElementById('assessmentsContainer');
            if (!container) return; // Exit if container doesn't exist
            
            // Combine all Chemistry assessments
            const allAssessments = [
                ...ChemistryAssignments.map(a => ({...a, type: 'assignment'})),
                ...ChemistryQuizzes.map(q => ({...q, type: 'quiz'})),
                ...ChemistryExams.map(e => ({...e, type: 'exam'}))
            ];
            
            if (allAssessments.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <iconify-icon icon="material-symbols:folder-open" style="font-size: 4rem; color: #ccc;"></iconify-icon>
                        <h4 class="mt-3 text-muted">No assessments yet</h4>
                        <p class="text-muted">Create your first assessment to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allAssessments.map(assessment => `
                <div class="assessment-card">
                    <div class="assessment-header">
                        <span class="assessment-type ${assessment.type}">${assessment.type.charAt(0).toUpperCase() + assessment.type.slice(1)}</span>
                        <div class="assessment-menu">
                            <button class="menu-btn" onclick="showAssessmentMenu('${assessment.id}')">
                                <iconify-icon icon="material-symbols:more-vert"></iconify-icon>
                            </button>
                        </div>
                    </div>
                    <div class="assessment-title">${assessment.title}</div>
                    <div class="assessment-meta">
                        <div class="meta-item">
                            <iconify-icon icon="material-symbols:schedule"></iconify-icon>
                            <span>${assessment.dueDate ? new Date(assessment.dueDate).toLocaleDateString() : 
                                   assessment.date ? new Date(assessment.date).toLocaleDateString() : 'No date'}</span>
                        </div>
                        <div class="meta-item">
                            <iconify-icon icon="material-symbols:star"></iconify-icon>
                            <span>${assessment.difficulty}</span>
                        </div>
                        <div class="meta-item">
                            <iconify-icon icon="material-symbols:quiz"></iconify-icon>
                            <span>${assessment.questions ? assessment.questions.length : 0} questions</span>
                        </div>
                    </div>
                    <div class="assessment-stats">
                        <div class="stat-item">
                            <div class="stat-value">${assessment.points || assessment.maxScore || 0}</div>
                            <div class="stat-label">Points</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${getSubmissionCount(assessment.id)}</div>
                            <div class="stat-label">Submissions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${assessment.status}</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                    <div class="assessment-actions">
                        <button class="btn-sm btn-primary" onclick="editAssessment('${assessment.id}')">
                            <iconify-icon icon="material-symbols:edit"></iconify-icon>
                            Edit
                        </button>
                        <button class="btn-sm btn-outline" onclick="viewSubmissions('${assessment.id}')">
                            <iconify-icon icon="material-symbols:visibility"></iconify-icon>
                            View
                        </button>
                        <a href="${getMathematicsPageUrl(assessment.type)}" class="btn-sm btn-success">
                            <iconify-icon icon="material-symbols:open-in-new"></iconify-icon>
                            Open in Course
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Load grading content
        function loadGradingContent() {
            const container = document.getElementById('gradingContainer');
            const stored = localStorage.getItem('mathematicsSubmissions');
            submissions = stored ? JSON.parse(stored) : getSampleSubmissions();
            
            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <iconify-icon icon="material-symbols:grading" style="font-size: 4rem; color: #ccc;"></iconify-icon>
                        <h4 class="mt-3 text-muted">No submissions to grade</h4>
                        <p class="text-muted">Student submissions will appear here when they submit their work</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="grading-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Assessment</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Grade</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${submissions.map(submission => `
                                <tr>
                                    <td>
                                        <div class="student-info">
                                            <div class="student-avatar">
                                                ${submission.student.name.charAt(0)}
                                            </div>
                                            <div class="student-details">
                                                <h6>${submission.student.name}</h6>
                                                <small>${submission.student.email}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${submission.assessmentTitle}</td>
                                    <td>${new Date(submission.submittedAt).toLocaleDateString()}</td>
                                    <td>
                                        <span class="status-badge status-${submission.status}">
                                            ${submission.status}
                                        </span>
                                    </td>
                                    <td>
                                        ${submission.grade ? `${submission.grade}/${submission.maxGrade}` : '-'}
                                    </td>
                                    <td>
                                        <button class="btn-sm btn-primary" onclick="gradeSubmission('${submission.id}')">
                                            <iconify-icon icon="material-symbols:grading"></iconify-icon>
                                            Grade
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Grade submission
        function gradeSubmission(submissionId) {
            const submission = submissions.find(s => s.id === submissionId);
            if (!submission) return;

            const modal = new bootstrap.Modal(document.getElementById('gradingModal'));
            document.getElementById('gradingModalTitle').textContent = `Grade: ${submission.assessmentTitle}`;
            
            document.getElementById('gradingModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Student: ${submission.student.name}</h6>
                        <h6>Assessment: ${submission.assessmentTitle}</h6>
                        <div class="mt-3">
                            <h6>Student's Answers:</h6>
                            <div class="border rounded p-3" style="background: #f8f9fa;">
                                ${submission.answers.map((answer, index) => `
                                    <div class="mb-3">
                                        <strong>Question ${index + 1}:</strong>
                                        <p class="mt-1">${answer}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>Grading</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Total Grade</label>
                                    <input type="number" class="form-control" id="totalGrade" max="${submission.maxGrade}" min="0" value="${submission.grade || 0}">
                                    <small class="text-muted">Out of ${submission.maxGrade} points</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Comments</label>
                                    <textarea class="form-control" id="gradeComments" rows="4" placeholder="Add feedback for the student...">${submission.comments || ''}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-control" id="gradeStatus">
                                        <option value="graded" ${submission.status === 'graded' ? 'selected' : ''}>Graded</option>
                                        <option value="pending" ${submission.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="late" ${submission.status === 'late' ? 'selected' : ''}>Late</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }

        // Save grade
        function saveGrade() {
            const submissionId = document.querySelector('[data-submission-id]')?.dataset.submissionId;
            if (!submissionId) return;

            const submission = submissions.find(s => s.id === submissionId);
            if (!submission) return;

            submission.grade = parseInt(document.getElementById('totalGrade').value);
            submission.comments = document.getElementById('gradeComments').value;
            submission.status = document.getElementById('gradeStatus').value;
            submission.gradedAt = new Date().toISOString();

            saveToLocalStorage();
            loadGradingContent();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('gradingModal'));
            modal.hide();
            
            showToast('Grade saved successfully!', 'success');
        }

        // Publish existing assessment
        function publishExistingAssessment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            assessment.status = 'published';
            assessment.publishedAt = new Date().toISOString();
            
            saveToLocalStorage();
            loadAssessments();
            updateStats();
            
            showToast('Assessment published successfully!', 'success');
        }

        // View submissions
        function viewSubmissions(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            const assessmentSubmissions = submissions.filter(s => s.assessmentId === assessmentId);
            
            // Switch to grading tab and filter
            switchTab('grading');
            // Filter grading content to show only this assessment's submissions
        }

        // Edit assessment
        function editAssessment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            // Open create modal with assessment data
            openCreateModal(assessment.type);
            
            // Populate form with existing data
            document.getElementById('assessmentTitle').value = assessment.title;
            document.getElementById('assessmentDescription').value = assessment.description;
            document.getElementById('totalPoints').value = assessment.totalPoints;
            document.getElementById('timeLimit').value = assessment.timeLimit || '';
            document.getElementById('dueDate').value = assessment.dueDate;
            document.getElementById('difficulty').value = assessment.difficulty;
            
            // Add existing questions
            assessment.questions.forEach(question => {
                addQuestion();
                // Populate question data
            });
        }

        // Get submission count
        function getSubmissionCount(assessmentId) {
            return submissions.filter(s => s.assessmentId === assessmentId).length;
        }

        // Update stats
        function updateStats() {
            // Use real data from Chemistry course pages
            document.getElementById('totalAssignments').textContent = ChemistryAssignments.length;
            document.getElementById('totalQuizzes').textContent = ChemistryQuizzes.length;
            document.getElementById('totalExams').textContent = ChemistryExams.length;
            
            // Calculate pending grading from assignments and submissions
            const pendingAssignments = ChemistryAssignments.filter(a => a.status === 'pending' || a.status === 'overdue').length;
            const pendingSubmissions = submissions.filter(s => s.status === 'pending').length;
            document.getElementById('pendingGrading').textContent = pendingAssignments + pendingSubmissions;

            // Update notification count with actual pending items
            const notificationCount = pendingAssignments + pendingSubmissions;
            document.getElementById('notificationCount').textContent = notificationCount;

        }

        // Filter assessments
        function filterAssessments(type) {
            // Implementation for filtering assessments by type
            loadAssessments();
        }

        // Filter grading
        function filterGrading(status) {
            // Implementation for filtering submissions by status
            loadGradingContent();
        }

        // Refresh assessments
        function refreshAssessments() {
            loadAssessments();
            showToast('Assessments refreshed', 'success');
        }

        // Open grading panel
        function openGradingPanel() {
            switchTab('grading');
        }

        // Show notifications
        function showNotifications() {
            showToast('You have 3 pending submissions to grade', 'warning');
        }

        // Show course assistants
        async function showCourseAssistants() {
            try {
                // Fetch assistants from backend using teacher endpoint
                const response = await fetch('/api/teacher/assistants?subject=Chemistry', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'demo-token'}`
                    }
                });

                if (response.ok) {
                    const assistants = await response.json();
                    
                    // Show assistants modal
                    showAssistantsModal(assistants);
                } else {
                    // Fallback to localStorage data
                    const localAssistants = JSON.parse(localStorage.getItem('ChemistryAssistants')) || [];
                    showAssistantsModal(localAssistants);
                }
            } catch (error) {
                console.error('Error loading assistants:', error);
                // Fallback to localStorage data
                const localAssistants = JSON.parse(localStorage.getItem('ChemistryAssistants')) || [];
                showAssistantsModal(localAssistants);
            }
        }

        // Show assistants modal
        function showAssistantsModal(assistants) {
            const modalHtml = `
                <div class="modal fade" id="assistantsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <iconify-icon icon="material-symbols:people" style="margin-right: 0.5rem;"></iconify-icon>
                                    Chemistry Course Assistants
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Assistant Management</h6>
                                    <button class="btn btn-primary btn-sm" onclick="openAddAssistantModal()">
                                        <iconify-icon icon="material-symbols:person-add"></iconify-icon>
                                        Add New Assistant
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Availability</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${assistants.length > 0 ? assistants.map(assistant => `
                                                <tr>
                                                    <td>${assistant.name}</td>
                                                    <td>${assistant.email}</td>
                                                    <td>${assistant.phone || 'N/A'}</td>
                                                    <td>
                                                        <span class="badge bg-info">${assistant.availability}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge ${assistant.status === 'active' ? 'bg-success' : assistant.status === 'pending' ? 'bg-warning' : 'bg-secondary'}">
                                                            ${assistant.status}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" onclick="viewAssistantDetails(${assistant.id})">
                                                            <iconify-icon icon="material-symbols:visibility"></iconify-icon>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success" onclick="editAssistant(${assistant.id})">
                                                            <iconify-icon icon="material-symbols:edit"></iconify-icon>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" onclick="removeAssistant(${assistant.id})">
                                                            <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('') : `
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">No assistants found</td>
                                                </tr>
                                            `}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('assistantsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('assistantsModal'));
            modal.show();
        }

        // View assistant details
        function viewAssistantDetails(assistantId) {
            // Get assistant data from localStorage or backend
            const assistants = JSON.parse(localStorage.getItem('ChemistryAssistants')) || [];
            const assistant = assistants.find(a => a.id == assistantId);
            
            if (!assistant) {
                showToast('Assistant not found', 'error');
                return;
            }

            const detailsHtml = `
                <div class="modal fade" id="assistantDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <iconify-icon icon="material-symbols:person" style="margin-right: 0.5rem;"></iconify-icon>
                                    Assistant Details
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Personal Information</h6>
                                        <p><strong>Name:</strong> ${assistant.name}</p>
                                        <p><strong>Email:</strong> ${assistant.email}</p>
                                        <p><strong>Phone:</strong> ${assistant.phone || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Professional Information</h6>
                                        <p><strong>Availability:</strong> <span class="badge bg-info">${assistant.availability}</span></p>
                                        <p><strong>Status:</strong> <span class="badge ${assistant.status === 'active' ? 'bg-success' : 'bg-warning'}">${assistant.status}</span></p>
                                        <p><strong>Subject:</strong> ${assistant.subject}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="editAssistant(${assistant.id})">Edit Assistant</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('assistantDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', detailsHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('assistantDetailsModal'));
            modal.show();
        }

        // Edit assistant
        async function editAssistant(assistantId) {
            try {
                // First try to get from localStorage
                const assistants = JSON.parse(localStorage.getItem('ChemistryAssistants')) || [];
                let assistant = assistants.find(a => a.id == assistantId);
                
                // If not found in localStorage, try to get from database
                if (!assistant) {
                    const response = await fetch('/api/teacher/assistants?subject=Chemistry', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || 'demo-token'}`
                        }
                    });
                    
                    if (response.ok) {
                        const dbAssistants = await response.json();
                        assistant = dbAssistants.find(a => a.id == assistantId);
                    }
                }
                
                if (!assistant) {
                    showToast('Assistant not found', 'error');
                    return;
                }

                // Pre-fill the add assistant modal with existing data
                document.getElementById('assistantName').value = assistant.name;
                document.getElementById('assistantEmail').value = assistant.email;
                document.getElementById('assistantPhone').value = assistant.phone || '';
                document.getElementById('assistantAvailability').value = assistant.availability || 'full-time';

                // Show the add assistant modal (which will work as edit modal)
                const modalElement = document.getElementById('addAssistantModal');
                // Ensure this modal appears on top of any other modals
                modalElement.style.zIndex = '1070';
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Change the modal title to indicate editing
                document.querySelector('#addAssistantModal .modal-title').innerHTML = `
                    <iconify-icon icon="material-symbols:edit" style="margin-right: 0.5rem;"></iconify-icon>
                    Edit Assistant - ${assistant.name}
                `;
            } catch (error) {
                console.error('Error loading assistant for editing:', error);
                showToast('Error loading assistant', 'error');
            }
        }

        // Remove assistant
        async function removeAssistant(assistantId) {
            if (!confirm('Are you sure you want to remove this assistant?')) {
                return;
            }

            try {
                // Remove from backend using teacher endpoint
                const response = await fetch(`/api/teacher/assistants/${assistantId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'demo-token'}`
                    }
                });

                // Remove from localStorage
                let assistants = JSON.parse(localStorage.getItem('ChemistryAssistants')) || [];
                assistants = assistants.filter(a => a.id != assistantId);
                localStorage.setItem('ChemistryAssistants', JSON.stringify(assistants));

                showToast('Assistant removed successfully', 'success');
                
                // Refresh the assistants modal if it's open
                const assistantsModal = document.getElementById('assistantsModal');
                if (assistantsModal && assistantsModal.style.display !== 'none') {
                    showCourseAssistants();
                }
            } catch (error) {
                console.error('Error removing assistant:', error);
                showToast('Error removing assistant', 'error');
            }
        }

        // Weekly Schedule Functions
        function openWeeklyScheduleModal() {
            const modal = new bootstrap.Modal(document.getElementById('weeklyScheduleModal'));
            modal.show();
            
            // Set default week start date to next Sunday
            const today = new Date();
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + (7 - today.getDay()));
            document.getElementById('weekStartDate').value = nextSunday.toISOString().split('T')[0];
        }

        function addSessionSlot(daySlotsId) {
            const container = document.getElementById(daySlotsId);
            const dayName = daySlotsId.replace('-slots', '');
            
            const sessionSlot = document.createElement('div');
            sessionSlot.className = 'session-slot';
            sessionSlot.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Session Name" name="${dayName}-name">
                    </div>
                    <div class="col-md-3">
                        <input type="time" class="form-control" name="${dayName}-time">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" name="${dayName}-type">
                            <option value="">Select Type</option>
                            <option value="lecture">Lecture</option>
                            <option value="practice">Practice</option>
                            <option value="quiz">Quiz</option>
                            <option value="exam">Exam</option>
                            <option value="review">Review</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSessionSlot(this)">
                            <iconify-icon icon="material-symbols:delete"></iconify-icon>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(sessionSlot);
        }

        function removeSessionSlot(button) {
            const sessionSlot = button.closest('.session-slot');
            const container = sessionSlot.parentElement;
            
            // Don't remove if it's the only session slot
            if (container.children.length > 1) {
                sessionSlot.remove();
            } else {
                showToast('At least one session slot is required per day', 'warning');
            }
        }

        function saveWeeklySchedule() {
            try {
                console.log('[WeeklySchedule][Chemistry] saveWeeklySchedule clicked');
                showToast('Saving weekly schedule...', 'info');
            } catch (e) { /* noop */ }

            const weekStartDateInput = document.getElementById('weekStartDate');
            const scheduleNameInput = document.getElementById('scheduleName');
            
            console.log('[WeeklySchedule][Chemistry] Form inputs found:', {
                weekStartDateInput: !!weekStartDateInput,
                scheduleNameInput: !!scheduleNameInput
            });
            
            if (!weekStartDateInput || !scheduleNameInput) {
                showToast('Weekly schedule form not found on page', 'error');
                console.error('[WeeklySchedule][Chemistry] Missing inputs weekStartDate or scheduleName');
                return;
            }
            
            const weekStartDate = weekStartDateInput.value;
            const scheduleName = scheduleNameInput.value;
            
            console.log('[WeeklySchedule][Chemistry] Form values:', {
                weekStartDate: weekStartDate,
                scheduleName: scheduleName
            });
            
            console.log('[WeeklySchedule][Chemistry] Schedule name input details:', {
                value: scheduleNameInput.value,
                placeholder: scheduleNameInput.placeholder,
                required: scheduleNameInput.required,
                disabled: scheduleNameInput.disabled,
                readOnly: scheduleNameInput.readOnly
            });
            
            // If schedule name is empty, set a default value
            if (!scheduleName) {
                console.log('[WeeklySchedule][Chemistry] Schedule name is empty, setting default value...');
                scheduleNameInput.value = `Chemistry Schedule - ${new Date(weekStartDate).toLocaleDateString()}`;
                console.log('[WeeklySchedule][Chemistry] After setting default value:', scheduleNameInput.value);
            }
            
            // Re-read the values after potential updates
            const finalWeekStartDate = weekStartDateInput.value;
            const finalScheduleName = scheduleNameInput.value;
            
            console.log('[WeeklySchedule][Chemistry] Final form values:', {
                weekStartDate: finalWeekStartDate,
                scheduleName: finalScheduleName
            });
            
            if (!finalWeekStartDate || !finalScheduleName) {
                showToast('Please fill in all required fields', 'error');
                console.warn('[WeeklySchedule][Chemistry] Missing required fields - weekStartDate:', finalWeekStartDate, 'scheduleName:', finalScheduleName);
                return;
            }

            const weeklySchedule = {
                id: Date.now().toString(),
                name: finalScheduleName,
                weekStartDate: finalWeekStartDate,
                createdAt: new Date().toISOString(),
                sessions: []
            };

            // Collect sessions for each day
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            
            console.log('[WeeklySchedule][Chemistry] Starting session collection...');
            
            days.forEach(day => {
                const daySlots = document.getElementById(`${day}-slots`);
                if (!daySlots) {
                    console.warn(`[WeeklySchedule][Chemistry] Missing day container: ${day}-slots`);
                    return;
                }
                const sessionSlots = daySlots.querySelectorAll('.session-slot');
                console.log(`[WeeklySchedule][Chemistry] Found ${sessionSlots.length} slots for ${day}`);
                if (!sessionSlots || sessionSlots.length === 0) {
                    console.log(`[WeeklySchedule][Chemistry] No slots found for ${day}`);
                }

                sessionSlots.forEach(slot => {
                    const nameInput = slot.querySelector(`input[name="${day}-name"]`);
                    const timeInput = slot.querySelector(`input[name="${day}-time"]`);
                    const typeSelect = slot.querySelector(`select[name="${day}-type"]`);
                    
                    if (nameInput.value.trim() && timeInput.value && typeSelect.value) {
                        weeklySchedule.sessions.push({
                            day: day,
                            name: nameInput.value.trim(),
                            time: timeInput.value,
                            type: typeSelect.value
                        });
                    } else {
                        console.log(`[WeeklySchedule][Chemistry] Skipped incomplete slot for ${day}`, {
                            name: nameInput && nameInput.value,
                            time: timeInput && timeInput.value,
                            type: typeSelect && typeSelect.value
                        });
                    }
                });
            });

            console.log('[WeeklySchedule][Chemistry] Total sessions collected:', weeklySchedule.sessions.length);
            
            if (weeklySchedule.sessions.length === 0) {
                showToast('Please add at least one session (with name, time, and type).', 'warning');
                console.warn('[WeeklySchedule][Chemistry] No valid sessions found to save');
                return;
            }

            // Save to localStorage
            const existingSchedules = JSON.parse(localStorage.getItem('ChemistryWeeklySchedules') || '[]');
            existingSchedules.push(weeklySchedule);
            localStorage.setItem('ChemistryWeeklySchedules', JSON.stringify(existingSchedules));
            console.log(`[WeeklySchedule][Chemistry] Saved weekly template id=${weeklySchedule.id} with ${weeklySchedule.sessions.length} sessions`);

            // Generate individual sessions for the next 4 weeks
            generateWeeklySessions(weeklySchedule);

            // Render weekly overview for the selected week
            renderWeeklyOverview(new Date(weeklySchedule.weekStartDate), weeklySchedule.sessions);

            // Close modal and reset form
            const modalEl = document.getElementById('weeklyScheduleModal');
            const modal = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;
            if (modal) modal.hide();
            const formEl = document.getElementById('weeklyScheduleForm');
            if (formEl) formEl.reset();

            showToast('Weekly schedule saved successfully!', 'success');
        }

        function generateWeeklySessions(weeklySchedule) {
            const weekStart = new Date(weeklySchedule.weekStartDate);
            const generatedSessions = [];
            const generatedStudent = [];

            // Generate sessions for 4 weeks
            for (let week = 0; week < 4; week++) {
                weeklySchedule.sessions.forEach(session => {
                    const sessionDate = new Date(weekStart);
                    sessionDate.setDate(weekStart.getDate() + (week * 7) + getDayOffset(session.day));
                    
                    const sessionData = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        title: session.name,
                        type: session.type,
                        date: sessionDate.toISOString().split('T')[0],
                        time: session.time,
                        duration: 60, // Default duration
                        maxStudents: 30, // Default max students
                        description: `Weekly ${session.type} session`,
                        location: 'Classroom',
                        isRecurring: true,
                        weeklyScheduleId: weeklySchedule.id,
                        createdAt: new Date().toISOString()
                    };

                    generatedSessions.push(sessionData);
                    // Store student-facing schedule entries
                    generatedStudent.push(sessionData);
                });
            }

            // Add to existing sessions
            const existingSessions = JSON.parse(localStorage.getItem('ChemistrySessionSchedules') || '[]');
            const updatedSessions = [...existingSessions, ...generatedSessions];
            localStorage.setItem('ChemistrySessionSchedules', JSON.stringify(updatedSessions));

            // Store to student-facing schedule key for Chemistry dashboard
            const existingStudent = JSON.parse(localStorage.getItem('ChemistryStudentSchedule') || '[]');
            const updatedStudent = [...existingStudent, ...generatedStudent];
            localStorage.setItem('ChemistryStudentSchedule', JSON.stringify(updatedStudent));
            console.log(`[WeeklySchedule][Chemistry] Wrote ${generatedStudent.length} entries to ChemistryStudentSchedule (total: ${updatedStudent.length})`);

            // Reload sessions display
            loadSessionSchedules();
            updateSessionStats();
        }

        function getDayOffset(day) {
            const dayMap = {
                'sunday': 0,
                'monday': 1,
                'tuesday': 2,
                'wednesday': 3,
                'thursday': 4,
                'friday': 5,
                'saturday': 6
            };
            return dayMap[day] || 0;
        }

        function renderWeeklyOverview(weekStartDateObj, templateSessions) {
            const overviewContainer = document.getElementById('weeklyOverview');
            const rangeEl = document.getElementById('weeklyOverviewRange');
            if (!overviewContainer || !rangeEl) return;

            const start = new Date(weekStartDateObj);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            rangeEl.textContent = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;

            const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const sessionsByDay = { sunday: [], monday: [], tuesday: [], wednesday: [], thursday: [], friday: [], saturday: [] };
            (templateSessions || []).forEach(s => { sessionsByDay[s.day]?.push(s); });

            let html = '';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(start); dayDate.setDate(start.getDate() + i);
                const key = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][i];
                const sessions = sessionsByDay[key] || [];

                html += `
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="mb-2">${dayNames[i]} <small class="text-muted">${dayDate.toLocaleDateString()}</small></h6>
                                ${sessions.length === 0 ? `<p class=\"text-muted mb-0\">No session</p>` : sessions.map(s => `
                                    <div class=\"border rounded p-2 mb-2\">
                                        <div class=\"d-flex justify-content-between\">
                                            <strong>${s.name}</strong>
                                            <span class=\"badge bg-light text-dark text-capitalize\">${s.type}</span>
                                        </div>
                                        <small class=\"text-muted\">${s.time}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }

            overviewContainer.innerHTML = html;
        }

        // Expose weekly schedule functions globally for inline onclick handlers
        window.openWeeklyScheduleModal = openWeeklyScheduleModal;
        window.saveWeeklySchedule = saveWeeklySchedule;
        window.addSessionSlot = addSessionSlot;
        window.removeSessionSlot = removeSessionSlot;

        // Show profile menu
        function showProfileMenu() {
            showToast('Profile menu coming soon', 'info');
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('ChemistryAssessments', JSON.stringify(assessments));
            localStorage.setItem('ChemistrySubmissions', JSON.stringify(submissions));
        }

        // Grading System Functions
        let currentGradingTab = 'assignments';
        let pendingSubmissions = [];

        function switchGradingTab(tabName) {
            // Remove active class from all grading tabs
            document.querySelectorAll('.grading-tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected tab
            event.target.classList.add('active');
            currentGradingTab = tabName;
            
            // Load grading content
            loadGradingContent();
        }

        function loadGradingContent() {
            const container = document.getElementById('gradingContainer');
            
            // Load pending submissions from localStorage
            loadPendingSubmissions();
            
            // Filter submissions by current tab
            const filteredSubmissions = pendingSubmissions.filter(sub => {
                if (currentGradingTab === 'assignments') return sub.type === 'assignment';
                if (currentGradingTab === 'quizzes') return sub.type === 'quiz';
                if (currentGradingTab === 'exams') return sub.type === 'exam';
                return true;
            });

            if (filteredSubmissions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <iconify-icon icon="material-symbols:grading" style="font-size: 4rem; color: #ccc;"></iconify-icon>
                        <h4 class="mt-3 text-muted">No ${currentGradingTab} to grade</h4>
                        <p class="text-muted">All ${currentGradingTab} have been graded or no submissions yet.</p>
                    </div>
                `;
                return;
            }

            // Render submissions
            container.innerHTML = filteredSubmissions.map(submission => `
                <div class="submission-card mb-4">
                    <div class="submission-header">
                        <div class="submission-info">
                            <h5>${submission.assignmentTitle}</h5>
                            <div class="submission-meta">
                                <span class="student-name">
                                    <iconify-icon icon="material-symbols:person"></iconify-icon>
                                    ${submission.studentName}
                                </span>
                                <span class="submission-date">
                                    <iconify-icon icon="material-symbols:schedule"></iconify-icon>
                                    ${new Date(submission.submittedAt).toLocaleDateString()}
                                </span>
                                <span class="submission-type">
                                    <iconify-icon icon="material-symbols:${submission.type === 'assignment' ? 'assignment' : submission.type === 'quiz' ? 'quiz' : 'school'}"></iconify-icon>
                                    ${submission.type.charAt(0).toUpperCase() + submission.type.slice(1)}
                                </span>
                            </div>
                        </div>
                        <div class="submission-actions">
                            <button class="btn btn-primary" onclick="openGradingModal('${submission.id}')">
                                <iconify-icon icon="material-symbols:grading"></iconify-icon>
                                Grade Submission
                            </button>
                        </div>
                    </div>
                    <div class="submission-details">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Total Points:</strong> ${submission.totalPoints || 'N/A'}
                            </div>
                            <div class="col-md-6">
                                <strong>Questions:</strong> ${submission.questions ? submission.questions.length : 0}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Update badge counts
            updateGradingBadges();
        }

        function loadPendingSubmissions() {
            // Load from localStorage - this would be populated when students submit assignments
            const storedSubmissions = localStorage.getItem('ChemistryPendingGrading');
            const allSubmissions = storedSubmissions ? JSON.parse(storedSubmissions) : [];
            
            // Filter out graded submissions (just in case any are still in pending queue)
            pendingSubmissions = allSubmissions.filter(sub => sub.status !== 'graded');
        }

        function updateGradingBadges() {
            const assignmentCount = pendingSubmissions.filter(s => s.type === 'assignment').length;
            const quizCount = pendingSubmissions.filter(s => s.type === 'quiz').length;
            const examCount = pendingSubmissions.filter(s => s.type === 'exam').length;

            document.getElementById('assignmentGradingCount').textContent = assignmentCount;
            document.getElementById('quizGradingCount').textContent = quizCount;
            document.getElementById('examGradingCount').textContent = examCount;
        }

        function openGradingModal(submissionId) {
            const submission = pendingSubmissions.find(s => s.id === submissionId);
            if (!submission) return;

            // Create grading modal
            const modalHtml = `
                <div class="modal fade" id="gradingModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Grade Submission: ${submission.assignmentTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6>Student: ${submission.studentName}</h6>
                                        <h6>Submitted: ${new Date(submission.submittedAt).toLocaleString()}</h6>
                                        
                                        <div class="questions-grading mt-4">
                                            ${submission.questions ? submission.questions.map((question, index) => `
                                                <div class="question-grading mb-4 p-3 border rounded">
                                                    <div class="question-header mb-3">
                                                        <h6>Question ${index + 1} (${question.points} points)</h6>
                                                        <p class="question-text">${question.text}</p>
                                                    </div>
                                                    
                                                    <div class="student-answer mb-3">
                                                        <strong>Student Answer:</strong>
                                                        <div class="answer-content p-2 bg-light rounded mt-2">
                                                            ${renderStudentAnswer(question, submission.answers ? submission.answers[index] : '')}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="grading-section">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Points Awarded</label>
                                                                <input type="number" class="form-control" id="points_${index}" 
                                                                       min="0" max="${question.points}" value="0">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Comments</label>
                                                                <textarea class="form-control" id="comments_${index}" 
                                                                          rows="2" placeholder="Add feedback..."></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('') : '<p>No questions found</p>'}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="grading-summary">
                                            <h6>Grading Summary</h6>
                                            <div class="grade-conversion">
                                                <div class="grade-letter" id="gradeLetter">-</div>
                                                <div class="grade-description">
                                                    <div>Total Points: <span id="totalPoints">0</span></div>
                                                    <div>Percentage: <span id="percentage">0%</span></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <label class="form-label">Overall Comments</label>
                                                <textarea class="form-control" id="overallComments" rows="4" 
                                                          placeholder="Overall feedback for the student..."></textarea>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <button class="btn btn-success w-100" onclick="submitGrade('${submissionId}')">
                                                    <iconify-icon icon="material-symbols:save"></iconify-icon>
                                                    Submit Grade
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('gradingModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('gradingModal'));
            modal.show();

            // Add event listeners for real-time grade calculation
            document.querySelectorAll('#gradingModal input[type="number"]').forEach(input => {
                input.addEventListener('input', calculateGrade);
            });
        }

        function renderStudentAnswer(question, answer) {
            if (!answer) return '<em>No answer provided</em>';
            
            if (question.type === 'multiple-choice') {
                const optionIndex = parseInt(answer);
                return question.options && question.options[optionIndex] ? 
                    question.options[optionIndex] : 'Invalid answer';
            } else if (question.type === 'bullet-points') {
                return Array.isArray(answer) ? 
                    `<ul>${answer.map(point => `<li>${point}</li>`).join('')}</ul>` : 
                    answer;
            } else {
                return answer;
            }
        }

        function calculateGrade() {
            const inputs = Array.from(document.querySelectorAll('#gradingModal input[type="number"]'));
            
            const totalPoints = inputs
                .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            
            const maxPoints = inputs
                .reduce((sum, input) => sum + parseInt(input.max), 0);
            
            const percentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
            const gradeLetter = convertToGrade(percentage);
            
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('percentage').textContent = percentage + '%';
            document.getElementById('gradeLetter').textContent = gradeLetter;
        }

        function convertToGrade(percentage) {
            if (percentage >= 90) return 'A*';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B';
            if (percentage >= 60) return 'C';
            if (percentage >= 50) return 'D';
            return 'F';
        }

        function submitGrade(submissionId) {
            const submission = pendingSubmissions.find(s => s.id === submissionId);
            if (!submission) return;

            // Collect grades
            const grades = [];
            const questions = submission.questions || [];
            
            questions.forEach((question, index) => {
                const pointsAwarded = parseInt(document.getElementById(`points_${index}`).value) || 0;
                const comments = document.getElementById(`comments_${index}`).value;
                
                grades.push({
                    questionIndex: index,
                    pointsAwarded: pointsAwarded,
                    maxPoints: question.points,
                    comments: comments
                });
            });

            // Calculate total grade
            const totalPoints = grades.reduce((sum, grade) => sum + grade.pointsAwarded, 0);
            const maxPoints = grades.reduce((sum, grade) => sum + grade.maxPoints, 0);
            const percentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
            const gradeLetter = convertToGrade(percentage);

            // Update submission
            submission.grading = grades;
            submission.totalGrade = totalPoints;
            submission.maxGrade = maxPoints;
            submission.percentage = percentage;
            submission.gradeLetter = gradeLetter;
            submission.overallComments = document.getElementById('overallComments').value;
            submission.gradedAt = new Date().toISOString();
            submission.status = 'graded';

            // Remove graded submission from pending submissions
            const submissionIndex = pendingSubmissions.findIndex(s => s.id === submissionId);
            if (submissionIndex !== -1) {
                pendingSubmissions.splice(submissionIndex, 1);
            }

            // Save updated pending submissions
            localStorage.setItem('ChemistryPendingGrading', JSON.stringify(pendingSubmissions));

            // Move graded submission to graded submissions
            const gradedSubmissions = JSON.parse(localStorage.getItem('ChemistryGradedSubmissions') || '[]');
            gradedSubmissions.push(submission);
            localStorage.setItem('ChemistryGradedSubmissions', JSON.stringify(gradedSubmissions));

            // Update the original assignment in ChemistryAssignments
            updateOriginalAssignment(submission);

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('gradingModal')).hide();

            // Reload grading content
            loadGradingContent();

            showToast('Grade submitted successfully!', 'success');
        }

        function updateOriginalAssignment(submission) {
            // Find and update the original assignment in ChemistryAssignments
            const assignments = JSON.parse(localStorage.getItem('ChemistryAssignments') || '[]');
            const assignmentIndex = assignments.findIndex(a => a.id === submission.assignmentId);
            
            console.log('Updating original assignment:', {
                assignmentId: submission.assignmentId,
                assignmentIndex: assignmentIndex,
                totalGrade: submission.totalGrade,
                maxGrade: submission.maxGrade
            });
            
            if (assignmentIndex !== -1) {
                assignments[assignmentIndex].grading = submission.grading;
                assignments[assignmentIndex].totalGrade = submission.totalGrade;
                assignments[assignmentIndex].maxGrade = submission.maxGrade;
                assignments[assignmentIndex].percentage = submission.percentage;
                assignments[assignmentIndex].gradeLetter = submission.gradeLetter;
                assignments[assignmentIndex].overallComments = submission.overallComments;
                assignments[assignmentIndex].gradedAt = submission.gradedAt;
                assignments[assignmentIndex].status = 'graded';
                
                // Update score fields for student interface
                assignments[assignmentIndex].score = submission.totalGrade;
                assignments[assignmentIndex].finalScore = submission.totalGrade;
                assignments[assignmentIndex].gradingStatus = 'graded';
                
                console.log('Updated assignment data:', assignments[assignmentIndex]);
                
                localStorage.setItem('ChemistryAssignments', JSON.stringify(assignments));
                console.log('Saved to ChemistryAssignments localStorage');
            } else {
                console.error('Assignment not found in ChemistryAssignments:', submission.assignmentId);
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-header">
                    <iconify-icon icon="material-symbols:${type === 'success' ? 'check-circle' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'}"></iconify-icon>
                    <strong class="ms-2">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Show assessment menu
        function showAssessmentMenu(assessmentId) {
            showToast('Assessment menu coming soon', 'info');
        }

        // Get mathematics page URL based on assessment type
        function getMathematicsPageUrl(type) {
            switch(type) {
                case 'assignment':
                    return 'mathematics-assignments.html';
                case 'quiz':
                    return 'mathematics-quizzes.html';
                case 'exam':
                    return 'mathematics-exams.html';
                default:
                    return 'mathematics-dashboard.html';
            }
        }

        // Sample data
        function getSampleAssessments() {
            return [];
        }

        function getSampleSubmissions() {
            return [
                {
                    id: '1',
                    assessmentId: '1',
                    assessmentTitle: 'Linear Equations Practice',
                    student: { name: 'John Smith', email: 'john@example.com' },
                    answers: ['x = 5', 'y = 2x + 3', 'System solution: (2, 7)'],
                    submittedAt: '2024-01-14T15:30:00Z',
                    status: 'pending',
                    grade: null,
                    maxGrade: 100,
                    comments: ''
                },
                {
                    id: '2',
                    assessmentId: '2',
                    assessmentTitle: 'Trigonometry Quiz',
                    student: { name: 'Sarah Johnson', email: 'sarah@example.com' },
                    answers: ['sin(30) = 0.5', 'cos(60) = 0.5'],
                    submittedAt: '2024-01-09T16:45:00Z',
                    status: 'graded',
                    grade: 50,
                    maxGrade: 50,
                    comments: 'Excellent work!'
                }
            ];
        }

        // Practice Questions Functions
        let practiceQuestions = [];
        let currentPracticeQuestionType = 'multiple-choice';
        let practiceFolders = [];

        // Debug: Log when the script loads
        console.log(' Practice Questions script loaded successfully');

        function loadPracticeQuestions() {
            const questionsData = localStorage.getItem('Chemistry_practice_questions');
            practiceQuestions = questionsData ? JSON.parse(questionsData) : [];
            console.log(' Loading practice questions for card:', practiceQuestions.length, 'questions');
            displayPracticeQuestions();
        }

        function displayPracticeQuestions() {
            const container = document.getElementById('practiceQuestionsPreview');
            console.log(' Displaying today\'s practice questions');
            
            // Check if container exists (card was removed from dashboard)
            if (!container) {
                console.log(' Practice questions card container not found (card removed from dashboard)');
                return;
            }
            
            // Get today's practice questions from localStorage
            const todayQuestions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            console.log(' Today\'s practice questions:', todayQuestions.length, 'questions');
            
            if (todayQuestions.length === 0) {
                console.log(' No today\'s practice questions found, showing empty state');
                container.innerHTML = `
                    <div class="text-center py-3">
                        <iconify-icon icon="material-symbols:today" style="font-size: 2rem; color: #6c757d;"></iconify-icon>
                        <p class="text-muted mt-2 mb-0">No practice questions for today</p>
                        <small class="text-muted">Create daily practice questions to see them here</small>
                    </div>
                `;
                return;
            }

            // Show preview of today's questions (max 3)
            const recentQuestions = todayQuestions.slice(-3);
            container.innerHTML = recentQuestions.map((question, index) => {
                const questionText = question.question || question.questionText || question.title || 'No question text';
                const questionType = question.type || 'unknown';
                const difficulty = question.difficulty || 'unknown';
                const actualIndex = todayQuestions.length - recentQuestions.length + index;
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div class="flex-grow-1">
                            <h6 class="mb-1" style="font-size: 0.9rem;">${questionText.substring(0, 50)}${questionText.length > 50 ? '...' : ''}</h6>
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary" style="font-size: 0.7rem;">${questionType}</span>
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">${difficulty}</span>
                                <span class="badge bg-info" style="font-size: 0.7rem;">${question.points || 0} pts</span>
                                <span class="badge bg-success" style="font-size: 0.7rem;">Today</span>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="editDailyQuestion(${actualIndex})" style="padding: 0.25rem 0.5rem;">
                                <iconify-icon icon="material-symbols:edit" style="font-size: 0.8rem;"></iconify-icon>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDailyQuestion(${actualIndex})" style="padding: 0.25rem 0.5rem;">
                                <iconify-icon icon="material-symbols:delete" style="font-size: 0.8rem;"></iconify-icon>
                            </button>
                        </div>
                    </div>
                `;
            }).join('') + `
                ${todayQuestions.length > 3 ? `
                    <div class="text-center mt-2">
                        <small class="text-muted">+${todayQuestions.length - 3} more today's questions</small>
                    </div>
                ` : ''}
            `;
        }

        function openPracticeQuestionModal() {
            const modal = new bootstrap.Modal(document.getElementById('practiceQuestionModal'));
            modal.show();
            loadPracticeQuestions();
            
            // Add event listener for view tab
            const viewTab = document.getElementById('view-tab');
            if (viewTab) {
                viewTab.addEventListener('shown.bs.tab', function() {
                    loadAllQuestions();
                });
            }
            
            // Refresh the card display when modal is closed
            modal._element.addEventListener('hidden.bs.modal', function() {
                console.log(' Practice modal closed, refreshing card display...');
                loadPracticeQuestions();
            });
        }

        function viewAllPracticeQuestions() {
            // Open modal and switch to view all questions tab
            openPracticeQuestionModal();
            // Switch to view tab after modal opens
            setTimeout(() => {
                const viewTab = document.getElementById('view-tab');
                if (viewTab) {
                    viewTab.click();
                    loadAllQuestions();
                }
            }, 100);
        }

        function loadAllQuestions() {
            const questionsData = localStorage.getItem('Chemistry_practice_questions');
            const questions = questionsData ? JSON.parse(questionsData) : [];
            const container = document.getElementById('allQuestionsList');
            
            console.log(' Loading all practice questions:', questions.length, 'questions');
            console.log(' Raw localStorage data:', questionsData);
            console.log(' Parsed questions:', questions);
            console.log(' Available folders:', practiceFolders.length);
            
            // Check if container exists
            if (!container) {
                console.log(' All questions list container not found');
                return;
            }
            
            // If no questions and no folders, show empty state
            if (questions.length === 0 && practiceFolders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <iconify-icon icon="material-symbols:quiz" style="font-size: 3rem; color: #6c757d;"></iconify-icon>
                        <p class="text-muted mt-3 mb-0">No practice questions found</p>
                        <small class="text-muted">Create some questions to see them here</small>
                    </div>
                `;
                return;
            }

            // Group questions by folder
            const questionsByFolder = {};
            questions.forEach(question => {
                const folderId = question.folderId || 'unorganized';
                if (!questionsByFolder[folderId]) {
                    questionsByFolder[folderId] = [];
                }
                questionsByFolder[folderId].push(question);
            });
            
            let html = '';
            
            // First, show all created folders (even if empty)
            practiceFolders.forEach(folder => {
                const folderQuestions = questionsByFolder[folder.id] || [];
                
                // Create folder header
                html += `
                    <div class="folder-header mb-3">
                        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
                            <div class="d-flex align-items-center">
                                <iconify-icon icon="material-symbols:folder" class="me-2"></iconify-icon>
                                <h6 class="mb-0">${folder.name}</h6>
                                <span class="badge bg-secondary ms-2">${folderQuestions.length} questions</span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="renameFolder('${folder.id}')" title="Rename Folder">
                                    <iconify-icon icon="material-symbols:edit"></iconify-icon>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteFolder('${folder.id}')" title="Delete Folder">
                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add questions in this folder
                if (folderQuestions.length > 0) {
                    folderQuestions.forEach((question, index) => {
                        const questionText = question.question || question.questionText || question.title || 'No question text';
                        const questionType = question.type || 'unknown';
                        const difficulty = question.difficulty || 'unknown';
                        const points = question.points || 0;
                        const topic = question.topic || 'No topic';
                        const createdAt = question.createdAt ? new Date(question.createdAt).toLocaleDateString() : 'Unknown date';
                        
                        html += `
                            <div class="question-item p-3 border rounded mb-2 ms-4" data-id="${question.id}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2">${questionText}</h6>
                                        <div class="d-flex gap-2 mb-2">
                                            <span class="badge bg-primary">${questionType}</span>
                                            <span class="badge bg-secondary">${difficulty}</span>
                                            <span class="badge bg-info">${points} pts</span>
                                            <span class="badge bg-success">${topic}</span>
                                        </div>
                                        <small class="text-muted">Created: ${createdAt}</small>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editAllQuestion('${question.id}')" title="Edit">
                                            <iconify-icon icon="material-symbols:edit"></iconify-icon>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAllQuestion('${question.id}')" title="Delete">
                                            <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Show empty folder message
                    html += `
                        <div class="text-center text-muted py-3 ms-4">
                            <iconify-icon icon="material-symbols:quiz" class="fs-4"></iconify-icon>
                            <p class="mb-0 mt-2">No questions in this folder yet</p>
                            <small>Create questions and assign them to this folder</small>
                        </div>
                    `;
                }
            });
            
            // Then show unorganized questions (if any)
            const unorganizedQuestions = questionsByFolder['unorganized'] || [];
            if (unorganizedQuestions.length > 0) {
                html += `
                    <div class="folder-header mb-3">
                        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
                            <div class="d-flex align-items-center">
                                <iconify-icon icon="material-symbols:folder-open" class="me-2"></iconify-icon>
                                <h6 class="mb-0">Unorganized</h6>
                                <span class="badge bg-warning ms-2">${unorganizedQuestions.length} questions</span>
                            </div>
                        </div>
                    </div>
                `;
                
                unorganizedQuestions.forEach((question, index) => {
                    const questionText = question.question || question.questionText || question.title || 'No question text';
                    const questionType = question.type || 'unknown';
                    const difficulty = question.difficulty || 'unknown';
                    const points = question.points || 0;
                    const topic = question.topic || 'No topic';
                    const createdAt = question.createdAt ? new Date(question.createdAt).toLocaleDateString() : 'Unknown date';
                    
                    html += `
                        <div class="question-item p-3 border rounded mb-2 ms-4" data-id="${question.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-2">${questionText}</h6>
                                    <div class="d-flex gap-2 mb-2">
                                        <span class="badge bg-primary">${questionType}</span>
                                        <span class="badge bg-secondary">${difficulty}</span>
                                        <span class="badge bg-info">${points} pts</span>
                                        <span class="badge bg-success">${topic}</span>
                                    </div>
                                    <small class="text-muted">Created: ${createdAt}</small>
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editAllQuestion('${question.id}')" title="Edit">
                                        <iconify-icon icon="material-symbols:edit"></iconify-icon>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAllQuestion('${question.id}')" title="Delete">
                                        <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function refreshAllQuestions() {
            console.log(' Manual refresh triggered for View All Questions');
            console.log(' Current localStorage content:', localStorage.getItem('Chemistry_practice_questions'));
            loadAllQuestions();
            showToast('Questions refreshed!', 'success');
        }

        function forceRefreshAllQuestions() {
            console.log(' Force refresh triggered for View All Questions');
            console.log(' Current practiceQuestions array:', practiceQuestions);
            console.log(' Current localStorage content:', localStorage.getItem('Chemistry_practice_questions'));
            
            // Force reload from localStorage
            const questionsData = localStorage.getItem('Chemistry_practice_questions');
            const questions = questionsData ? JSON.parse(questionsData) : [];
            console.log(' Parsed questions from localStorage:', questions);
            
            // Update the practiceQuestions array
            practiceQuestions = questions;
            console.log(' Updated practiceQuestions array:', practiceQuestions);
            
            loadAllQuestions();
            showToast('Force refresh completed!', 'success');
        }

        function syncToStudentDashboard() {
            console.log(' Syncing questions to student dashboard...');
            
            // Get questions from teacher localStorage
            const questionsData = localStorage.getItem('Chemistry_practice_questions');
            const questions = questionsData ? JSON.parse(questionsData) : [];
            
            console.log(' Questions to sync:', questions);
            
            // Save to student localStorage
            localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(questions));
            
            // Verify the sync
            const studentData = localStorage.getItem('Chemistry_daily_practice_questions_student');
            const studentQuestions = studentData ? JSON.parse(studentData) : [];
            
            console.log(' Student localStorage after sync:', studentQuestions);
            console.log(' Sync verification - Teacher questions:', questions.length, 'Student questions:', studentQuestions.length);
            
            if (questions.length === studentQuestions.length) {
                showToast(`Successfully synced ${questions.length} questions to student dashboard!`, 'success');
            } else {
                showToast('Sync completed but question counts do not match!', 'warning');
            }
        }

        function addTestQuestion() {
            console.log(' Adding test question...');
            
            const testQuestion = {
                id: 'test_' + Date.now(),
                question: 'Test Question - What is 2+2?',
                type: 'multiple-choice',
                difficulty: 'Easy',
                topic: 'Mathematics',
                points: 5,
                options: ['3', '4', '5', '6'],
                correctAnswer: 'B',
                createdAt: new Date().toISOString(),
                subject: 'Chemistry'
            };
            
            console.log(' Test question created:', testQuestion);
            
            // Add to practiceQuestions array
            practiceQuestions.push(testQuestion);
            console.log(' practiceQuestions array after adding test:', practiceQuestions);
            
            // Add to DOM
            addQuestionToList(testQuestion);
            
            // Save to localStorage
            localStorage.setItem('Chemistry_practice_questions', JSON.stringify(practiceQuestions));
            localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(practiceQuestions));
            
            console.log(' Test question saved to localStorage');
            
            // Refresh the view
            loadAllQuestions();
            
            showToast('Test question added!', 'success');
        }

        function fillFormAndTest() {
            console.log(' Filling form and testing...');
            
            // Fill the form fields
            const questionTextEl = document.getElementById('practiceQuestionText');
            const topicEl = document.getElementById('practiceQuestionTopic');
            const pointsEl = document.getElementById('practiceQuestionPoints');
            const difficultyEl = document.getElementById('practiceQuestionDifficulty');
            
            if (questionTextEl) {
                questionTextEl.value = 'Test Question - What is the speed of light?';
                console.log(' Set questionText to:', questionTextEl.value);
            }
            
            if (topicEl) {
                topicEl.value = 'Chemistry';
                console.log(' Set topic to:', topicEl.value);
            }
            
            if (pointsEl) {
                pointsEl.value = '15';
                console.log(' Set points to:', pointsEl.value);
            }
            
            if (difficultyEl) {
                difficultyEl.value = 'Hard';
                console.log(' Set difficulty to:', difficultyEl.value);
            }
            
            // Wait a moment then try to read the values
            setTimeout(() => {
                console.log(' After filling, reading values:');
                console.log(' questionText:', questionTextEl ? questionTextEl.value : 'NOT FOUND');
                console.log(' topic:', topicEl ? topicEl.value : 'NOT FOUND');
                console.log(' points:', pointsEl ? pointsEl.value : 'NOT FOUND');
                console.log(' difficulty:', difficultyEl ? difficultyEl.value : 'NOT FOUND');
                
                // Now try to add the question
                addPracticeQuestion();
            }, 500);
        }

        // Folder Management Functions
        function loadFolders() {
            const foldersData = localStorage.getItem('Chemistry_practice_folders');
            practiceFolders = foldersData ? JSON.parse(foldersData) : [];
            console.log(' Loaded folders:', practiceFolders.length);
            updateFolderDropdown();
        }

        function saveFolders() {
            localStorage.setItem('Chemistry_practice_folders', JSON.stringify(practiceFolders));
            console.log(' Saved folders:', practiceFolders.length);
        }

        function updateFolderDropdown() {
            const folderSelect = document.getElementById('practiceQuestionFolder');
            if (!folderSelect) return;

            // Clear existing options except the first one
            folderSelect.innerHTML = '<option value="">Select a folder...</option>';
            
            // Add folder options
            practiceFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                folderSelect.appendChild(option);
            });
        }

        function createNewFolder() {
            const folderName = prompt('Enter folder name:');
            if (!folderName || folderName.trim() === '') {
                showToast('Folder name cannot be empty', 'error');
                return;
            }

            const newFolder = {
                id: 'folder_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: folderName.trim(),
                createdAt: new Date().toISOString(),
                questionCount: 0
            };

            practiceFolders.push(newFolder);
            saveFolders();
            updateFolderDropdown();
            
            // Select the newly created folder
            const folderSelect = document.getElementById('practiceQuestionFolder');
            if (folderSelect) {
                folderSelect.value = newFolder.id;
            }

            showToast(`Folder "${folderName}" created successfully!`, 'success');
        }

        function deleteFolder(folderId) {
            if (!confirm('Are you sure you want to delete this folder? All questions in this folder will be moved to "Unorganized".')) {
                return;
            }

            // Move questions from this folder to unorganized
            practiceQuestions.forEach(question => {
                if (question.folderId === folderId) {
                    question.folderId = '';
                }
            });

            // Remove the folder
            practiceFolders = practiceFolders.filter(folder => folder.id !== folderId);
            saveFolders();
            updateFolderDropdown();
            
            // Save updated questions
            localStorage.setItem('Chemistry_practice_questions', JSON.stringify(practiceQuestions));
            localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(practiceQuestions));
            
            showToast('Folder deleted successfully!', 'success');
        }

        function renameFolder(folderId) {
            const folder = practiceFolders.find(f => f.id === folderId);
            if (!folder) return;

            const newName = prompt('Enter new folder name:', folder.name);
            if (!newName || newName.trim() === '') {
                showToast('Folder name cannot be empty', 'error');
                return;
            }

            folder.name = newName.trim();
            saveFolders();
            updateFolderDropdown();
            
            showToast(`Folder renamed to "${newName}"`, 'success');
        }

        function clearAllPracticeQuestions() {
            if (confirm('Are you sure you want to delete ALL practice questions? This action cannot be undone.')) {
                localStorage.removeItem('Chemistry_practice_questions');
                localStorage.removeItem('Chemistry_daily_practice_questions_student');
                practiceQuestions = [];
                loadAllQuestions();
                showToast('All practice questions cleared!', 'success');
            }
        }

        function editAllQuestion(questionId) {
            // Find the question and switch to create tab to edit
            const question = practiceQuestions.find(q => q.id === questionId);
            if (question) {
                // Switch to create tab
                const createTab = document.getElementById('create-tab');
                if (createTab) {
                    createTab.click();
                }
                // TODO: Load question data into form for editing
                showToast('Edit functionality coming soon!', 'info');
            }
        }

        function deleteAllQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                practiceQuestions = practiceQuestions.filter(q => q.id !== questionId);
                localStorage.setItem('Chemistry_practice_questions', JSON.stringify(practiceQuestions));
                localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(practiceQuestions));
                loadAllQuestions();
                showToast('Question deleted successfully!', 'success');
            }
        }

        function selectPracticeQuestionType(type) {
            currentPracticeQuestionType = type;
            document.querySelectorAll('.question-type').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.question-type').classList.add('active');
            
            // Show/hide appropriate answer options
            document.querySelectorAll('.answer-options').forEach(option => option.style.display = 'none');
            
            switch(type) {
                case 'multiple-choice':
                    document.getElementById('practiceMultipleChoiceOptions').style.display = 'block';
                    break;
                case 'short-answer':
                    document.getElementById('practiceShortAnswerOptions').style.display = 'block';
                    break;
                case 'file-based':
                    document.getElementById('practiceFileBasedOptions').style.display = 'block';
                    break;
                case 'bullet-points':
                    document.getElementById('practiceBulletPointsOptions').style.display = 'block';
                    break;
            }
        }

        function addPracticeOption() {
            const container = document.getElementById('practiceMultipleChoiceList');
            const optionCount = container.children.length;
            const optionLetter = String.fromCharCode(65 + optionCount);
            
            const optionHtml = `
                <div class="d-flex align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Option ${optionLetter}">
                    <input type="radio" name="practiceCorrectAnswer" value="${optionLetter}" class="me-2">
                    <label class="form-label mb-0">Correct</label>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removePracticeOption(this)">
                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        function removePracticeOption(button) {
            button.closest('.d-flex').remove();
        }

        function addPracticeBulletPoint() {
            const container = document.getElementById('practiceBulletPointsList');
            const pointCount = container.children.length + 1;
            
            const pointHtml = `
                <div class="d-flex align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Bullet point ${pointCount}">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePracticeBulletPoint(this)">
                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', pointHtml);
        }

        function removePracticeBulletPoint(button) {
            button.closest('.d-flex').remove();
        }

        function addPracticeQuestion() {
            console.log(' addPracticeQuestion called');
            
            // Check if form elements exist
            const questionTextEl = document.getElementById('practiceQuestionText');
            const topicEl = document.getElementById('practiceQuestionTopic');
            const pointsEl = document.getElementById('practiceQuestionPoints');
            const difficultyEl = document.getElementById('practiceQuestionDifficulty');
            const timeLimitEl = document.getElementById('practiceTimeLimit');
            const explanationEl = document.getElementById('practiceQuestionExplanation');
            
            console.log(' Form elements found:', {
                questionTextEl: !!questionTextEl,
                topicEl: !!topicEl,
                pointsEl: !!pointsEl,
                difficultyEl: !!difficultyEl,
                timeLimitEl: !!timeLimitEl,
                explanationEl: !!explanationEl
            });
            
            // Check if elements are visible and accessible
            if (questionTextEl) {
                console.log(' questionTextEl details:', {
                    value: questionTextEl.value,
                    visible: questionTextEl.offsetParent !== null,
                    display: window.getComputedStyle(questionTextEl).display,
                    parentVisible: questionTextEl.parentElement ? questionTextEl.parentElement.offsetParent !== null : 'no parent'
                });
            }
            
            if (topicEl) {
                console.log(' topicEl details:', {
                    value: topicEl.value,
                    visible: topicEl.offsetParent !== null,
                    display: window.getComputedStyle(topicEl).display,
                    parentVisible: topicEl.parentElement ? topicEl.parentElement.offsetParent !== null : 'no parent'
                });
            }
            
            const questionText = questionTextEl ? questionTextEl.value : '';
            const points = pointsEl ? parseInt(pointsEl.value) : 10;
            const difficulty = difficultyEl ? difficultyEl.value : 'Medium';
            const topic = topicEl ? topicEl.value : '';
            const timeLimit = timeLimitEl ? timeLimitEl.value : '';
            const explanation = explanationEl ? explanationEl.value : '';
            const folderId = document.getElementById('practiceQuestionFolder') ? document.getElementById('practiceQuestionFolder').value : '';
            
            console.log(' Form data:', { questionText, points, difficulty, topic, timeLimit, explanation });
            console.log(' Raw values:', {
                questionTextRaw: questionTextEl ? questionTextEl.value : 'ELEMENT NOT FOUND',
                topicRaw: topicEl ? topicEl.value : 'ELEMENT NOT FOUND'
            });
            
            // Add a small delay to check if values change
            setTimeout(() => {
                console.log(' Form data after 100ms delay:', {
                    questionText: questionTextEl ? questionTextEl.value : 'ELEMENT NOT FOUND',
                    topic: topicEl ? topicEl.value : 'ELEMENT NOT FOUND'
                });
            }, 100);
            
            if (!questionText || !topic) {
                showToast('Please fill in question content and topic', 'error');
                return;
            }
            
            const question = {
                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                question: questionText,
                type: currentPracticeQuestionType,
                difficulty: difficulty,
                topic: topic,
                points: points,
                timeLimit: timeLimit ? parseInt(timeLimit) : null,
                explanation: explanation,
                folderId: folderId,
                createdAt: new Date().toISOString(),
                subject: 'Chemistry'
            };
            
            console.log(' Created question object:', question);
            
            // Add type-specific data
            if (currentPracticeQuestionType === 'multiple-choice') {
                const options = [];
                const optionInputs = document.querySelectorAll('#practiceMultipleChoiceList input[type="text"]');
                optionInputs.forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                
                const correctAnswer = document.querySelector('input[name="practiceCorrectAnswer"]:checked');
                if (!correctAnswer || options.length < 2) {
                    showToast('Please provide at least 2 options and select the correct answer', 'error');
                    return;
                }
                
                question.options = options;
                question.correctAnswer = correctAnswer.value;
            } else if (currentPracticeQuestionType === 'short-answer') {
                const expectedAnswer = document.getElementById('practiceExpectedAnswer').value;
                if (!expectedAnswer.trim()) {
                    showToast('Please provide an expected answer', 'error');
                    return;
                }
                question.expectedAnswer = expectedAnswer;
            } else if (currentPracticeQuestionType === 'file-based') {
                const allowedTypes = Array.from(document.getElementById('practiceAllowedFileTypes').selectedOptions).map(option => option.value);
                const maxSize = parseInt(document.getElementById('practiceMaxFileSize').value);
                
                question.fileUploadSettings = {
                    allowedTypes: allowedTypes,
                    maxSize: maxSize
                };
            } else if (currentPracticeQuestionType === 'bullet-points') {
                const bulletPoints = [];
                const bulletInputs = document.querySelectorAll('#practiceBulletPointsList input[type="text"]');
                bulletInputs.forEach(input => {
                    if (input.value.trim()) {
                        bulletPoints.push(input.value.trim());
                    }
                });
                
                if (bulletPoints.length === 0) {
                    showToast('Please provide at least one bullet point', 'error');
                    return;
                }
                
                question.bulletPoints = bulletPoints;
            }
            
            // Add to questions list
            console.log(' Adding question to list:', question);
            console.log(' practiceQuestions array before adding:', practiceQuestions);
            addQuestionToList(question);
            console.log(' practiceQuestions array after adding:', practiceQuestions);
            
            // Save to localStorage immediately after adding
            localStorage.setItem('Chemistry_practice_questions', JSON.stringify(practiceQuestions));
            localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(practiceQuestions));
            console.log(' Auto-saved to localStorage:', practiceQuestions.length, 'questions');
            
            // Clear form
            clearPracticeQuestionForm();
            
            console.log(' Current practiceQuestions array after adding:', practiceQuestions);
            showToast('Question added successfully!', 'success');
        }

        function addQuestionToList(question) {
            const container = document.getElementById('practiceQuestionsList');
            const questionHtml = `
                <div class="question-item p-3 border rounded mb-2" data-id="${question.id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${question.question}</h6>
                            <div class="d-flex gap-2 mb-2">
                                <span class="badge bg-primary">${question.type}</span>
                                <span class="badge bg-secondary">${question.difficulty}</span>
                                <span class="badge bg-info">${question.points} pts</span>
                                <span class="badge bg-success">${question.topic}</span>
                            </div>
                            <small class="text-muted">Created: ${new Date(question.createdAt).toLocaleString()}</small>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="editPracticeQuestionFromList('${question.id}')">
                                <iconify-icon icon="material-symbols:edit"></iconify-icon>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removePracticeQuestionFromList('${question.id}')">
                                <iconify-icon icon="material-symbols:delete"></iconify-icon>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', questionHtml);
            
            // Also add to practiceQuestions array for saving
            practiceQuestions.push(question);
            console.log(' Added question to practiceQuestions array. New length:', practiceQuestions.length);
            console.log(' practiceQuestions array contents:', practiceQuestions);
            
            // Refresh View All Questions tab if it's currently active
            const viewTab = document.getElementById('view-tab');
            const viewPane = document.getElementById('view-pane');
            if (viewTab && viewPane && viewPane.classList.contains('active')) {
                console.log(' Refreshing View All Questions tab after adding question...');
                loadAllQuestions();
            }
        }

        function clearPracticeQuestionForm() {
            document.getElementById('practiceQuestionForm').reset();
            document.getElementById('practiceQuestionPoints').value = 10;
            document.getElementById('practiceQuestionDifficulty').value = 'Medium';
            
            // Reset answer options
            document.querySelectorAll('.answer-options').forEach(option => option.style.display = 'none');
            document.getElementById('practiceMultipleChoiceOptions').style.display = 'block';
            
            // Reset multiple choice options
            const container = document.getElementById('practiceMultipleChoiceList');
            container.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Option A">
                    <input type="radio" name="practiceCorrectAnswer" value="A" class="me-2">
                    <label class="form-label mb-0">Correct</label>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Option B">
                    <input type="radio" name="practiceCorrectAnswer" value="B" class="me-2">
                    <label class="form-label mb-0">Correct</label>
                </div>
            `;
            
            // Reset bullet points
            const bulletContainer = document.getElementById('practiceBulletPointsList');
            bulletContainer.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <input type="text" class="form-control me-2" placeholder="Bullet point 1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePracticeBulletPoint(this)">
                        <iconify-icon icon="material-symbols:close"></iconify-icon>
                    </button>
                </div>
            `;
        }

        function savePracticeQuestion() {
            console.log(' Save Question button clicked - savePracticeQuestion function called');
            
            // Check if there's any question data to save
            const questionTextEl = document.getElementById('practiceQuestionText');
            const topicEl = document.getElementById('practiceQuestionTopic');
            
            console.log(' Form validation check:');
            console.log('  - questionTextEl exists:', !!questionTextEl);
            console.log('  - questionTextEl value:', questionTextEl ? questionTextEl.value : 'N/A');
            console.log('  - topicEl exists:', !!topicEl);
            console.log('  - topicEl value:', topicEl ? topicEl.value : 'N/A');
            
            if (!questionTextEl || !questionTextEl.value.trim()) {
                console.warn(' Validation failed: No question text');
                showToast('Please fill in the question content before saving', 'warning');
                return;
            }
            
            if (!topicEl || !topicEl.value.trim()) {
                console.warn(' Validation failed: No topic');
                showToast('Please fill in the topic before saving', 'warning');
                return;
            }
            
            console.log(' Validation passed, calling addPracticeQuestion()');
            
            // Add the question using the addPracticeQuestion function
            try {
                addPracticeQuestion();
                console.log(' Question saved successfully - addPracticeQuestion completed');
            } catch (error) {
                console.error(' Error saving question:', error);
                console.error(' Error stack:', error.stack);
                showToast('Error saving question: ' + error.message, 'error');
            }
        }
        
        // Make function globally accessible
        window.savePracticeQuestion = savePracticeQuestion;

        function saveAllPracticeQuestions() {
            console.log(' Saving all practice questions...');
            const questionElements = document.querySelectorAll('#practiceQuestionsList .question-item');
            console.log(' Found question elements:', questionElements.length);
            if (questionElements.length === 0) {
                showToast('No questions to save', 'warning');
                return;
            }
            
            // Get all questions from the list by extracting data from DOM elements
            const questions = [];
            questionElements.forEach((element, index) => {
                const questionId = element.dataset.id;
                console.log(' Processing question element:', questionId);
                
                // Extract question data from the DOM element
                const questionText = element.querySelector('h6').textContent;
                const badges = element.querySelectorAll('.badge');
                const type = badges[0]?.textContent || 'unknown';
                const difficulty = badges[1]?.textContent || 'unknown';
                const points = parseInt(badges[2]?.textContent?.replace(' pts', '') || '0');
                const topic = badges[3]?.textContent || 'unknown';
                const createdAt = element.querySelector('small')?.textContent?.replace('Created: ', '') || new Date().toISOString();
                
                // Try to find the original question data from practiceQuestions array
                let question = practiceQuestions.find(q => q.id === questionId);
                
                // If not found, create a basic question object
                if (!question) {
                    console.log(' Question not found in practiceQuestions array, creating from DOM data:', questionId);
                    question = {
                        id: questionId,
                        question: questionText,
                        type: type,
                        difficulty: difficulty,
                        topic: topic,
                        points: points,
                        createdAt: createdAt,
                        subject: 'Chemistry'
                    };
                }
                
                console.log(' Question to save:', question);
                questions.push(question);
            });
            
            console.log(' Questions to save:', questions.length);
            console.log(' Questions data:', questions);
            
            // Save to localStorage
            localStorage.setItem('Chemistry_practice_questions', JSON.stringify(questions));
            practiceQuestions = questions;
            
            // Also save to student-facing localStorage for the student dashboard
            localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(questions));
            
            console.log(' Saved to localStorage:', JSON.stringify(questions));
            console.log(' Saved to student localStorage:', JSON.stringify(questions));
            console.log(' Verification - reading back from localStorage:', localStorage.getItem('Chemistry_practice_questions'));
            console.log(' Verification - reading back from student localStorage:', localStorage.getItem('Chemistry_daily_practice_questions_student'));
            
            showToast(`Successfully saved ${questions.length} practice questions!`, 'success');
            
            // Refresh card display
            loadPracticeQuestions();
            
            // Also refresh the View All Questions tab if it's currently active
            const viewTab = document.getElementById('view-tab');
            const viewPane = document.getElementById('view-pane');
            if (viewTab && viewPane && viewPane.classList.contains('active')) {
                console.log(' Refreshing View All Questions tab...');
                loadAllQuestions();
            }
            
            console.log(' Save completed successfully');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('practiceQuestionModal'));
            modal.hide();
        }

        function editPracticeQuestion(index) {
            openPracticeQuestionModal();
            // TODO: Load question data for editing
        }

        function deletePracticeQuestion(index) {
            if (confirm('Are you sure you want to delete this practice question?')) {
                practiceQuestions.splice(index, 1);
                localStorage.setItem('Chemistry_practice_questions', JSON.stringify(practiceQuestions));
                displayPracticeQuestions();
                showToast('Practice question deleted successfully', 'success');
            }
        }

        function editPracticeQuestionFromList(questionId) {
            // TODO: Load question data for editing
            showToast('Edit functionality coming soon', 'info');
        }

        function removePracticeQuestionFromList(questionId) {
            if (confirm('Are you sure you want to remove this question?')) {
                document.querySelector(`[data-id="${questionId}"]`).remove();
                
                // Also remove from practiceQuestions array
                practiceQuestions = practiceQuestions.filter(q => q.id !== questionId);
                
                // Refresh View All Questions tab if it's currently active
                const viewTab = document.getElementById('view-tab');
                const viewPane = document.getElementById('view-pane');
                if (viewTab && viewPane && viewPane.classList.contains('active')) {
                    console.log(' Refreshing View All Questions tab after removing question...');
                    loadAllQuestions();
                }
                
                showToast('Question removed from list', 'success');
            }
        }

        // Live Sessions Functions
        function loadLiveSessions() {
            const sessionsData = localStorage.getItem('ChemistryLiveSessions');
            const liveSessions = sessionsData ? JSON.parse(sessionsData) : [];
            console.log(' Loading live sessions for card:', liveSessions.length, 'sessions');
            displayLiveSessions(liveSessions);
        }

        function displayLiveSessions(sessions) {
            const container = document.getElementById('liveSessionsPreview');
            console.log(' Displaying live sessions:', sessions.length, 'sessions');
            
            // Check if container exists (card was removed from dashboard)
            if (!container) {
                console.log(' Live sessions card container not found (card removed from dashboard)');
                return;
            }
            
            if (sessions.length === 0) {
                console.log(' No live sessions found, showing empty state');
                container.innerHTML = `
                    <div class="text-center py-3">
                        <iconify-icon icon="material-symbols:video-call" style="font-size: 2rem; color: #6c757d;"></iconify-icon>
                        <p class="text-muted mt-2 mb-0">No live sessions yet</p>
                        <small class="text-muted">Click "Start Session" to get started</small>
                    </div>
                `;
                return;
            }

            // Show preview of recent sessions (max 3)
            const recentSessions = sessions.slice(-3);
            container.innerHTML = recentSessions.map((session, index) => {
                const actualIndex = sessions.length - recentSessions.length + index;
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div class="flex-grow-1">
                            <h6 class="mb-1" style="font-size: 0.9rem;">${session.title}</h6>
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary" style="font-size: 0.7rem;">${session.topic}</span>
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">${session.duration}min</span>
                                <span class="badge bg-info" style="font-size: 0.7rem;">${session.status}</span>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="joinLiveSession('${session.meetingId}')" style="padding: 0.25rem 0.5rem;">
                                <iconify-icon icon="material-symbols:video-call" style="font-size: 0.8rem;"></iconify-icon>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLiveSession(${actualIndex})" style="padding: 0.25rem 0.5rem;">
                                <iconify-icon icon="material-symbols:delete" style="font-size: 0.8rem;"></iconify-icon>
                            </button>
                        </div>
                    </div>
                `;
            }).join('') + `
                ${sessions.length > 3 ? `
                    <div class="text-center mt-2">
                        <small class="text-muted">+${sessions.length - 3} more sessions</small>
                    </div>
                ` : ''}
            `;
        }

        function viewAllLiveSessions() {
            // Open modal and show all sessions
            openLiveSessionModal();
        }

        function joinLiveSession(meetingId) {
            showToast(`Joining session ${meetingId}...`, 'info');
            // TODO: Implement actual join functionality
        }

        function deleteLiveSession(index) {
            if (confirm('Are you sure you want to delete this live session?')) {
                let sessions = JSON.parse(localStorage.getItem('ChemistryLiveSessions') || '[]');
                sessions.splice(index, 1);
                localStorage.setItem('ChemistryLiveSessions', JSON.stringify(sessions));
                displayLiveSessions(sessions);
                showToast('Live session deleted successfully', 'success');
            }
        }

        // Open Live Session Modal
        function openLiveSessionModal() {
            const modal = new bootstrap.Modal(document.getElementById('liveSessionModal'));
            modal.show();
        }

        // Test API connectivity
        async function testAPIConnectivity() {
            try {
                console.log('Testing API connectivity...');
                const response = await fetch('/api/zoom/test');
                const result = await response.json();
                console.log('API test result:', result);
                return result.success;
            } catch (error) {
                console.error('API connectivity test failed:', error);
                return false;
            }
        }

        // Create Live Session - Now with Real Zoom API Integration
        async function createLiveSession() {
            const title = document.getElementById('sessionTitle').value;
            const topic = document.getElementById('sessionTopic').value;
            const description = document.getElementById('sessionDescription').value;
            const duration = document.getElementById('sessionDuration').value;
            const maxParticipants = document.getElementById('maxParticipants').value;
            const recordSession = document.getElementById('recordSession').checked;

            if (!title || !topic) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            // Show loading state
            const createButton = document.querySelector('#liveSessionModal .btn-primary');
            const originalText = createButton.innerHTML;
            createButton.innerHTML = '<iconify-icon icon="eos-icons:loading"></iconify-icon> Creating Meeting...';
            createButton.disabled = true;

            try {
                // Test API connectivity first
                const isAPIAvailable = await testAPIConnectivity();
                if (!isAPIAvailable) {
                    console.log('API not available, creating simulated meeting...');
                    createSimulatedMeeting(title, topic, description, duration, maxParticipants, recordSession);
                    return;
                }

                // Call backend API to create real Zoom meeting
                console.log('Attempting to create Zoom meeting...');
                const response = await fetch('/api/zoom/create-meeting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'demo-token'}`
                    },
                    body: JSON.stringify({
                        title: title,
                        topic: topic,
                        description: description,
                        duration: parseInt(duration),
                        maxParticipants: parseInt(maxParticipants),
                        recordSession: recordSession,
                        subject: 'Chemistry'
                    })
                });

                console.log('API Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('API Response data:', result);

                if (result.success) {
                    const session = result.meeting;
                    
                    // Save to localStorage for immediate display
                    let sessions = JSON.parse(localStorage.getItem('ChemistryLiveSessions')) || [];
                    sessions.push(session);
                    localStorage.setItem('ChemistryLiveSessions', JSON.stringify(sessions));

                    // Show success message with meeting details
                    const successMessage = ` Live Session Created Successfully!\n\nMeeting ID: ${session.meetingId}\nPassword: ${session.meetingPassword}\n\nMeeting URL: ${session.meetingUrl}\n\nStart URL: ${session.startUrl}\n\nYou can now share these details with your students.`;
                    alert(successMessage);

                    // Reset form
                    document.getElementById('liveSessionForm').reset();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('liveSessionModal'));
                    modal.hide();

                    showToast('Real Zoom meeting created successfully!', 'success');

                    // Optionally open the meeting start URL
                    const openMeeting = confirm('Would you like to open the Zoom meeting now?');
                    if (openMeeting) {
                        // Try to open Zoom app first
                        const zoomUrl = `zoommtg://zoom.us/join?confno=${session.meetingId}&pwd=${session.meetingPassword}`;
                        window.open(zoomUrl, '_blank');
                        
                        // Fallback to web version after a delay
                        setTimeout(() => {
                            const webChoice = confirm('Zoom app not detected. Would you like to open the web version?');
                            if (webChoice) {
                                window.open(session.startUrl, '_blank');
                            }
                        }, 2000);
                    }

                } else {
                    showToast('Error creating meeting: ' + result.error, 'error');
                    console.error('Meeting creation failed:', result);
                }

            } catch (error) {
                console.error('Error creating Zoom meeting:', error);
                
                // More specific error handling
                let errorMessage = 'Failed to create meeting. ';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'Unable to connect to the server. ';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage += 'Server error occurred. ';
                } else {
                    errorMessage += 'An unexpected error occurred. ';
                }
                errorMessage += 'Creating a simulated meeting for testing...';
                
                showToast(errorMessage, 'warning');
                
                // Automatically create simulated meeting instead of asking
                createSimulatedMeeting(title, topic, description, duration, maxParticipants, recordSession);
            } finally {
                // Reset button state
                createButton.innerHTML = originalText;
                createButton.disabled = false;
            }
        }

        // Fallback function for simulated meetings
        function createSimulatedMeeting(title, topic, description, duration, maxParticipants, recordSession) {
            const meetingId = Math.floor(Math.random() * 9000000000) + 1000000000;
            const meetingPassword = Math.random().toString(36).substring(2, 8).toUpperCase();
            const meetingUrl = `https://zoom.us/j/${meetingId}?pwd=${meetingPassword}`;

            const session = {
                id: Date.now(),
                title: title,
                topic: topic,
                description: description,
                duration: parseInt(duration),
                maxParticipants: parseInt(maxParticipants),
                recordSession: recordSession,
                meetingId: meetingId,
                meetingPassword: meetingPassword,
                meetingUrl: meetingUrl,
                startUrl: `https://zoom.us/s/${meetingId}`,
                instructor: 'Dr. Alex Rodriguez',
                subject: 'Chemistry',
                status: 'live',
                startTime: new Date().toISOString(),
                participants: 0,
                messages: 0
            };

            let sessions = JSON.parse(localStorage.getItem('ChemistryLiveSessions')) || [];
            sessions.push(session);
            localStorage.setItem('ChemistryLiveSessions', JSON.stringify(sessions));

            const successMessage = ` Simulated Live Session Created!\n\nMeeting ID: ${meetingId}\nPassword: ${meetingPassword}\n\nMeeting URL: ${meetingUrl}\n\nNote: This is a simulated meeting for testing purposes.`;
            alert(successMessage);

            document.getElementById('liveSessionForm').reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('liveSessionModal'));
            modal.hide();

            showToast('Simulated meeting created successfully!', 'success');
        }

        // Open Chat Choice Modal
        function openChatChoiceModal() {
            const modal = new bootstrap.Modal(document.getElementById('chatChoiceModal'));
            modal.show();
        }

        // Daily Practice Questions Management
        let dailyPracticeQuestionCounter = 0;
        let currentDailyPracticeQuestionType = 'multiple-choice';
        let ChemistryDailyQuestions = [];

        // Daily Practice Questions Card Functions
        function loadDailyQuestions() {
            // Use consistent storage key with underscores
            const questionsData = localStorage.getItem('Chemistry_daily_practice_questions');
            ChemistryDailyQuestions = questionsData ? JSON.parse(questionsData) : [];
            console.log(' Loading daily questions for card:', ChemistryDailyQuestions.length, 'questions');
            console.log(' Questions data:', ChemistryDailyQuestions);
            displayDailyQuestions();
        }

        function displayDailyQuestions() {
            const container = document.getElementById('dailyQuestionsPreview');
            console.log(' Displaying daily questions:', ChemistryDailyQuestions.length, 'questions');
            
            // Check if container exists (card was removed from dashboard)
            if (!container) {
                console.log(' Daily questions card container not found (card removed from dashboard)');
                return;
            }
            
            if (ChemistryDailyQuestions.length === 0) {
                console.log(' No questions found, showing empty state');
                container.innerHTML = `
                    <div class="text-center py-3">
                        <iconify-icon icon="material-symbols:quiz" style="font-size: 2rem; color: #6c757d;"></iconify-icon>
                        <p class="text-muted mt-2 mb-0">No daily questions yet</p>
                        <small class="text-muted">Click "Add Question" to get started</small>
                    </div>
                `;
                return;
            }

            // Show preview of recent questions (max 3)
            const recentQuestions = ChemistryDailyQuestions.slice(-3);
            container.innerHTML = recentQuestions.map((question, index) => {
                // Handle different question data structures
                const questionText = question.question || question.questionText || question.title || 'No question text';
                const questionType = question.type || 'unknown';
                const difficulty = question.difficulty || 'unknown';
                const actualIndex = ChemistryDailyQuestions.length - recentQuestions.length + index;
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div class="flex-grow-1">
                            <h6 class="mb-1" style="font-size: 0.9rem;">${questionText.substring(0, 50)}${questionText.length > 50 ? '...' : ''}</h6>
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary" style="font-size: 0.7rem;">${questionType}</span>
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">${difficulty}</span>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="editDailyQuestion(${actualIndex})" style="padding: 0.25rem 0.5rem;">
                                <iconify-icon icon="material-symbols:edit" style="font-size: 0.8rem;"></iconify-icon>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDailyQuestion(${actualIndex})" style="padding: 0.25rem 0.5rem;">
                                <iconify-icon icon="material-symbols:delete" style="font-size: 0.8rem;"></iconify-icon>
                            </button>
                        </div>
                    </div>
                `;
            }).join('') + `
                ${ChemistryDailyQuestions.length > 3 ? `
                    <div class="text-center mt-2">
                        <small class="text-muted">+${ChemistryDailyQuestions.length - 3} more questions</small>
                    </div>
                ` : ''}
            `;
        }

        function editDailyQuestion(index) {
            openDailyPracticeModal(index);
        }

        function deleteDailyQuestion(index) {
            if (confirm('Are you sure you want to delete this daily question?')) {
                ChemistryDailyQuestions.splice(index, 1);
                localStorage.setItem('Chemistry_daily_practice_questions', JSON.stringify(ChemistryDailyQuestions));
                displayDailyQuestions();
                showToast('Daily question deleted successfully', 'success');
            }
        }

        // Open Daily Practice Modal
        function openDailyPracticeModal() {
            loadDailyPracticeQuestions();
            const modal = new bootstrap.Modal(document.getElementById('dailyPracticeModal'));
            modal.show();
            
            // Refresh the card display when modal is closed
            modal._element.addEventListener('hidden.bs.modal', function() {
                console.log(' Modal closed, refreshing card display...');
                loadDailyQuestions();
                
                // Also refresh the Practice Questions card to show today's questions
                loadPracticeQuestions();
            });
        }

        // Show questions by type/difficulty
        function showQuestionsByType(type) {
            const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            let filteredQuestions = questions;
            
            if (type !== 'all') {
                filteredQuestions = questions.filter(q => q.difficulty && q.difficulty.toLowerCase() === type);
            }
            
            if (filteredQuestions.length === 0) {
                showToast(`No ${type === 'all' ? '' : type + ' '}questions found`, 'info');
                return;
            }
            
            // Create a modal to display questions
            const modalHtml = `
                <div class="modal fade" id="questionsViewModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <iconify-icon icon="material-symbols:quiz" style="margin-right: 0.5rem;"></iconify-icon>
                                    ${type === 'all' ? 'All' : type.charAt(0).toUpperCase() + type.slice(1)} Questions (${filteredQuestions.length})
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    ${filteredQuestions.map((question, index) => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="card-title">Question ${index + 1}</h6>
                                                        <span class="badge bg-${question.difficulty === 'Easy' ? 'success' : question.difficulty === 'Medium' ? 'warning' : 'danger'}">${question.difficulty || 'Easy'}</span>
                                                    </div>
                                                    <p class="card-text">${question.question || 'No question text'}</p>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <small class="text-muted">Topic: ${question.topic || 'Not specified'}</small>
                                                        <small class="text-muted">Points: ${question.points || 10}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('questionsViewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('questionsViewModal'));
            modal.show();
        }

        // Select daily practice question type
        function selectDailyPracticeQuestionType(type) {
            currentDailyPracticeQuestionType = type;
            document.querySelectorAll('.question-type-compact').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.question-type-compact').classList.add('active');
        }

        // Load daily practice questions
        function loadDailyPracticeQuestions() {
            const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            const questionCount = document.getElementById('dailyPracticeQuestionCount');
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            // Update question count if element exists
            if (questionCount) {
            questionCount.textContent = questions.length;
            }
            
            // Update statistics
            updateQuestionStatistics(questions);
            
            // Show/hide clear all button based on question count
            if (clearAllBtn) {
            if (questions.length > 0) {
                clearAllBtn.style.display = 'block';
            } else {
                clearAllBtn.style.display = 'none';
                }
            }
            
            // Only update container if it exists
            if (container) {
            container.innerHTML = '';
            // Show container by default
            container.style.display = 'block';
            
            // Show empty state message - saved questions are hidden in categories
            container.innerHTML = '<div class="text-center text-muted py-4"><iconify-icon icon="material-symbols:quiz" style="font-size: 3rem; opacity: 0.3;"></iconify-icon><p class="mt-2">No questions being created. Click "Add Question" to start creating a new question!</p><p class="small">Use the filter buttons above to view saved questions by difficulty.</p></div>';
            }
        }

        // Add daily practice question to container
        function addDailyPracticeQuestionToContainer(question, questionNumber) {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            if (!container) return; // Exit if container doesn't exist
            dailyPracticeQuestionCounter++;
            
            const questionHtml = `
                <div class="question-item mb-4 p-3 border rounded" id="dailyPracticeQuestion-${dailyPracticeQuestionCounter}" style="display: block;" data-question-type="${question.type || currentDailyPracticeQuestionType}" data-difficulty="${question.difficulty || 'Easy'}" data-question-id="${question.id || ''}" data-created-at="${question.createdAt || ''}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check">
                                <input class="form-check-input question-checkbox" type="checkbox" value="${dailyPracticeQuestionCounter}" onchange="updateBulkActions()">
                            </div>
                            <h6>Question ${questionNumber}</h6>
                            <span class="badge bg-primary">${question.type || currentDailyPracticeQuestionType}</span>
                            <span class="badge bg-${question.difficulty === 'Easy' ? 'success' : question.difficulty === 'Medium' ? 'warning' : 'danger'}">${question.difficulty || 'Easy'}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="duplicateQuestion(${dailyPracticeQuestionCounter})">
                                <iconify-icon icon="material-symbols:content-copy"></iconify-icon>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDailyPracticeQuestion(${dailyPracticeQuestionCounter})">
                                <iconify-icon icon="material-symbols:delete"></iconify-icon>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3" style="width: 100%; display: block;">
                        <label class="form-label" style="display: block; width: 100%;">Question Text</label>
                        <textarea class="form-control" name="dailyPracticeQuestionText" rows="3" placeholder="Enter your question..." style="width: 100%; display: block;">${question.question || ''}</textarea>
                    </div>
                    <div class="mb-3" style="width: 100%; display: block;">
                        <label class="form-label" style="display: block; width: 100%;">Difficulty</label>
                        <select class="form-control" name="dailyPracticeDifficulty" style="width: 100%; display: block;">
                            <option value="Easy" ${question.difficulty === 'Easy' ? 'selected' : ''}>Easy</option>
                            <option value="Medium" ${question.difficulty === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Hard" ${question.difficulty === 'Hard' ? 'selected' : ''}>Hard</option>
                        </select>
                    </div>
                    <div class="mb-3" style="width: 100%; display: block;">
                        <label class="form-label" style="display: block; width: 100%;">Topic</label>
                        <input type="text" class="form-control" name="dailyPracticeTopic" placeholder="e.g., Mechanics, Thermodynamics" value="${question.topic || ''}" style="width: 100%; display: block;">
                    </div>
                    <div class="mb-3" style="width: 100%; display: block;">
                        <label class="form-label" style="display: block; width: 100%;">Points</label>
                        <input type="number" class="form-control" name="dailyPracticePoints" min="1" value="${question.points || 10}" style="width: 100%; display: block;">
                    </div>
                    <div id="dailyPracticeQuestionOptions-${dailyPracticeQuestionCounter}" style="width: 100%; display: block;">
                        ${generateDailyPracticeQuestionOptions(question.type || currentDailyPracticeQuestionType, dailyPracticeQuestionCounter, question.options || [])}
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', questionHtml);
        }

        // Generate daily practice question options based on type
        function generateDailyPracticeQuestionOptions(type, questionId, options = []) {
            switch(type) {
                case 'multiple-choice':
                case 'multiple-select':
                    const optionHtml = options.length > 0 ? 
                        options.map((option, index) => `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Option ${index + 1}" value="${option}">
                                <div class="input-group-text">
                                    <input type="radio" name="dailyPracticeCorrect-${questionId}" value="${index}">
                                </div>
                            </div>
                        `).join('') :
                        `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Option 1">
                                <div class="input-group-text">
                                    <input type="radio" name="dailyPracticeCorrect-${questionId}" value="0">
                                </div>
                            </div>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Option 2">
                                <div class="input-group-text">
                                    <input type="radio" name="dailyPracticeCorrect-${questionId}" value="1">
                                </div>
                            </div>
                        `;
                    
                    return `
                        <div class="mb-3">
                            <label class="form-label">Options</label>
                            <div id="dailyPracticeOptions-${questionId}">
                                ${optionHtml}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addDailyPracticeOption(${questionId})">
                                <iconify-icon icon="material-symbols:add"></iconify-icon>
                                Add Option
                            </button>
                        </div>
                    `;
                case 'short-answer':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Sample Answer (Optional)</label>
                            <textarea class="form-control" name="dailyPracticeSampleAnswer" rows="2" placeholder="Provide a sample answer for reference...">${options[0] || ''}</textarea>
                        </div>
                    `;
                case 'file-upload':
                case 'file-based':
                    return `
                        <div class="mb-3">
                            <label class="form-label">Upload Question File (Optional)</label>
                            <div class="file-upload-area" onclick="document.getElementById('dailyPracticeQuestionFile_${questionId}').click()" 
                                 style="border: 2px dashed #667eea; border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; background: #f8f9ff;">
                                <iconify-icon icon="material-symbols:cloud-upload" style="font-size: 2rem; color: #667eea;"></iconify-icon>
                                <div style="margin-top: 0.5rem; color: #667eea;">Click to upload question file (PDF, Image, etc.)</div>
                                <div id="dailyPracticeQuestionFileDisplay_${questionId}" style="margin-top: 0.5rem; font-size: 0.9rem; color: #28a745;"></div>
                            </div>
                            <input type="file" id="dailyPracticeQuestionFile_${questionId}" style="display: none;" 
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" 
                                   onchange="handleDailyPracticeQuestionFileUpload('${questionId}', this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Allowed Answer File Types</label>
                            <select class="form-control" name="dailyPracticeAllowedTypes" multiple>
                                <option value="pdf" selected>PDF</option>
                                <option value="doc" selected>DOC</option>
                                <option value="docx" selected>DOCX</option>
                                <option value="jpg" selected>JPG</option>
                                <option value="png" selected>PNG</option>
                                <option value="txt">TXT</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max File Size (MB)</label>
                            <input type="number" class="form-control" name="dailyPracticeMaxFileSize" value="10" min="1">
                        </div>
                    `;
                default:
                    return '';
            }
        }

        // Add daily practice questions
        function addDailyPracticeQuestions() {
            console.log('addDailyPracticeQuestions called! (Chemistry)');
            const questionCountInput = document.getElementById('questionCountInput');
            console.log('questionCountInput:', questionCountInput);
            const numberOfQuestions = parseInt(questionCountInput.value) || 1;
            console.log('numberOfQuestions:', numberOfQuestions);
            
            if (numberOfQuestions < 1 || numberOfQuestions > 50) {
                console.log('Invalid number of questions');
                showToast('Please enter a valid number between 1 and 50', 'warning');
                return;
            }
            
            console.log('Creating questions...');
            // Create questions based on the selected type
            for (let i = 0; i < numberOfQuestions; i++) {
                console.log(`Creating question ${i + 1}`);
                addDailyPracticeQuestion();
            }
            
            console.log('Questions created successfully');
            showToast(`Successfully created ${numberOfQuestions} question${numberOfQuestions > 1 ? 's' : ''}`, 'success');
        }

        // Add single daily practice question
        function addDailyPracticeQuestion() {
            console.log('addDailyPracticeQuestion called (Chemistry), counter:', dailyPracticeQuestionCounter);
            dailyPracticeQuestionCounter++;
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            console.log('container (Chemistry):', container);
            if (!container) {
                console.log('Container not found! (Chemistry)');
                return; // Exit if container doesn't exist
            }
            
            console.log('Creating question HTML... (Chemistry)');
            const questionHtml = `
                <div class="question-item mb-4 p-3 border rounded" id="dailyPracticeQuestion-${dailyPracticeQuestionCounter}" data-saved="false" data-question-type="${currentDailyPracticeQuestionType}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Question ${dailyPracticeQuestionCounter}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCurrentQuestion(${dailyPracticeQuestionCounter})" title="Delete this question">
                            <iconify-icon icon="material-symbols:delete"></iconify-icon>
                            Delete
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control" name="dailyPracticeQuestionText" rows="3" placeholder="Enter your question..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control" name="dailyPracticePoints" min="1" value="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Difficulty</label>
                        <select class="form-control" name="dailyPracticeDifficulty">
                            <option value="Easy">Easy</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Topic</label>
                        <input type="text" class="form-control" name="dailyPracticeTopic" placeholder="e.g., Mechanics, Electricity">
                    </div>
                    <div id="dailyPracticeQuestionOptions-${dailyPracticeQuestionCounter}">
                        ${generateDailyPracticeQuestionOptions(currentDailyPracticeQuestionType, dailyPracticeQuestionCounter)}
                    </div>
                </div>
            `;
            
            console.log('Adding question to container... (Chemistry)');
            
            // Clear only the empty state message when adding a new question, not existing questions
            if (container.innerHTML.includes('No questions being created')) {
                container.innerHTML = '';
            }
            
            container.insertAdjacentHTML('beforeend', questionHtml);
            console.log('Question added successfully (Chemistry)');
            
            // Show container when question is added
            container.style.display = 'block';
            
            // Update question count
            updateDailyPracticeQuestionCount();
        }

        // Add daily practice option
        function addDailyPracticeOption(questionId) {
            const optionsContainer = document.getElementById(`dailyPracticeOptions-${questionId}`);
            const optionCount = optionsContainer.children.length;
            
            const optionHtml = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control" placeholder="Option ${optionCount + 1}">
                    <div class="input-group-text">
                        <input type="radio" name="dailyPracticeCorrect-${questionId}" value="${optionCount}">
                    </div>
                </div>
            `;
            
            optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
        }

        // Remove daily practice question
        function removeDailyPracticeQuestion(questionId) {
            const questionElement = document.getElementById(`dailyPracticeQuestion-${questionId}`);
            if (questionElement) {
                questionElement.remove();
                updateDailyPracticeQuestionCount();
            }
        }

        // Update daily practice question count
        function updateDailyPracticeQuestionCount() {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            const questionCount = document.getElementById('dailyPracticeQuestionCount');
            
            if (!container || !questionCount) return; // Exit if elements don't exist
            
            const questions = container.querySelectorAll('.question-item');
            questionCount.textContent = questions.length;
        }

        // Handle daily practice question file upload
        function handleDailyPracticeQuestionFileUpload(questionId, input) {
            const file = input.files[0];
            const display = document.getElementById(`dailyPracticeQuestionFileDisplay_${questionId}`);
            
            if (file) {
                const fileSize = formatFileSize(file.size);
                display.innerHTML = `
                    <iconify-icon icon="material-symbols:check-circle" style="color: #28a745;"></iconify-icon>
                    ${file.name} (${fileSize})
                `;
            } else {
                display.innerHTML = '';
            }
        }

        // Save daily practice questions
        function saveDailyPracticeQuestions() {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            if (!container) return; // Exit if container doesn't exist
            
            const questionElements = container.querySelectorAll('.question-item');
            const questions = [];
            let hasErrors = false;

            // Show loading state
            const saveBtn = document.querySelector('button[onclick="saveDailyPracticeQuestions()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<iconify-icon icon="material-symbols:hourglass-empty"></iconify-icon> Saving...';
            saveBtn.disabled = true;

            questionElements.forEach((element, index) => {
                const questionText = element.querySelector('textarea[name="dailyPracticeQuestionText"]').value.trim();
                const difficulty = element.querySelector('select[name="dailyPracticeDifficulty"]').value;
                const topic = element.querySelector('input[name="dailyPracticeTopic"]').value.trim();
                const points = parseInt(element.querySelector('input[name="dailyPracticePoints"]').value) || 10;
                const questionType = element.getAttribute('data-question-type') || currentDailyPracticeQuestionType;
                
                // Validation
                if (!questionText) {
                    showToast(`Question text is required for question ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }
                if (!topic) {
                    showToast(`Topic is required for question ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }
                if (points < 1) {
                    showToast(`Points must be at least 1 for question ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }

                // Get existing question data if available
                const existingId = element.getAttribute('data-question-id');
                const existingCreatedAt = element.getAttribute('data-created-at');
                
                const question = {
                    id: existingId || Date.now() + index,
                    question: questionText,
                    difficulty: difficulty,
                    topic: topic,
                    points: points,
                    type: questionType,
                    createdAt: existingCreatedAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Get answer based on question type
                if (questionType === 'multiple-choice') {
                    const correctRadio = element.querySelector(`input[name="dailyPracticeCorrect-${element.id.split('-')[1]}"]:checked`);
                    const options = Array.from(element.querySelectorAll('#dailyPracticeOptions-' + element.id.split('-')[1] + ' input[type="text"]')).map(input => input.value.trim()).filter(opt => opt);
                    
                    if (!correctRadio) {
                        showToast(`Please select a correct answer for question ${index + 1}`, 'error');
                        hasErrors = true;
                        return;
                    }
                    if (options.length < 2) {
                        showToast(`At least 2 options are required for question ${index + 1}`, 'error');
                        hasErrors = true;
                        return;
                    }
                    
                    question.options = options;
                    question.correctAnswer = correctRadio.value;
                    question.answer = options[parseInt(correctRadio.value)];
                } else if (questionType === 'short-answer') {
                    const answerTextarea = element.querySelector('textarea[name="dailyPracticeAnswer"]');
                    const explanationTextarea = element.querySelector('textarea[name="dailyPracticeExplanation"]');
                    
                    if (answerTextarea && answerTextarea.value.trim()) {
                        question.answer = answerTextarea.value.trim();
                    }
                    if (explanationTextarea && explanationTextarea.value.trim()) {
                        question.explanation = explanationTextarea.value.trim();
                    }
                } else if (questionType === 'file-upload' || questionType === 'file-based') {
                    // Handle file upload question data
                    const allowedTypesSelect = element.querySelector('select[name="allowedTypes"]');
                    const maxFileSizeInput = element.querySelector('input[name="maxFileSize"]');
                    const fileInstructionsTextarea = element.querySelector('textarea[name="fileInstructions"]');
                    const answerTypeSelect = element.querySelector('select[name="answerType"]');
                    
                    if (allowedTypesSelect) {
                        question.allowedFileTypes = Array.from(allowedTypesSelect.selectedOptions).map(option => option.value);
                    }
                    if (maxFileSizeInput) {
                        question.maxFileSize = parseInt(maxFileSizeInput.value) || 10;
                    }
                    if (fileInstructionsTextarea && fileInstructionsTextarea.value.trim()) {
                        question.fileInstructions = fileInstructionsTextarea.value.trim();
                    }
                    if (answerTypeSelect) {
                        question.answerType = answerTypeSelect.value;
                    }
                    
                    // Handle question file upload
                    if (window.questionFiles && window.questionFiles[elementId]) {
                        question.questionFile = {
                            name: window.questionFiles[elementId].name,
                            size: window.questionFiles[elementId].size,
                            type: window.questionFiles[elementId].type
                        };
                    }
                    
                    // Handle multiple choice options for file assessments
                    if (answerTypeSelect && (answerTypeSelect.value === 'file-with-multiple-choice' || answerTypeSelect.value === 'multiple-choice-only')) {
                        const fileAnswerOptions = element.querySelectorAll('input[name="fileAnswerOption"]');
                        const correctAnswerRadio = element.querySelector('input[name="correctFileAnswer_' + elementId + '"]:checked');
                        
                        question.fileAnswerOptions = Array.from(fileAnswerOptions).map(input => input.value.trim()).filter(value => value);
                        if (correctAnswerRadio) {
                            question.correctFileAnswer = parseInt(correctAnswerRadio.value);
                        }
                    }
                }

                questions.push(question);
            });

            if (hasErrors) {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                return;
            }

            localStorage.setItem('Chemistry_daily_practice_questions', JSON.stringify(questions));
            console.log(' Saved questions to localStorage:', questions.length, 'questions');
            console.log(' Questions data:', questions);
            showToast(`Successfully saved ${questions.length} daily practice questions!`, 'success');
            
            // Reset button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            loadDailyPracticeQuestions();
            
            // Also refresh the card display
            console.log(' Refreshing card display after save...');
            loadDailyQuestions();
            
            // Also refresh the Practice Questions card to show today's questions
            loadPracticeQuestions();
        }

        // Publish daily practice questions to student dashboard
        function publishDailyPracticeQuestions() {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            if (!container) return; // Exit if container doesn't exist
            
            const questionElements = container.querySelectorAll('.question-item');
            const questions = [];
            let hasErrors = false;

            // Show loading state
            const publishBtn = document.querySelector('button[onclick="publishDailyPracticeQuestions()"]');
            const originalText = publishBtn.innerHTML;
            publishBtn.innerHTML = '<iconify-icon icon="material-symbols:hourglass-empty"></iconify-icon> Publishing...';
            publishBtn.disabled = true;

            questionElements.forEach((element, index) => {
                const questionText = element.querySelector('textarea[name="dailyPracticeQuestionText"]').value.trim();
                const difficulty = element.querySelector('select[name="dailyPracticeDifficulty"]').value;
                const topic = element.querySelector('input[name="dailyPracticeTopic"]').value.trim();
                const points = parseInt(element.querySelector('input[name="dailyPracticePoints"]').value) || 10;
                const questionType = element.getAttribute('data-question-type') || currentDailyPracticeQuestionType;
                
                // Validation
                if (!questionText) {
                    showToast(`Question text is required for question ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }
                if (!topic) {
                    showToast(`Topic is required for question ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }
                if (points < 1) {
                    showToast(`Points must be at least 1 for question ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }

                // Get existing question data if available
                const existingId = element.getAttribute('data-question-id');
                const existingCreatedAt = element.getAttribute('data-created-at');
                
                const question = {
                    id: existingId || Date.now() + index,
                    question: questionText,
                    difficulty: difficulty,
                    topic: topic,
                    points: points,
                    type: questionType,
                    createdAt: existingCreatedAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    published: true,
                    publishedAt: new Date().toISOString()
                };

                // Get answer based on question type
                if (questionType === 'multiple-choice') {
                    const correctRadio = element.querySelector(`input[name="dailyPracticeCorrect-${element.id.split('-')[1]}"]:checked`);
                    const options = Array.from(element.querySelectorAll('#dailyPracticeOptions-' + element.id.split('-')[1] + ' input[type="text"]')).map(input => input.value.trim()).filter(opt => opt);
                    
                    if (!correctRadio) {
                        showToast(`Please select a correct answer for question ${index + 1}`, 'error');
                        hasErrors = true;
                        return;
                    }
                    if (options.length < 2) {
                        showToast(`At least 2 options are required for question ${index + 1}`, 'error');
                        hasErrors = true;
                        return;
                    }
                    
                    question.options = options;
                    question.correctAnswer = correctRadio.value;
                    question.answer = options[parseInt(correctRadio.value)];
                } else if (questionType === 'short-answer') {
                    const answerTextarea = element.querySelector('textarea[name="dailyPracticeAnswer"]');
                    const explanationTextarea = element.querySelector('textarea[name="dailyPracticeExplanation"]');
                    
                    if (answerTextarea && answerTextarea.value.trim()) {
                        question.answer = answerTextarea.value.trim();
                    }
                    if (explanationTextarea && explanationTextarea.value.trim()) {
                        question.explanation = explanationTextarea.value.trim();
                    }
                } else if (questionType === 'file-upload' || questionType === 'file-based') {
                    // Handle file upload question data
                    const elementId = element.id.split('-')[1];
                    const allowedTypesSelect = element.querySelector('select[name="allowedTypes"]');
                    const maxFileSizeInput = element.querySelector('input[name="maxFileSize"]');
                    const fileInstructionsTextarea = element.querySelector('textarea[name="fileInstructions"]');
                    const answerTypeSelect = element.querySelector('select[name="answerType"]');
                    
                    if (allowedTypesSelect) {
                        question.allowedFileTypes = Array.from(allowedTypesSelect.selectedOptions).map(option => option.value);
                    }
                    if (maxFileSizeInput) {
                        question.maxFileSize = parseInt(maxFileSizeInput.value) || 10;
                    }
                    if (fileInstructionsTextarea && fileInstructionsTextarea.value.trim()) {
                        question.fileInstructions = fileInstructionsTextarea.value.trim();
                    }
                    if (answerTypeSelect) {
                        question.answerType = answerTypeSelect.value;
                    }
                    
                    // Handle question file upload
                    if (window.questionFiles && window.questionFiles[elementId]) {
                        question.questionFile = {
                            name: window.questionFiles[elementId].name,
                            size: window.questionFiles[elementId].size,
                            type: window.questionFiles[elementId].type
                        };
                    }
                    
                    // Handle multiple choice options for file assessments
                    if (answerTypeSelect && (answerTypeSelect.value === 'file-with-multiple-choice' || answerTypeSelect.value === 'multiple-choice-only')) {
                        const fileAnswerOptions = element.querySelectorAll('input[name="fileAnswerOption"]');
                        const correctAnswerRadio = element.querySelector('input[name="correctFileAnswer_' + elementId + '"]:checked');
                        
                        question.fileAnswerOptions = Array.from(fileAnswerOptions).map(input => input.value.trim()).filter(value => value);
                        if (correctAnswerRadio) {
                            question.correctFileAnswer = parseInt(correctAnswerRadio.value);
                        }
                    }
                }

                questions.push(question);
            });

            if (hasErrors) {
                publishBtn.innerHTML = originalText;
                publishBtn.disabled = false;
                return;
            }

            // Save to teacher's local storage (same as save function)
            localStorage.setItem('Chemistry_daily_practice_questions', JSON.stringify(questions));
            
            // Also save to student-facing storage for the student dashboard
            localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(questions));
            
            console.log(' Published questions to localStorage:', questions.length, 'questions');
            console.log(' Questions data:', questions);
            showToast(`Successfully published ${questions.length} daily practice questions to course!`, 'success');
            
            // Reset button state
            publishBtn.innerHTML = originalText;
            publishBtn.disabled = false;
            
            loadDailyPracticeQuestions();
            
            // Also refresh the card display
            console.log(' Refreshing card display after publish...');
            loadDailyQuestions();
            
            // Also refresh the Practice Questions card to show today's questions
            loadPracticeQuestions();
        }

        // Save currently creating questions to localStorage
        function saveCurrentlyCreatingQuestions() {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            if (!container) return;
            
            const questionElements = container.querySelectorAll('.question-item');
            if (questionElements.length === 0) return;
            
            const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            let hasNewQuestions = false;
            
            questionElements.forEach((element) => {
                const questionText = element.querySelector('textarea[name="dailyPracticeQuestionText"]');
                const difficulty = element.querySelector('select[name="dailyPracticeDifficulty"]');
                const topic = element.querySelector('input[name="dailyPracticeTopic"]');
                const points = element.querySelector('input[name="dailyPracticePoints"]');
                
                // Only save if question has content and hasn't been saved yet
                if (questionText && questionText.value.trim() && !element.hasAttribute('data-saved')) {
                    const questionId = element.id.split('-')[1];
                    const questionType = element.getAttribute('data-question-type') || currentDailyPracticeQuestionType;
                    
                    const question = {
                        id: Date.now() + Math.random(),
                        question: questionText.value.trim(),
                        difficulty: difficulty ? difficulty.value : 'Easy',
                        topic: topic ? topic.value.trim() : '',
                        points: points ? parseInt(points.value) || 10 : 10,
                        type: questionType,
                        createdAt: new Date().toISOString(),
                        published: false
                    };
                    
                    // Get answer based on question type
                    if (questionType === 'multiple-choice') {
                        const correctRadio = element.querySelector(`input[name="dailyPracticeCorrect-${questionId}"]:checked`);
                        const options = Array.from(element.querySelectorAll('#dailyPracticeOptions-' + questionId + ' input[type="text"]')).map(input => input.value.trim()).filter(opt => opt);
                        
                        if (correctRadio && options.length >= 2) {
                            question.options = options;
                            question.correctAnswer = correctRadio.value;
                            question.answer = options[parseInt(correctRadio.value)];
                        }
                    } else if (questionType === 'short-answer') {
                        const answerTextarea = element.querySelector('textarea[name="dailyPracticeAnswer"]');
                        const explanationTextarea = element.querySelector('textarea[name="dailyPracticeExplanation"]');
                        
                        if (answerTextarea && answerTextarea.value.trim()) {
                            question.answer = answerTextarea.value.trim();
                        }
                        if (explanationTextarea && explanationTextarea.value.trim()) {
                            question.explanation = explanationTextarea.value.trim();
                        }
                    }
                    
                    questions.push(question);
                    hasNewQuestions = true;
                    
                    // Mark this element as saved to prevent duplicate saving
                    element.setAttribute('data-saved', 'true');
                }
            });
            
            if (hasNewQuestions) {
                localStorage.setItem('Chemistry_daily_practice_questions', JSON.stringify(questions));
                localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(questions));
            }
        }

        // Expose publishDailyPracticeQuestions globally for inline onclick handlers
        window.publishDailyPracticeQuestions = publishDailyPracticeQuestions;

        // Show all questions in main container
        function showAllQuestions() {
            const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            displayQuestionsInMainContainer(questions, 'All Questions');
        }

        // Show questions by difficulty in main container
        function showQuestionsByDifficulty(difficulty) {
            const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            const filteredQuestions = questions.filter(q => q.difficulty === difficulty);
            displayQuestionsInMainContainer(filteredQuestions, `${difficulty} Questions`);
        }

        // Display questions in main container
        function displayQuestionsInMainContainer(questions, title) {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            if (!container) return;
            
            // Get any currently creating questions that haven't been saved yet
            const creatingQuestions = Array.from(container.querySelectorAll('.question-item[data-saved="false"]'));
            
            // Clear the main container
            container.innerHTML = '';
            container.style.display = 'block';
            
            // If there are questions being created, show them first
            if (creatingQuestions.length > 0) {
                creatingQuestions.forEach(element => {
                    container.appendChild(element);
                });
                
                // Add a separator if there are both creating and saved questions
                if (questions.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'border-top my-3';
                    separator.innerHTML = '<div class="text-center text-muted py-2"><small>Saved Questions</small></div>';
                    container.appendChild(separator);
                }
            }
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <iconify-icon icon="material-symbols:quiz" style="font-size: 3rem; opacity: 0.3;"></iconify-icon>
                        <h5 class="text-muted">No ${title.toLowerCase()} found</h5>
                        <p class="text-muted">Create some questions first to see them here.</p>
                    </div>
                `;
            } else {
                container.innerHTML = questions.map((question, index) => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Question ${index + 1}</h6>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge bg-${getDifficultyColor(question.difficulty)}">${question.difficulty || 'Easy'}</span>
                                <span class="badge bg-primary">${question.type || 'Multiple Choice'}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteSavedQuestion('${question.id || index}', '${question.difficulty || 'Easy'}')" title="Delete this question">
                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><strong>Question:</strong> ${question.text || question.question || 'No question text'}</p>
                            ${question.type === 'multiple-choice' && question.options ? `
                                <div class="mb-2">
                                    <strong>Options:</strong>
                                    <ul class="list-unstyled mt-1">
                                        ${question.options.map((option, optIndex) => `
                                            <li class="d-flex align-items-center">
                                                <span class="badge bg-${optIndex === question.correctAnswer ? 'success' : 'secondary'} me-2">${String.fromCharCode(65 + optIndex)}</span>
                                                ${option}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${question.correctAnswer ? `<p class="mb-0"><strong>Correct Answer:</strong> ${question.correctAnswer}</p>` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        // Display questions in modal
        function displayQuestionsInModal(questions, title) {
            const modalTitle = document.getElementById('questionsModalTitle');
            const container = document.getElementById('questionsDisplayContainer');
            
            modalTitle.innerHTML = `<iconify-icon icon="material-symbols:quiz" style="margin-right: 0.5rem;"></iconify-icon>${title} (${questions.length})`;
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <iconify-icon icon="material-symbols:quiz" style="font-size: 4rem; color: #6c757d; margin-bottom: 1rem;"></iconify-icon>
                        <h5 class="text-muted">No questions found</h5>
                        <p class="text-muted">Create some questions first to see them here.</p>
                    </div>
                `;
            } else {
                container.innerHTML = questions.map((question, index) => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Question ${index + 1}</h6>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge bg-${getDifficultyColor(question.difficulty)}">${question.difficulty || 'Easy'}</span>
                                <span class="badge bg-primary">${question.type || 'Multiple Choice'}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteSavedQuestion('${question.id || index}', '${question.difficulty || 'Easy'}')" title="Delete this question">
                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><strong>Question:</strong> ${question.text || question.question || 'No question text'}</p>
                            ${question.type === 'multiple-choice' && question.options ? `
                                <div class="mb-2">
                                    <strong>Options:</strong>
                                    <ul class="list-unstyled mt-1">
                                        ${question.options.map((option, optIndex) => `
                                            <li class="d-flex align-items-center">
                                                <span class="badge bg-${optIndex === question.correctAnswer ? 'success' : 'secondary'} me-2">${String.fromCharCode(65 + optIndex)}</span>
                                                ${option}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${question.correctAnswer ? `<p class="mb-0"><strong>Correct Answer:</strong> ${question.correctAnswer}</p>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('questionsDisplayModal'));
            modal.show();
        }

        // Get difficulty color for badge
        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case 'Easy': return 'success';
                case 'Medium': return 'warning';
                case 'Hard': return 'danger';
                default: return 'secondary';
            }
        }

        // Delete currently added question (not yet saved)
        function deleteCurrentQuestion(questionId) {
            const questionElement = document.getElementById(`dailyPracticeQuestion-${questionId}`);
            if (questionElement) {
                questionElement.remove();
                updateDailyPracticeQuestionCount();
                
                // Show empty state if no questions left
                const container = document.getElementById('dailyPracticeQuestionsContainer');
                if (container && container.children.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4"><iconify-icon icon="material-symbols:quiz" style="font-size: 3rem; opacity: 0.3;"></iconify-icon><p class="mt-2">No questions being created. Click "Add Question" to start creating a new question!</p><p class="small">Use the filter buttons above to view saved questions by difficulty.</p></div>';
                }
            }
        }

        // Delete saved question from localStorage
        function deleteSavedQuestion(questionId, difficulty) {
            if (confirm(`Are you sure you want to delete this ${difficulty.toLowerCase()} question?`)) {
                const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
                const updatedQuestions = questions.filter(q => q.id != questionId);
                
                // Save updated questions
                localStorage.setItem('Chemistry_daily_practice_questions', JSON.stringify(updatedQuestions));
                localStorage.setItem('Chemistry_daily_practice_questions_student', JSON.stringify(updatedQuestions));
                
                // Refresh the modal display
                const currentTitle = document.getElementById('questionsModalTitle').textContent;
                if (currentTitle.includes('All Questions')) {
                    showAllQuestions();
                } else if (currentTitle.includes('Easy Questions')) {
                    showQuestionsByDifficulty('Easy');
                } else if (currentTitle.includes('Medium Questions')) {
                    showQuestionsByDifficulty('Medium');
                } else if (currentTitle.includes('Hard Questions')) {
                    showQuestionsByDifficulty('Hard');
                }
                
                // Update question count
                updateDailyPracticeQuestionCount();
                
                showToast('Question deleted successfully!', 'success');
            }
        }

        // Expose functions globally
        window.showAllQuestions = showAllQuestions;
        window.showQuestionsByDifficulty = showQuestionsByDifficulty;
        window.deleteCurrentQuestion = deleteCurrentQuestion;
        window.deleteSavedQuestion = deleteSavedQuestion;
        window.addDailyPracticeQuestion = addDailyPracticeQuestion;
        window.selectDailyPracticeQuestionType = selectDailyPracticeQuestionType;
        window.addDailyPracticeOption = addDailyPracticeOption;
        window.saveCurrentlyCreatingQuestions = saveCurrentlyCreatingQuestions;

        // Toggle questions visibility
        function toggleQuestionsVisibility() {
            const container = document.getElementById('dailyPracticeQuestionsContainer');
            const toggleBtn = document.getElementById('toggleQuestionsBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleBtn.innerHTML = '<iconify-icon icon="material-symbols:visibility-off"></iconify-icon> Hide Questions';
            } else {
                container.style.display = 'none';
                toggleBtn.innerHTML = '<iconify-icon icon="material-symbols:visibility"></iconify-icon> Show Questions';
            }
        }

        // Delete individual question
        function deleteDailyPracticeQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                const questionElement = document.getElementById(`dailyPracticeQuestion-${questionId}`);
                if (questionElement) {
                    questionElement.remove();
                    updateDailyPracticeQuestionCount();
                    showToast('Question deleted successfully!', 'success');
                }
            }
        }

        // Expose functions globally
        window.toggleQuestionsVisibility = toggleQuestionsVisibility;
        window.deleteDailyPracticeQuestion = deleteDailyPracticeQuestion;
        window.addDailyPracticeQuestions = addDailyPracticeQuestions;

        // Generate daily practice questions
        function generateDailyPracticeQuestions() {
            const numberOfQuestions = prompt('How many questions would you like to generate?', '5');
            if (!numberOfQuestions || isNaN(numberOfQuestions) || numberOfQuestions < 1) {
                return;
            }

            const container = document.getElementById('dailyPracticeQuestionsContainer');
            if (!container) return; // Exit if container doesn't exist
            container.innerHTML = '';
            dailyPracticeQuestionCounter = 0;

            for (let i = 1; i <= numberOfQuestions; i++) {
                addDailyPracticeQuestion();
            }

            showToast(`Generated ${numberOfQuestions} questions!`, 'success');
        }

        // Update question statistics
        function updateQuestionStatistics(questions) {
            // Stats UI removed; safely no-op if elements do not exist
            const totalEl = document.getElementById('totalQuestionsCount');
            const easyEl = document.getElementById('easyQuestionsCount');
            const mediumEl = document.getElementById('mediumQuestionsCount');
            const hardEl = document.getElementById('hardQuestionsCount');

            if (!totalEl || !easyEl || !mediumEl || !hardEl) {
                return;
            }

            const totalCount = questions.length;
            const easyCount = questions.filter(q => q.difficulty === 'Easy').length;
            const mediumCount = questions.filter(q => q.difficulty === 'Medium').length;
            const hardCount = questions.filter(q => q.difficulty === 'Hard').length;

            totalEl.textContent = totalCount;
            easyEl.textContent = easyCount;
            mediumEl.textContent = mediumCount;
            hardEl.textContent = hardCount;
        }

        // Export daily practice questions
        function exportDailyPracticeQuestions() {
            const questions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            if (questions.length === 0) {
                showToast('No questions to export', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(questions, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Chemistry_daily_practice_questions.json';
            link.click();
            URL.revokeObjectURL(url);
            showToast('Questions exported successfully!', 'success');
        }

        // Import daily practice questions
        function importDailyPracticeQuestions() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedQuestions = JSON.parse(e.target.result);
                            if (Array.isArray(importedQuestions)) {
                                const currentQuestions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
                                const mergedQuestions = [...currentQuestions, ...importedQuestions];
                                localStorage.setItem('Chemistry_daily_practice_questions', JSON.stringify(mergedQuestions));
                                loadDailyPracticeQuestions();
                                showToast(`${importedQuestions.length} questions imported successfully!`, 'success');
                            } else {
                                showToast('Invalid file format', 'error');
                            }
                        } catch (error) {
                            showToast('Error reading file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Clear all daily practice questions
        function clearAllDailyPracticeQuestions() {
            if (confirm('Are you sure you want to delete ALL daily practice questions? This action cannot be undone.')) {
                localStorage.removeItem('Chemistry_daily_practice_questions');
                loadDailyPracticeQuestions();
                loadDailyQuestions(); // Also refresh the card display
                showToast('All daily practice questions have been deleted', 'success');
            }
        }

        // Filter questions based on search and filters
        function filterQuestions() {
            const searchTerm = document.getElementById('questionSearch').value.toLowerCase();
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const questions = document.querySelectorAll('.question-item');
            
            questions.forEach(question => {
                const questionText = question.querySelector('textarea[name="dailyPracticeQuestionText"]').value.toLowerCase();
                const topic = question.querySelector('input[name="dailyPracticeTopic"]').value.toLowerCase();
                const difficulty = question.getAttribute('data-difficulty');
                const type = question.getAttribute('data-question-type');
                
                const matchesSearch = questionText.includes(searchTerm) || topic.includes(searchTerm);
                const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter;
                const matchesType = !typeFilter || type === typeFilter;
                
                if (matchesSearch && matchesDifficulty && matchesType) {
                    question.style.display = 'block';
                } else {
                    question.style.display = 'none';
                }
            });
        }

        // Update bulk actions visibility
        function updateBulkActions() {
            const checkedBoxes = document.querySelectorAll('.question-checkbox:checked');
            const bulkActions = document.getElementById('bulkActions');
            
            if (checkedBoxes.length > 0) {
                bulkActions.style.display = 'flex';
            } else {
                bulkActions.style.display = 'none';
            }
        }

        // Delete selected questions
        function deleteSelectedQuestions() {
            const checkedBoxes = document.querySelectorAll('.question-checkbox:checked');
            if (checkedBoxes.length === 0) return;
            
            if (confirm(`Are you sure you want to delete ${checkedBoxes.length} selected questions?`)) {
                checkedBoxes.forEach(checkbox => {
                    const questionId = checkbox.value;
                    const questionElement = document.getElementById(`dailyPracticeQuestion-${questionId}`);
                    if (questionElement) {
                        questionElement.remove();
                    }
                });
                updateDailyPracticeQuestionCount();
                updateBulkActions();
                showToast(`${checkedBoxes.length} questions deleted successfully!`, 'success');
            }
        }

        // Export selected questions
        function exportSelectedQuestions() {
            const checkedBoxes = document.querySelectorAll('.question-checkbox:checked');
            if (checkedBoxes.length === 0) return;
            
            const allQuestions = JSON.parse(localStorage.getItem('Chemistry_daily_practice_questions') || '[]');
            const selectedQuestions = [];
            
            checkedBoxes.forEach(checkbox => {
                const questionId = checkbox.value;
                const questionElement = document.getElementById(`dailyPracticeQuestion-${questionId}`);
                if (questionElement) {
                    // Get question data from form
                    const questionText = questionElement.querySelector('textarea[name="dailyPracticeQuestionText"]').value.trim();
                    const difficulty = questionElement.querySelector('select[name="dailyPracticeDifficulty"]').value;
                    const topic = questionElement.querySelector('input[name="dailyPracticeTopic"]').value.trim();
                    const points = parseInt(questionElement.querySelector('input[name="dailyPracticePoints"]').value) || 10;
                    const type = questionElement.getAttribute('data-question-type');
                    
                    if (questionText && topic) {
                        selectedQuestions.push({
                            question: questionText,
                            difficulty: difficulty,
                            topic: topic,
                            points: points,
                            type: type
                        });
                    }
                }
            });
            
            if (selectedQuestions.length > 0) {
                const dataStr = JSON.stringify(selectedQuestions, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `selected-daily-practice-questions-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showToast(`${selectedQuestions.length} questions exported successfully!`, 'success');
            }
        }

        // Clear selection
        function clearSelection() {
            document.querySelectorAll('.question-checkbox:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBulkActions();
        }

        // Duplicate question
        function duplicateQuestion(questionId) {
            const questionElement = document.getElementById(`dailyPracticeQuestion-${questionId}`);
            if (questionElement) {
                const questionData = {
                    question: questionElement.querySelector('textarea[name="dailyPracticeQuestionText"]').value,
                    difficulty: questionElement.querySelector('select[name="dailyPracticeDifficulty"]').value,
                    topic: questionElement.querySelector('input[name="dailyPracticeTopic"]').value,
                    points: questionElement.querySelector('input[name="dailyPracticePoints"]').value,
                    type: questionElement.getAttribute('data-question-type')
                };
                
                addDailyPracticeQuestionToContainer(questionData, document.querySelectorAll('.question-item').length + 1);
                showToast('Question duplicated successfully!', 'success');
            }
        }


        // Preview questions
        function previewQuestions() {
            const questions = document.querySelectorAll('.question-item');
            if (questions.length === 0) {
                showToast('No questions to preview', 'warning');
                return;
            }
            
            // Create preview modal
            const previewModal = document.createElement('div');
            previewModal.className = 'modal fade';
            previewModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Question Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="previewContent"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
            const modal = new bootstrap.Modal(previewModal);
            
            // Generate preview content
            const previewContent = document.getElementById('previewContent');
            let previewHtml = '';
            
            questions.forEach((question, index) => {
                const questionText = question.querySelector('textarea[name="dailyPracticeQuestionText"]').value;
                const difficulty = question.querySelector('select[name="dailyPracticeDifficulty"]').value;
                const topic = question.querySelector('input[name="dailyPracticeTopic"]').value;
                const points = question.querySelector('input[name="dailyPracticePoints"]').value;
                const type = question.getAttribute('data-question-type');
                
                if (questionText) {
                    previewHtml += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Question ${index + 1}</h6>
                                <div>
                                    <span class="badge bg-primary me-1">${type}</span>
                                    <span class="badge bg-${difficulty === 'Easy' ? 'success' : difficulty === 'Medium' ? 'warning' : 'danger'}">${difficulty}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p><strong>Topic:</strong> ${topic} | <strong>Points:</strong> ${points}</p>
                                <p>${questionText}</p>
                                ${type === 'multiple-choice' ? '<p><em>Multiple choice options would appear here</em></p>' : ''}
                                ${type === 'short-answer' ? '<p><em>Text input field would appear here</em></p>' : ''}
                                ${type === 'file-upload' ? '<p><em>File upload field would appear here</em></p>' : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            previewContent.innerHTML = previewHtml || '<p class="text-muted">No questions to preview</p>';
            
            modal.show();
            
            // Clean up modal after it's hidden
            previewModal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(previewModal);
            });
        }

        // Session Schedule Functions
        function openSessionScheduleModal() {
            const modal = new bootstrap.Modal(document.getElementById('sessionScheduleModal'));
            modal.show();
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').value = today;
            
            // Set default time to next hour
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            document.getElementById('sessionTime').value = nextHour.toTimeString().slice(0, 5);
        }

        function saveSessionSchedule() {
            const sessionData = {
                id: Date.now().toString(),
                title: document.getElementById('sessionTitle').value,
                type: document.getElementById('sessionType').value,
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value,
                duration: parseInt(document.getElementById('sessionDuration').value),
                maxStudents: parseInt(document.getElementById('maxStudents').value),
                description: document.getElementById('sessionDescription').value,
                location: document.getElementById('sessionLocation').value,
                isRecurring: document.getElementById('recurringSession').checked,
                repeatFrequency: document.getElementById('repeatFrequency').value,
                endDate: document.getElementById('endDate').value,
                createdAt: new Date().toISOString()
            };

            if (!sessionData.title || !sessionData.type || !sessionData.date || !sessionData.time) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            sessionSchedules.push(sessionData);
            localStorage.setItem('ChemistrySessionSchedules', JSON.stringify(sessionSchedules));
            
            loadSessionSchedules();
            updateSessionStats();
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('sessionScheduleModal'));
            modal.hide();
            document.getElementById('sessionScheduleForm').reset();
            
            showToast('Session scheduled successfully!', 'success');
        }

        function loadSessionSchedules() {
            const stored = localStorage.getItem('ChemistrySessionSchedules');
            if (stored) {
                sessionSchedules = JSON.parse(stored);
            }
            
            displaySessionSchedules();
            // If a weekly schedule exists, render overview for its start week
            try {
                const weekly = JSON.parse(localStorage.getItem('ChemistryWeeklySchedules') || '[]');
                if (weekly.length > 0) {
                    const latest = weekly[weekly.length - 1];
                    renderWeeklyOverview(new Date(latest.weekStartDate), latest.sessions);
                }
            } catch (e) { /* noop */ }
        }

        function displaySessionSchedules() {
            const container = document.getElementById('sessionsList');
            if (!container) return;

            if (sessionSchedules.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <iconify-icon icon="material-symbols:schedule" style="font-size: 3rem; color: #ccc;"></iconify-icon>
                        <h5 class="mt-3 text-muted">No Sessions Scheduled</h5>
                        <p class="text-muted">Click "Add New Session" to schedule your first class session.</p>
                    </div>
                `;
                return;
            }

            // Sort sessions by date and time
            const sortedSessions = sessionSchedules.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateA - dateB;
            });

            container.innerHTML = sortedSessions.map(session => {
                const sessionDate = new Date(`${session.date} ${session.time}`);
                const isUpcoming = sessionDate > new Date();
                const isToday = sessionDate.toDateString() === new Date().toDateString();
                
                return `
                    <div class="session-item card mb-3 ${isUpcoming ? 'border-primary' : 'border-secondary'}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">${session.title}</h6>
                                    <p class="card-text text-muted mb-2">
                                        <iconify-icon icon="material-symbols:schedule"></iconify-icon>
                                        ${formatSessionDateTime(session.date, session.time)} (${session.duration} min)
                                    </p>
                                    <div class="d-flex gap-3 mb-2">
                                        <small class="text-muted">
                                            <iconify-icon icon="material-symbols:category"></iconify-icon>
                                            ${session.type.charAt(0).toUpperCase() + session.type.slice(1)}
                                        </small>
                                        <small class="text-muted">
                                            <iconify-icon icon="material-symbols:people"></iconify-icon>
                                            Max ${session.maxStudents} students
                                        </small>
                                        ${session.location ? `
                                            <small class="text-muted">
                                                <iconify-icon icon="material-symbols:location-on"></iconify-icon>
                                                ${session.location}
                                            </small>
                                        ` : ''}
                                    </div>
                                    ${session.description ? `<p class="card-text small">${session.description}</p>` : ''}
                                </div>
                                <div class="d-flex gap-2">
                                    ${isUpcoming ? `
                                        <button class="btn btn-sm btn-outline-primary" onclick="editSession('${session.id}')">
                                            <iconify-icon icon="material-symbols:edit"></iconify-icon>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${session.id}')">
                                        <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatSessionDateTime(date, time) {
            const sessionDate = new Date(`${date} ${time}`);
            const now = new Date();
            const diffTime = sessionDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let dateStr = sessionDate.toLocaleDateString();
            if (diffDays === 0) {
                dateStr = 'Today';
            } else if (diffDays === 1) {
                dateStr = 'Tomorrow';
            } else if (diffDays < 7) {
                dateStr = sessionDate.toLocaleDateString('en-US', { weekday: 'long' });
            }
            
            return `${dateStr} at ${sessionDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
        }

        function updateSessionStats() {
            const total = sessionSchedules.length;
            const now = new Date();
            const today = now.toDateString();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const upcoming = sessionSchedules.filter(session => {
                const sessionDate = new Date(`${session.date} ${session.time}`);
                return sessionDate > now;
            }).length;
            
            const todaySessions = sessionSchedules.filter(session => {
                const sessionDate = new Date(`${session.date} ${session.time}`);
                return sessionDate.toDateString() === today;
            }).length;
            
            const weeklySessions = sessionSchedules.filter(session => {
                const sessionDate = new Date(`${session.date} ${session.time}`);
                return sessionDate >= now && sessionDate <= weekFromNow;
            }).length;

            document.getElementById('totalSessions').textContent = total;
            document.getElementById('upcomingSessions').textContent = upcoming;
            document.getElementById('todaySessions').textContent = todaySessions;
            document.getElementById('weeklySessions').textContent = weeklySessions;
        }

        function editSession(sessionId) {
            const session = sessionSchedules.find(s => s.id === sessionId);
            if (!session) return;

            // Populate form with session data
            document.getElementById('sessionTitle').value = session.title;
            document.getElementById('sessionType').value = session.type;
            document.getElementById('sessionDate').value = session.date;
            document.getElementById('sessionTime').value = session.time;
            document.getElementById('sessionDuration').value = session.duration;
            document.getElementById('maxStudents').value = session.maxStudents;
            document.getElementById('sessionDescription').value = session.description || '';
            document.getElementById('sessionLocation').value = session.location || '';
            document.getElementById('recurringSession').checked = session.isRecurring || false;
            document.getElementById('repeatFrequency').value = session.repeatFrequency || 'weekly';
            document.getElementById('endDate').value = session.endDate || '';

            // Show recurring options if needed
            if (session.isRecurring) {
                document.getElementById('recurringOptions').style.display = 'block';
            }

            // Open modal
            const modal = new bootstrap.Modal(document.getElementById('sessionScheduleModal'));
            modal.show();

            // Store the session ID for updating
            document.getElementById('sessionScheduleModal').setAttribute('data-editing-id', sessionId);
        }

        function deleteSession(sessionId) {
            if (confirm('Are you sure you want to delete this session?')) {
                sessionSchedules = sessionSchedules.filter(s => s.id !== sessionId);
                localStorage.setItem('ChemistrySessionSchedules', JSON.stringify(sessionSchedules));
                loadSessionSchedules();
                updateSessionStats();
                showToast('Session deleted successfully', 'success');
            }
        }

        // Handle recurring session checkbox
        document.addEventListener('DOMContentLoaded', function() {
            const recurringCheckbox = document.getElementById('recurringSession');
            const recurringOptions = document.getElementById('recurringOptions');
            
            if (recurringCheckbox && recurringOptions) {
                recurringCheckbox.addEventListener('change', function() {
                    recurringOptions.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Countdown timer functionality for Time Limit
        function updateCountdownDisplay() {
            const timeLimitInput = document.getElementById('timeLimit');
            const countdownDisplay = document.getElementById('countdownDisplay');
            const countdownText = document.getElementById('countdownText');
            const durationLabel = document.getElementById('durationLabel');
            
            if (!timeLimitInput || !countdownDisplay || !countdownText || !durationLabel) return;
            
            const timeLimit = parseInt(timeLimitInput.value);
            
            if (timeLimit && timeLimit > 0) {
                // Show countdown display
                countdownDisplay.style.display = 'block';
                
                // Set label based on assessment type
                const typeLabels = {
                    'assignment': 'Assignment Duration:',
                    'quiz': 'Quiz Duration:',
                    'exam': 'Exam Duration:'
                };
                const labelText = typeLabels[currentAssessmentType] || 'Duration:';
                durationLabel.textContent = labelText;
                
                // Format time display
                const hours = Math.floor(timeLimit / 60);
                const minutes = timeLimit % 60;
                
                let timeString = '';
                if (hours > 0) {
                    timeString = `${hours} hour${hours > 1 ? 's' : ''}`;
                    if (minutes > 0) {
                        timeString += ` and ${minutes} minute${minutes > 1 ? 's' : ''}`;
                    }
                } else {
                    timeString = `${minutes} minute${minutes > 1 ? 's' : ''}`;
                }
                
                countdownText.textContent = timeString;
                
                // Add visual indicator based on time limit
                const alertElement = countdownDisplay.querySelector('.alert');
                if (timeLimit <= 30) {
                    alertElement.className = 'alert alert-warning d-flex align-items-center';
                } else if (timeLimit <= 60) {
                    alertElement.className = 'alert alert-info d-flex align-items-center';
                } else {
                    alertElement.className = 'alert alert-success d-flex align-items-center';
                }
            } else {
                // Hide countdown display
                countdownDisplay.style.display = 'none';
            }
        }

        // Enhanced time limit handling for assignments
        function getTimeLimitInSeconds() {
            const timeLimitInput = document.getElementById('timeLimit');
            const timeLimit = timeLimitInput ? parseInt(timeLimitInput.value) : null;
            return timeLimit ? timeLimit * 60 : null; // Convert minutes to seconds
        }

        // Update the saveAssessment function to include countdown timer data
        function saveAssessmentWithTimer() {
            const assessmentType = document.querySelector('input[name="assessmentType"]:checked').value;
            
            const formData = {
                id: Date.now().toString(),
                type: currentAssessmentType,
                assessmentType: assessmentType,
                title: document.getElementById('assessmentTitle').value,
                description: document.getElementById('assessmentDescription').value,
                totalPoints: parseInt(document.getElementById('totalPoints').value),
                timeLimit: document.getElementById('timeLimit').value ? parseInt(document.getElementById('timeLimit').value) : null,
                timeLimitSeconds: getTimeLimitInSeconds(), // Add seconds for countdown
                dueDate: document.getElementById('dueDate').value,
                difficulty: document.getElementById('difficulty').value,
                questions: collectQuestions(),
                createdAt: new Date().toISOString(),
                status: 'draft',
                hasCountdownTimer: !!document.getElementById('timeLimit').value // Flag to indicate countdown timer
            };

            assessments.push(formData);
            saveToLocalStorage();
            loadAssessments();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
            modal.hide();
            
            showToast('Assessment saved as draft with countdown timer!', 'success');
        }

        // Update the publishAssessment function to include countdown timer data
        function publishAssessmentWithTimer() {
            const assessmentType = 'standard';
            
            const formData = {
                id: Date.now().toString(),
                type: currentAssessmentType,
                assessmentType: assessmentType,
                title: document.getElementById('assessmentTitle').value,
                description: document.getElementById('assessmentDescription').value,
                totalPoints: parseInt(document.getElementById('totalPoints').value),
                timeLimit: document.getElementById('timeLimit').value ? parseInt(document.getElementById('timeLimit').value) : null,
                timeLimitSeconds: getTimeLimitInSeconds(), // Add seconds for countdown
                dueDate: document.getElementById('dueDate').value,
                difficulty: document.getElementById('difficulty').value,
                questions: collectQuestions(),
                status: 'published',
                createdAt: new Date().toISOString(),
                subject: 'Chemistry',
                hasCountdownTimer: !!document.getElementById('timeLimit').value // Flag to indicate countdown timer
            };

            // Save to assessments (for teacher dashboard)
            assessments.push(formData);
            saveToLocalStorage();

            // Save to course page (for students)
            const courseData = {
                id: formData.id,
                title: formData.title,
                description: formData.description,
                points: formData.totalPoints,
                dueDate: formData.dueDate,
                difficulty: formData.difficulty.charAt(0).toUpperCase() + formData.difficulty.slice(1),
                estimatedTime: formData.timeLimit ? `${formData.timeLimit} minutes` : 'No time limit',
                timeLimitSeconds: formData.timeLimitSeconds, // Include countdown timer data
                questions: formData.questions,
                status: 'published',
                type: formData.type,
                subject: 'Chemistry',
                createdAt: formData.createdAt,
                hasCountdownTimer: formData.hasCountdownTimer // Include countdown flag
            };

            // Determine the localStorage key based on assessment type
            let storageKey;
            switch(formData.type) {
                case 'assignment':
                    storageKey = 'ChemistryAssignments';
                    break;
                case 'quiz':
                    storageKey = 'ChemistryQuizzes';
                    break;
                case 'exam':
                    storageKey = 'ChemistryExams';
                    break;
                default:
                    storageKey = 'ChemistryAssignments';
            }

            // Save to course page
            const courseAssessments = JSON.parse(localStorage.getItem(storageKey) || '[]');
            courseAssessments.push(courseData);
            localStorage.setItem(storageKey, JSON.stringify(courseAssessments));

            loadAssessments();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
            modal.hide();
            
            showToast('Assessment published with countdown timer!', 'success');
        }

        // Open Flashcards Modal
        function openFlashcardsModal() {
            console.log(' Chemistry Flashcards button clicked - opening modal');
            
            const modalHtml = `
                <div class="modal fade" id="flashcardsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 2rem;">
                                <h5 class="modal-title d-flex align-items-center">
                                    <div class="me-3">
                                        <iconify-icon icon="material-symbols:style" style="font-size: 1.8rem;"></iconify-icon>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">Manage Chemistry Flashcards</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9;">Add, remove, and organize flashcard categories</div>
                                    </div>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="font-size: 1.5rem; opacity: 0.8;"></button>
                            </div>
                            <div class="modal-body" style="padding: 2.5rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Current Flashcard Categories</h6>
                                        <div id="flashcardsCategoriesList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                                            <!-- Categories will be loaded here -->
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Add New Category</h6>
                                        <div class="card border-warning">
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Category Name</label>
                                                    <input type="text" class="form-control" id="newCategoryName" placeholder="e.g., Organic Chemistry">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Icon (Material Symbols)</label>
                                                    <input type="text" class="form-control" id="newCategoryIcon" placeholder="e.g., material-symbols:science">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Color</label>
                                                    <input type="color" class="form-control form-control-color" id="newCategoryColor" value="#10b981">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Number of Cards</label>
                                                    <input type="number" class="form-control" id="newCategoryCards" placeholder="0" min="0">
                                                </div>
                                                <button class="btn btn-warning w-100" onclick="addFlashcardCategory()">
                                                    <iconify-icon icon="material-symbols:add" class="me-2"></iconify-icon>
                                                    Add Category
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="background: #f8fafc; border: none; padding: 1.5rem 2.5rem;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 0.75rem 2rem; border-radius: 12px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-success" onclick="saveFlashcardsCategories()" style="padding: 0.75rem 2rem; border-radius: 12px; font-weight: 500;">
                                    <iconify-icon icon="material-symbols:save" class="me-2"></iconify-icon>
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('flashcardsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Load current categories
            loadFlashcardCategories();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('flashcardsModal'));
            console.log(' Modal created:', modal);
            modal.show();
            console.log(' Modal show() called');
        }

        // Load flashcard categories from localStorage
        function loadFlashcardCategories() {
            const categories = JSON.parse(localStorage.getItem('chemistryFlashcardsCategories') || '[{"id": 1, "title": "Atomic Structure", "icon": "material-symbols:atom", "cardsCount": 25, "color": "#10b981"}, {"id": 2, "title": "Bonding", "icon": "material-symbols:link", "cardsCount": 30, "color": "#059669"}, {"id": 3, "title": "Energetics", "icon": "material-symbols:local-fire-department", "cardsCount": 22, "color": "#f59e0b"}, {"id": 4, "title": "Kinetics", "icon": "material-symbols:speed", "cardsCount": 28, "color": "#ef4444"}, {"id": 5, "title": "Equilibrium", "icon": "material-symbols:balance", "cardsCount": 26, "color": "#8b5cf6"}, {"id": 6, "title": "Acids & Bases", "icon": "material-symbols:science", "cardsCount": 32, "color": "#06b6d4"}, {"id": 7, "title": "Redox", "icon": "material-symbols:sync", "cardsCount": 24, "color": "#ec4899"}, {"id": 8, "title": "Organic Chemistry", "icon": "material-symbols:biotech", "cardsCount": 35, "color": "#14b8a6"}]');
            
            const categoriesList = document.getElementById('flashcardsCategoriesList');
            categoriesList.innerHTML = categories.map(category => `
                <div class="list-group-item d-flex justify-content-between align-items-center" data-category-id="${category.id}">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <iconify-icon icon="${category.icon}" style="font-size: 1.5rem; color: ${category.color};"></iconify-icon>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">${category.title}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${category.cardsCount} cards</div>
                        </div>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="manageCategoryFlashcards(${category.id}, '${category.title}')">
                            <iconify-icon icon="material-symbols:edit" class="me-1"></iconify-icon>
                            Manage
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFlashcardCategory(${category.id})">
                            <iconify-icon icon="material-symbols:delete"></iconify-icon>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Add new flashcard category
        function addFlashcardCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value.trim() || 'material-symbols:category';
            const color = document.getElementById('newCategoryColor').value;
            const cardsCount = parseInt(document.getElementById('newCategoryCards').value) || 0;
            
            if (!name) {
                showToast('Please enter a category name', 'error');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('chemistryFlashcardsCategories') || '[]');
            const newCategory = {
                id: Date.now(),
                title: name,
                icon: icon,
                color: color,
                cardsCount: cardsCount
            };
            
            categories.push(newCategory);
            localStorage.setItem('chemistryFlashcardsCategories', JSON.stringify(categories));
            
            // Clear form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            document.getElementById('newCategoryColor').value = '#10b981';
            document.getElementById('newCategoryCards').value = '';
            
            // Reload categories
            loadFlashcardCategories();
            
            showToast('Category added successfully!', 'success');
        }

        // Remove flashcard category
        function removeFlashcardCategory(categoryId) {
            if (confirm('Are you sure you want to remove this category? This will also remove it from student flashcards page.')) {
                const categories = JSON.parse(localStorage.getItem('chemistryFlashcardsCategories') || '[]');
                const filteredCategories = categories.filter(cat => cat.id !== categoryId);
                localStorage.setItem('chemistryFlashcardsCategories', JSON.stringify(filteredCategories));
                
                // Reload categories
                loadFlashcardCategories();
                
                showToast('Category removed successfully!', 'success');
            }
        }

        // Save flashcards categories
        function saveFlashcardsCategories() {
            showToast('Flashcards categories saved successfully!', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('flashcardsModal'));
            modal.hide();
        }

        // Manage flashcards for a specific category
        function manageCategoryFlashcards(categoryId, categoryTitle) {
            console.log(`Managing flashcards for category ${categoryId}: ${categoryTitle}`);
            
            // Get existing flashcards for this category
            const flashcards = JSON.parse(localStorage.getItem(`chemistryFlashcards_${categoryId}`) || '[]');
            
            const modalHtml = `
                <div class="modal fade" id="manageFlashcardsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 2rem;">
                                <h5 class="modal-title d-flex align-items-center">
                                    <div class="me-3">
                                        <iconify-icon icon="material-symbols:style" style="font-size: 1.8rem;"></iconify-icon>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">Manage Flashcards: ${categoryTitle}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9;">Add, edit, and remove flashcards for this category</div>
                                    </div>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="font-size: 1.5rem; opacity: 0.8;"></button>
                            </div>
                            <div class="modal-body" style="padding: 2.5rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0">Add New Flashcard</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Question (Front of Card)</label>
                                                    <textarea class="form-control" id="newFlashcardQuestion" rows="3" placeholder="Enter the question here..."></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Answer (Back of Card)</label>
                                                    <textarea class="form-control" id="newFlashcardAnswer" rows="3" placeholder="Enter the answer here..."></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Difficulty</label>
                                                    <select class="form-control" id="newFlashcardDifficulty">
                                                        <option value="easy">Easy</option>
                                                        <option value="medium" selected>Medium</option>
                                                        <option value="hard">Hard</option>
                                                    </select>
                                                </div>
                                                <button class="btn btn-primary w-100" onclick="addTeacherFlashcard(${categoryId})">
                                                    <iconify-icon icon="material-symbols:add" class="me-2"></iconify-icon>
                                                    Add Flashcard
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-7">
                                        <div class="card border-secondary">
                                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">Current Flashcards (${flashcards.length})</h6>
                                                <button class="btn btn-sm btn-outline-light" onclick="refreshFlashcards(${categoryId})">
                                                    <iconify-icon icon="material-symbols:refresh"></iconify-icon>
                                                </button>
                                            </div>
                                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                                <div id="teacherFlashcardsList">
                                                    <!-- Flashcards will be loaded here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="background: #f8fafc; border: none; padding: 1.5rem 2.5rem;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 0.75rem 2rem; border-radius: 12px; font-weight: 500;">
                                    Close
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportFlashcards(${categoryId})" style="padding: 0.75rem 2rem; border-radius: 12px; font-weight: 500;">
                                    <iconify-icon icon="material-symbols:download" class="me-2"></iconify-icon>
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('manageFlashcardsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Load flashcards
            loadTeacherFlashcards(categoryId);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('manageFlashcardsModal'));
            modal.show();
        }

        // Load flashcards for teacher view
        function loadTeacherFlashcards(categoryId) {
            const flashcards = JSON.parse(localStorage.getItem(`chemistryFlashcards_${categoryId}`) || '[]');
            const container = document.getElementById('teacherFlashcardsList');
            
            if (flashcards.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <iconify-icon icon="material-symbols:style" style="font-size: 3rem; color: #cbd5e1;"></iconify-icon>
                        <p class="text-muted mt-3">No flashcards yet. Add your first flashcard!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = flashcards.map((card, index) => `
                <div class="card mb-3 border-light" style="background: rgba(255,255,255,0.9);">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-${card.difficulty === 'easy' ? 'success' : card.difficulty === 'medium' ? 'warning' : 'danger'} me-2">
                                        ${card.difficulty.charAt(0).toUpperCase() + card.difficulty.slice(1)}
                                    </span>
                                    <small class="text-muted">#${index + 1}</small>
                                </div>
                                <div class="mb-2">
                                    <strong>Q:</strong> ${card.question}
                                </div>
                                <div class="text-muted small">
                                    <strong>A:</strong> ${card.answer}
                                </div>
                                ${card.createdAt ? `<div class="text-muted small mt-2"><iconify-icon icon="material-symbols:schedule" class="me-1"></iconify-icon>${new Date(card.createdAt).toLocaleDateString()}</div>` : ''}
                            </div>
                            <div class="btn-group-vertical" role="group">
                                <button class="btn btn-sm btn-outline-primary mb-1" onclick="editTeacherFlashcard(${categoryId}, ${card.id})" title="Edit">
                                    <iconify-icon icon="material-symbols:edit"></iconify-icon>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTeacherFlashcard(${categoryId}, ${card.id})" title="Delete">
                                    <iconify-icon icon="material-symbols:delete"></iconify-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add new flashcard from teacher dashboard
        function addTeacherFlashcard(categoryId) {
            const question = document.getElementById('newFlashcardQuestion').value.trim();
            const answer = document.getElementById('newFlashcardAnswer').value.trim();
            const difficulty = document.getElementById('newFlashcardDifficulty').value;
            
            if (!question || !answer) {
                showToast('Please enter both question and answer', 'error');
                return;
            }
            
            // Get existing flashcards
            const flashcards = JSON.parse(localStorage.getItem(`chemistryFlashcards_${categoryId}`) || '[]');
            
            // Create new flashcard
            const newFlashcard = {
                id: Date.now(),
                question: question,
                answer: answer,
                category: getCategoryName(categoryId),
                difficulty: difficulty,
                createdAt: new Date().toISOString(),
                chapterId: categoryId
            };
            
            // Add to array and save
            flashcards.push(newFlashcard);
            localStorage.setItem(`chemistryFlashcards_${categoryId}`, JSON.stringify(flashcards));
            
            // Update category card count
            updateCategoryCardCount(categoryId, flashcards.length);
            
            // Clear form
            document.getElementById('newFlashcardQuestion').value = '';
            document.getElementById('newFlashcardAnswer').value = '';
            document.getElementById('newFlashcardDifficulty').value = 'medium';
            
            // Reload flashcards
            loadTeacherFlashcards(categoryId);
            
            showToast('Flashcard added successfully!', 'success');
        }

        // Delete flashcard from teacher dashboard
        function deleteTeacherFlashcard(categoryId, cardId) {
            if (!confirm('Are you sure you want to delete this flashcard?')) return;
            
            const flashcards = JSON.parse(localStorage.getItem(`chemistryFlashcards_${categoryId}`) || '[]');
            const updatedFlashcards = flashcards.filter(card => card.id !== cardId);
            localStorage.setItem(`chemistryFlashcards_${categoryId}`, JSON.stringify(updatedFlashcards));
            
            // Update category card count
            updateCategoryCardCount(categoryId, updatedFlashcards.length);
            
            // Reload flashcards
            loadTeacherFlashcards(categoryId);
            
            showToast('Flashcard deleted successfully!', 'success');
        }

        // Edit flashcard (simplified version - just reloads for now)
        function editTeacherFlashcard(categoryId, cardId) {
            showToast('Edit functionality coming soon!', 'info');
        }

        // Refresh flashcards list
        function refreshFlashcards(categoryId) {
            loadTeacherFlashcards(categoryId);
            showToast('Flashcards refreshed!', 'info');
        }

        // Export flashcards
        function exportFlashcards(categoryId) {
            const flashcards = JSON.parse(localStorage.getItem(`chemistryFlashcards_${categoryId}`) || '[]');
            const category = getCategoryName(categoryId);
            
            if (flashcards.length === 0) {
                showToast('No flashcards to export!', 'warning');
                return;
            }
            
            // Create CSV content
            let csvContent = "Question,Answer,Difficulty,Category\n";
            flashcards.forEach(card => {
                csvContent += `"${card.question}","${card.answer}","${card.difficulty}","${card.category}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${category}_flashcards.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast(`Exported ${flashcards.length} flashcards!`, 'success');
        }

        // Helper function to get category name
        function getCategoryName(categoryId) {
            const categories = JSON.parse(localStorage.getItem('chemistryFlashcardsCategories') || '[]');
            const category = categories.find(c => c.id === categoryId);
            return category ? category.title : 'Unknown';
        }

        // Helper function to update category card count
        function updateCategoryCardCount(categoryId, count) {
            const categories = JSON.parse(localStorage.getItem('chemistryFlashcardsCategories') || '[]');
            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            if (categoryIndex !== -1) {
                categories[categoryIndex].cardsCount = count;
                localStorage.setItem('chemistryFlashcardsCategories', JSON.stringify(categories));
                loadFlashcardCategories(); // Refresh the categories list
            }
        }
    </script>
</body>
</html>

