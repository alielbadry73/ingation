<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Checkout - IG Way IGCSE Tutoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="css/vendor.css">
  <link rel="stylesheet" type="text/css" href="style.css?v=3">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600;700&family=Roboto+Slab&display=swap"
    rel="stylesheet">
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <style>
    /* Override text-transform for all form inputs */
    input, textarea, select, .form-control, .form-select {
      text-transform: none !important;
    }
  </style>
</head>
<body>
  <!-- Top Utility Bar -->
  <div class="top-utility-bar" style="background:#fff; border-bottom:1px solid #eee; position:relative; height:60px;">
    <div class="container-fluid" style="position:relative; height:100%;">
      
      <!-- Centered Logo -->
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);">
        <a href="index.html">
          <img src="images/ig-nation-logo-graduation.png" alt="IG Nation" style="height:50px; width:auto;">
        </a>
      </div>

      <!-- Right-aligned Utility Links -->
      <div style="position:absolute; right:20px; top:50%; transform:translateY(-50%); display:flex; align-items:center; gap:20px; font-size:14px;">
        
        <!-- User Name Display -->
        <div id="userNameDisplay" style="display:none;">
          <span class="text-primary fw-bold" id="displayUserName">User</span>
          <a href="#" onclick="logout(); return false;" class="utility-link ms-2" style="text-decoration:none; color:#dc3545;">
            <iconify-icon icon="material-symbols:logout" style="margin-right:5px;"></iconify-icon>
            Logout
          </a>
        </div>

        <!-- Language Dropdown -->
        <div class="language-dropdown" style="position:relative;">
          <a href="#" class="utility-link" data-bs-toggle="dropdown" style="text-decoration:none; color:#000; display:flex; align-items:center;">
            Language <iconify-icon icon="material-symbols:keyboard-arrow-down" style="margin-left:5px;"></iconify-icon>
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">English</a></li>
            <li><a class="dropdown-item" href="#">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</a></li>
          </ul>
        </div>

        <!-- Cart Button -->
        <a href="#" class="utility-link" data-bs-toggle="modal" data-bs-target="#cartModal" style="text-decoration:none; color:#000; display:flex; align-items:center; position:relative;">
          <iconify-icon icon="material-symbols:shopping-cart" style="margin-right:5px;"></iconify-icon>
          Cart <span class="badge bg-primary ms-1" id="cartCount">0</span>
        </a>

        <!-- Favorites -->
        <a href="#" class="utility-link" data-bs-toggle="modal" data-bs-target="#favoritesModal" style="text-decoration:none; color:#000; display:flex; align-items:center;">
          <iconify-icon icon="material-symbols:favorite" style="margin-right:5px;"></iconify-icon>
          Favorites
        </a>
      </div>
    </div>
  </div>

  <!-- Main Navigation Bar -->
  <nav class="main-navigation">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-7">
          <ul class="nav-menu d-flex list-unstyled mb-0">
            <li class="nav-item">
              <a href="index.html" class="nav-link">Home</a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">Courses</a>
            </li>
            <li class="nav-item">
              <a href="about.html" class="nav-link">About Us</a>
            </li>
            <li class="nav-item">
              <a href="contact.html" class="nav-link">Contact Us</a>
            </li>
            <li class="nav-item">
              <!-- FAQ removed -->
            </li>
          </ul>
        </div>
        <div class="col-5">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <a href="#" class="btn btn-outline-secondary login-btn" data-bs-toggle="modal" data-bs-target="#loginModal" style="font-size: 14px; padding: 8px 16px;">
              <iconify-icon icon="material-symbols:login" class="me-1"></iconify-icon>
              Login
            </a>
            <a href="#" class="btn btn-primary register-btn" data-bs-toggle="modal" data-bs-target="#registerModal" style="font-size: 14px; padding: 8px 16px;">
              <iconify-icon icon="material-symbols:person-add" class="me-1"></iconify-icon>
              Register Now
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Checkout Section -->
  <section class="checkout-section py-5" style="margin-top: 120px;">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h3 class="mb-0">
                <iconify-icon icon="material-symbols:payment" class="me-2"></iconify-icon>
                // Determine if the user is logged in (support multiple possible keys)
                function isUserLoggedIn() {
                  return !!(
                    localStorage.getItem('userLoggedIn') ||
                    localStorage.getItem('authToken') ||
                    localStorage.getItem('userId') ||
                    localStorage.getItem('userEmail')
                  );
                }

                // Check login state and update UI
                function checkLoginState() {
                  const isLoggedIn = isUserLoggedIn();
                  const userName = localStorage.getItem('userName');

                  if (isLoggedIn) {
                    // Show user name in utility bar
                    const userNameDisplay = document.getElementById('userNameDisplay');
                    const displayUserName = document.getElementById('displayUserName');
                    if (userNameDisplay && displayUserName) {
                      userNameDisplay.style.display = 'block';
                      displayUserName.textContent = userName || 'User';
                    }

                    // Hide login and register buttons
                    const loginBtn = document.querySelector('.login-btn');
                    const registerBtn = document.querySelector('.register-btn');

                    if (loginBtn) loginBtn.style.display = 'none';
                    if (registerBtn) registerBtn.style.display = 'none';

                    console.log('✓ User logged in - Login and Register buttons hidden');
                  } else {
                    // Hide user name
                    const userNameDisplay = document.getElementById('userNameDisplay');
                    if (userNameDisplay) userNameDisplay.style.display = 'none';

                    // Show login and register buttons
                    const loginBtn = document.querySelector('.login-btn');
                    const registerBtn = document.querySelector('.register-btn');

                    if (loginBtn) loginBtn.style.display = 'inline-block';
                    if (registerBtn) registerBtn.style.display = 'inline-block';
                  }
                }

                // Logout function
                function logout() {
                  localStorage.removeItem('userLoggedIn');
                  localStorage.removeItem('userName');
                  localStorage.removeItem('userEmail');
                  localStorage.removeItem('authToken');
                  localStorage.removeItem('userId');
                  localStorage.removeItem('enrolledCourses');
                  window.location.href = 'index.html';
                }

                // Immediately hide buttons if logged in (before DOM loads)
                if (isUserLoggedIn()) {
                  const style = document.createElement('style');
                  style.textContent = '.login-btn, .register-btn { display: none !important; }';
                  document.head.appendChild(style);
                  console.log('🔒 User already logged in - hiding auth buttons immediately');
                }
                <div class="mb-4" id="paymentDetails" style="display: none;">
                  <h5 class="text-primary mb-3">Payment Details</h5>
                  <div id="instapayDetails" class="payment-details" style="display: none;">
                    <div class="alert alert-info">
                      <h6>InstaPay Transfer Details:</h6>
                      <p><strong>Bank:</strong> National Bank of Egypt</p>
                      <p><strong>Account Name:</strong> IG Way Education</p>
                      <p><strong>Account Number:</strong> 1234567890</p>
                      <p><strong>Amount:</strong> <span id="instapayAmount"></span></p>
                    </div>
                  </div>
                  <div id="vodafoneCashDetails" class="payment-details" style="display: none;">
                    <div class="alert alert-success">
                      <h6>Vodafone Cash Details:</h6>
                      <p><strong>Phone Number:</strong> +201027500835</p>
                      <p><strong>Amount:</strong> <span id="vodafoneAmount"></span></p>
                    </div>
                  </div>
                </div>

                <!-- Payment Screenshot Upload -->
                <div class="mb-4" id="screenshotUpload" style="display: none;">
                  <h5 class="text-primary mb-3">
                    <iconify-icon icon="material-symbols:upload" class="me-2"></iconify-icon>
                    Upload Payment Screenshot
                  </h5>
                  <div class="form-group">
                    <label for="paymentScreenshot" class="form-label">Payment Screenshot *</label>
                    <input type="file" class="form-control" id="paymentScreenshot" accept="image/*" required>
                    <div class="form-text">
                      <iconify-icon icon="material-symbols:info" class="me-1"></iconify-icon>
                      Please upload a clear screenshot of your payment confirmation. This will be sent to WhatsApp for verification.
                    </div>
                    <div class="alert alert-warning mt-2">
                      <iconify-icon icon="material-symbols:warning" class="me-2"></iconify-icon>
                      <strong>Important:</strong> After submitting your order, you'll be redirected to WhatsApp where you'll need to attach this screenshot manually.
                    </div>
                  </div>
                </div>

                <div class="d-flex gap-3">
                  <button type="button" class="btn btn-secondary" onclick="window.history.back()">Back to Cart</button>
                  <button type="button" class="btn btn-success" id="submitOrderBtn" disabled>Submit Order</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <iconify-icon icon="material-symbols:shopping-cart" class="me-2 text-primary"></iconify-icon>
                Order Summary
              </h5>
            </div>
            <div class="card-body">
              <div id="orderSummary">
                <div class="text-center text-muted py-4">
                  <iconify-icon icon="material-symbols:shopping-cart-outline" class="fs-1 mb-3"></iconify-icon>
                  <p>Loading order details...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer bg-dark text-white py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5>About Us</h5>
          <p>We provide top-quality IGCSE tutoring to help students achieve academic excellence.</p>
        </div>
        <div class="col-md-4">
          <h5>Contact Info</h5>
          <ul class="list-unstyled">
            <li><iconify-icon icon="material-symbols:phone"></iconify-icon> +201027500835</li>
            <li><iconify-icon icon="material-symbols:mail"></iconify-icon> random@email.com</li>
            <li><iconify-icon icon="material-symbols:location-on"></iconify-icon> Egypt, New Cairo</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h5>Follow Us</h5>
          <div class="social-icons">
            <a href="#" class="text-white me-2"><iconify-icon icon="mdi:facebook"></iconify-icon></a>
            <a href="#" class="text-white me-2"><iconify-icon icon="mdi:twitter"></iconify-icon></a>
            <a href="#" class="text-white me-2"><iconify-icon icon="mdi:instagram"></iconify-icon></a>
          </div>
        </div>
      </div>
      <hr class="mt-4">
      <div class="text-center">
        <p>&copy; 2023 IG Way IGCSE Tutoring. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="js/jquery-1.11.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
  <script src="js/plugins.js"></script>

  <script>
    // Global variables
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    // Fetch course data from homenocourses.html if needed
    let homenocoursesData = null;

    // Course data
    const courses = {
      mathematics: {
        title: 'IGCSE Mathematics (Extended)',
        instructor: 'Dr. Sarah Mitchell',
        board: 'Cambridge Board',
        price: 'Â£299.00',
        originalPrice: 'Â£399.00',
        image: 'images/teacher1.PNG'
      },
      physics: {
        title: 'IGCSE Physics',
        instructor: 'Prof. Michael Chen',
        board: 'Cambridge Board',
        price: 'Â£279.00',
        originalPrice: 'Â£349.00',
        image: 'images/teacher2.PNG'
      },
      english: {
        title: 'IGCSE English Language',
        instructor: 'Dr. Emily Rodriguez',
        board: 'Cambridge Board',
        price: 'Â£249.00',
        originalPrice: 'Â£329.00',
        image: 'images/teacher3.PNG'
      },
      chemistry: {
        title: 'IGCSE Chemistry',
        instructor: 'Dr. James Wilson',
        board: 'Cambridge Board',
        price: 'Â£269.00',
        originalPrice: 'Â£339.00',
        image: 'images/teacher4.PNG'
      },
      biology: {
        title: 'IGCSE Biology',
        instructor: 'Dr. Lisa Anderson',
        board: 'Cambridge Board',
        price: 'Â£259.00',
        originalPrice: 'Â£319.00',
        image: 'images/teacher5.PNG'
      }
    };

    // Check login state and update UI
    function checkLoginState() {
      const isLoggedIn = localStorage.getItem('userLoggedIn');
      const userName = localStorage.getItem('userName');
      
      if (isLoggedIn) {
        // Show user name in utility bar
        const userNameDisplay = document.getElementById('userNameDisplay');
        const displayUserName = document.getElementById('displayUserName');
        if (userNameDisplay && displayUserName) {
          userNameDisplay.style.display = 'block';
          displayUserName.textContent = userName || 'User';
        }
        
        // Hide login and register buttons
        const loginBtn = document.querySelector('.login-btn');
        const registerBtn = document.querySelector('.register-btn');
        
        if (loginBtn) {
          loginBtn.style.display = 'none';
        }
        
        if (registerBtn) {
          registerBtn.style.display = 'none';
        }
        
        console.log('âœ… User logged in - Login and Register buttons hidden');
      } else {
        // Hide user name
        const userNameDisplay = document.getElementById('userNameDisplay');
        if (userNameDisplay) {
          userNameDisplay.style.display = 'none';
        }
        
        // Show login and register buttons
        const loginBtn = document.querySelector('.login-btn');
        const registerBtn = document.querySelector('.register-btn');
        
        if (loginBtn) {
          loginBtn.style.display = 'inline-block';
        }
        
        if (registerBtn) {
          registerBtn.style.display = 'inline-block';
        }
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('userLoggedIn');
      localStorage.removeItem('userName');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('enrolledCourses');
      window.location.href = 'index.html';
    }

    // Immediately hide buttons if logged in (before DOM loads)
    if (localStorage.getItem('userLoggedIn')) {
      const style = document.createElement('style');
      style.textContent = '.login-btn, .register-btn { display: none !important; }';
      document.head.appendChild(style);
      console.log('ðŸ”’ User already logged in - hiding auth buttons immediately');
    }

    // Fetch course data from API
    async function fetchCourseData() {
      try {
        const response = await fetch('https://elbadry-production.up.railway.app/api/courses');
        if (response.ok) {
          const data = await response.json();
          homenocoursesData = data;
          console.log('Fetched course data:', homenocoursesData);
        }
      } catch (error) {
        console.error('Error fetching course data:', error);
        // Fallback to hardcoded data
        homenocoursesData = [
          {
            id: 115,
            title: 'IGCSE Mathematics (Extended)',
            instructor: 'Dr. Sarah Mitchell',
            board: 'Cambridge Board',
            price: 299.00,
            image: 'images/teacher1.PNG',
            subject: 'mathematics'
          },
          {
            id: 116,
            title: 'IGCSE Physics (Extended)',
            instructor: 'Prof. Michael Chen',
            board: 'Cambridge Board',
            price: 289.00,
            image: 'images/teacher2.PNG',
            subject: 'physics'
          },
          {
            id: 117,
            title: 'IGCSE English Language',
            instructor: 'Dr. Emily Rodriguez',
            board: 'Cambridge Board',
            price: 279.00,
            image: 'images/teacher3.PNG',
            subject: 'english'
          }
        ];
        console.log('Using fallback course data:', homenocoursesData);
      }
    }

    // Get course by ID from fetched data or fallback
    function getCourseById(courseId) {
      console.log('getCourseById called with:', courseId, 'homenocoursesData:', homenocoursesData);
      if (homenocoursesData) {
        const course = homenocoursesData.find(c => c.id == courseId);
        console.log('Found course in homenocoursesData:', course);
        if (course) {
          const result = {
            title: course.title,
            instructor: course.instructor,
            board: course.board || 'Cambridge Board',
            price: `Â£${course.price.toFixed(2)}`,
            image: course.image
          };
          console.log('Returning course data:', result);
          return result;
        }
      }
      console.log('No course found for ID:', courseId);
      return null;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Checkout page loaded');
      console.log('Cart from localStorage:', JSON.parse(localStorage.getItem('cart')) || []);
      
      // Check login state
      checkLoginState();
      
      // Fetch course data
      await fetchCourseData();
      
      console.log('Cart items:', cart);
      console.log('Homenocourses data loaded:', homenocoursesData);
      console.log('Testing getCourseById with 115:', getCourseById('115'));
      
      if (cart.length === 0) {
        // Redirect to home if cart is empty
        window.location.href = 'index.html';
        return;
      }
      
      updateOrderSummary();
      console.log('updateOrderSummary called, checking if orderSummary element exists:', document.getElementById('orderSummary'));
      setupCheckoutEventListeners();
    });

    function updateOrderSummary() {
      const orderSummary = document.getElementById('orderSummary');
      let total = 0;
      
      const summaryHTML = cart.map(item => {
        console.log('Processing cart item:', item);
        console.log('Looking for course with ID:', item.courseId);
        
        // Handle multiple cases: course data directly in item, numeric ID, or string ID
        let course;
        if (item.title) {
          // Course data is directly in the cart item (from homenocourses.html)
          course = {
            title: item.title,
            instructor: item.instructor,
            board: item.board || 'Cambridge Board',
            price: item.price ? `Â£${item.price.toFixed(2)}` : 'Â£299.00',
            image: item.image || 'images/teacher1.PNG'
          };
          console.log('Using course data from cart item:', course);
        } else {
          // Try to get course by numeric ID first (from homenocourses.html)
          course = getCourseById(item.courseId);
          if (!course) {
            // Fallback to string-based lookup (legacy)
            course = courses[item.courseId];
            console.log('Found course from string lookup:', course);
          } else {
            console.log('Found course from numeric ID lookup:', course);
          }
          
          if (!course) {
            console.log('Course not found for ID:', item.courseId);
            return '';
          }
        }
        
        const priceValue = course.price ? parseFloat(course.price.replace('Â£', '')) : item.price || 299.00;
        const itemTotal = priceValue * item.quantity;
        total += itemTotal;
        
        return `
          <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
            <div class="d-flex align-items-center">
              <img src="${course.image}" alt="${course.title}" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
              <div>
                <div class="fw-bold text-primary">${course.title}</div>
                <div class="text-muted small">${course.instructor} - ${course.board}</div>
                <div class="text-success fw-bold">${course.price} <span class="text-muted">x${item.quantity}</span></div>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold">Â£${itemTotal.toFixed(2)}</div>
            </div>
          </div>
        `;
      }).join('') + `
        <hr>
        <div class="d-flex justify-content-between align-items-center fw-bold fs-5">
          <span>Total</span>
          <span class="text-primary">Â£${total.toFixed(2)}</span>
        </div>
      `;
      
      console.log('Generated summaryHTML:', summaryHTML);
      console.log('Order summary element:', orderSummary);
      orderSummary.innerHTML = summaryHTML;
      
      // Update payment amounts
      document.getElementById('instapayAmount').textContent = `Â£${total.toFixed(2)}`;
      document.getElementById('vodafoneAmount').textContent = `Â£${total.toFixed(2)}`;
    }

    function setupCheckoutEventListeners() {
      // Payment method change
      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updatePaymentDetails();
        });
      });

      // Submit order button
      document.getElementById('submitOrderBtn').addEventListener('click', function() {
        console.log('Submit button clicked');
        submitOrder();
      });
    }

    function updatePaymentDetails() {
      const paymentDetails = document.getElementById('paymentDetails');
      const screenshotUpload = document.getElementById('screenshotUpload');
      const instapayDetails = document.getElementById('instapayDetails');
      const vodafoneCashDetails = document.getElementById('vodafoneCashDetails');
      const submitOrderBtn = document.getElementById('submitOrderBtn');
      
      const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
      
      if (selectedPayment) {
        paymentDetails.style.display = 'block';
        screenshotUpload.style.display = 'block';
        submitOrderBtn.disabled = false;
        
        if (selectedPayment.value === 'instapay') {
          instapayDetails.style.display = 'block';
          vodafoneCashDetails.style.display = 'none';
        } else if (selectedPayment.value === 'vodafoneCash') {
          instapayDetails.style.display = 'none';
          vodafoneCashDetails.style.display = 'block';
        }
      } else {
        paymentDetails.style.display = 'none';
        screenshotUpload.style.display = 'none';
        submitOrderBtn.disabled = true;
      }
    }

    async function submitOrder() {
      console.log('submitOrder function called');
      const form = document.getElementById('checkoutForm');
      
      // Validate form
      if (!form.checkValidity()) {
        console.log('Form validation failed');
        form.reportValidity();
        return;
      }
      
      console.log('Form validation passed');
      
      // Get payment screenshot
      const screenshot = document.getElementById('paymentScreenshot').files[0];
      if (!screenshot) {
        showToast('Please upload a payment screenshot', 'warning');
        return;
      }
      
      // Get form data
      const firstName = document.getElementById('checkoutFirstName').value;
      const lastName = document.getElementById('checkoutLastName').value;
      const email = document.getElementById('checkoutEmail').value;
      const phone = document.getElementById('checkoutPhone').value;
      
      // Get order summary
      const orderItems = cart.map(item => {
        let course;
        if (item.title) {
          course = {
            title: item.title,
            price: item.price ? `Â£${item.price.toFixed(2)}` : 'Â£299.00'
          };
        } else {
          course = getCourseById(item.courseId) || courses[item.courseId];
        }
        return `${course.title} - ${course.price}`;
      }).join('\n');
      
      const total = cart.reduce((sum, item) => {
        let course;
        if (item.title) {
          course = {
            price: item.price ? `Â£${item.price.toFixed(2)}` : 'Â£299.00'
          };
        } else {
          course = getCourseById(item.courseId) || courses[item.courseId];
        }
        return sum + parseFloat(course.price.replace('Â£', ''));
      }, 0);
      
      // Get payment method
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
      const paymentType = paymentMethod ? paymentMethod.value : 'unknown';
      
      try {
        // Create order in database
        const orderData = {
          courses: cart.map(item => {
            let course;
            let courseId;
            
            if (item.title) {
              // Course data is directly in the cart item (from homenocourses.html)
              // Map course titles to numeric IDs for database
              switch(item.title.toLowerCase()) {
                case 'igcse mathematics (extended)':
                case 'igcse mathematics':
                  courseId = 1;
                  break;
                case 'igcse physics':
                case 'igcse physics (extended)':
                  courseId = 2;
                  break;
                case 'igcse chemistry':
                case 'igcse chemistry (extended)':
                  courseId = 3;
                  break;
                case 'igcse english language':
                  courseId = 4;
                  break;
                default:
                  console.error('Unknown course title:', item.title);
                  return null;
              }
            } else {
              // Handle numeric course IDs (from homenocourses.html) or string IDs (legacy)
              if (typeof item.courseId === 'number' || !isNaN(parseInt(item.courseId))) {
                // Numeric course ID - map to database IDs
                const numericId = parseInt(item.courseId);
                switch(numericId) {
                  case 115:
                    courseId = 1; // Mathematics
                    break;
                  case 116:
                    courseId = 2; // Physics
                    break;
                  case 117:
                    courseId = 4; // English
                    break;
                  default:
                    console.error('Unknown numeric course ID:', item.courseId);
                    return null;
                }
              } else {
                // String course ID (legacy)
                course = courses[item.courseId];
                if (!course) {
                  console.error('Course not found for ID:', item.courseId);
                  return null;
                }
                
                // Map course names to numeric IDs for database
                switch(item.courseId) {
                  case 'mathematics':
                    courseId = 1;
                    break;
                  case 'physics':
                    courseId = 2;
                    break;
                  case 'chemistry':
                    courseId = 3;
                    break;
                  case 'english':
                    courseId = 4;
                    break;
                  default:
                    console.error('Unknown course ID:', item.courseId);
                    return null;
                }
              }
            }
            
            const price = item.price || (course ? parseFloat(course.price.replace('Â£', '')) : 299.00);
            return {
              id: courseId,
              quantity: item.quantity,
              price: price
            };
          }).filter(course => course !== null), // Remove null entries
          totalAmount: total,
          paymentMethod: paymentType,
          paymentScreenshot: 'uploaded_screenshot.jpg' // Placeholder
        };
        
        console.log('Saving order to database:', orderData);
        
  const orderResponse = await fetch('/api/orders', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'temp'}`
          },
          body: JSON.stringify(orderData)
        });
        
        if (orderResponse.ok) {
          console.log('Order saved to database successfully');
          showToast('Order saved to database!', 'success');
        } else {
          console.log('Failed to save order to database, but continuing...');
        }
        
      } catch (error) {
        console.error('Database error:', error);
        // Continue with WhatsApp redirect even if database save fails
      }
      
      // Create WhatsApp message
      const message = `ðŸŽ“ *IG Nation - Course Purchase Confirmation*

ðŸ‘¤ *Student Details:*
â€¢ Name: ${firstName} ${lastName}
â€¢ Email: ${email}
â€¢ Phone: ${phone}

ðŸ“š *Courses Purchased:*
${orderItems}

ðŸ’° *Total Amount: Â£${total.toFixed(2)}*
ðŸ’³ *Payment Method:* ${paymentType === 'instapay' ? 'InstaPay' : 'Vodafone Cash'}

ðŸ“¸ *Payment Screenshot:* I will attach the screenshot in WhatsApp

Please verify the payment and activate my courses. Thank you!`;

      // Show success message
      showToast('Order submitted successfully! Opening WhatsApp...', 'success');
      
      // Clear cart
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Redirect to WhatsApp with message
      const phoneNumber = '201027500835'; // WhatsApp number
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      console.log('Opening WhatsApp...');
      
      // Store screenshot info for user reference
      localStorage.setItem('lastPaymentScreenshot', screenshot.name);
      
      // Show instructions about attaching screenshot
      alert('ðŸ“± You will be redirected to WhatsApp.\n\nâš ï¸ IMPORTANT: Please attach your payment screenshot manually in WhatsApp before sending the message!\n\nScreenshot file: ' + screenshot.name);
      
      // Open WhatsApp in new tab
      setTimeout(() => {
        window.open(whatsappUrl, '_blank');
        // Redirect to test-dashboard after opening WhatsApp (user will have courses after admin approves)
        setTimeout(() => {
          window.location.href = 'test-dashboard.html';
        }, 1500);
      }, 1500);
    }

    // testRedirect function removed - no longer needed

    function redirectToWhatsApp(message, screenshot) {
      const phoneNumber = '201027500835'; // Remove + for WhatsApp URL
      const encodedMessage = encodeURIComponent(message);
      
      // Create WhatsApp URL
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      // Show detailed instructions modal
      showWhatsAppInstructions(screenshot);
      
      // Open WhatsApp in new tab after a short delay
      setTimeout(() => {
        window.open(whatsappUrl, '_blank');
      }, 2000);
    }

    function showWhatsAppInstructions(screenshot) {
      // Create modal for instructions
      const modalHtml = `
        <div class="modal fade" id="whatsappInstructionsModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                  <iconify-icon icon="logos:whatsapp-icon" class="me-2"></iconify-icon>
                  WhatsApp Instructions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-info">
                  <h6><iconify-icon icon="material-symbols:info" class="me-2"></iconify-icon>Next Steps:</h6>
                  <ol>
                    <li>WhatsApp will open automatically in a new tab</li>
                    <li>Your order details are already pre-filled in the message</li>
                    <li><strong>Attach your payment screenshot</strong> to the WhatsApp chat</li>
                    <li>Send the message to complete your order</li>
                  </ol>
                </div>
                
                <div class="alert alert-warning">
                  <h6><iconify-icon icon="material-symbols:warning" class="me-2"></iconify-icon>Important:</h6>
                  <p>Please make sure to attach the payment screenshot you uploaded. This is required for order verification.</p>
                </div>
                
                <div class="text-center">
                  <p class="mb-3">WhatsApp Number: <strong>+201027500835</strong> (will open WhatsApp)</p>
                  <button class="btn btn-success" onclick="openWhatsAppDirectly()">
                    <iconify-icon icon="logos:whatsapp-icon" class="me-2"></iconify-icon>
                    Open WhatsApp Now
                  </button>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('whatsappInstructionsModal'));
      modal.show();
      
      // Auto-close after 10 seconds
      setTimeout(() => {
        modal.hide();
        // Redirect to home
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      }, 10000);
    }

    function openWhatsAppDirectly() {
      const phoneNumber = '201027500835'; // Remove + for WhatsApp URL
      const message = `ðŸŽ“ *IG Way IGCSE Tutoring - Course Purchase Confirmation*

ðŸ‘¤ *Student Details:*
â€¢ Name: ${document.getElementById('checkoutFirstName').value} ${document.getElementById('checkoutLastName').value}
â€¢ Email: ${document.getElementById('checkoutEmail').value}
â€¢ Phone: ${document.getElementById('checkoutPhone').value}

ðŸ“š *Courses Purchased:*
${cart.map(item => {
  const course = courses[item.courseId];
  return `${course.title} - ${course.price}`;
}).join('\n')}

ðŸ’° *Total Amount: Â£${cart.reduce((sum, item) => {
  const course = courses[item.courseId];
  return sum + parseFloat(course.price.replace('Â£', ''));
}, 0).toFixed(2)}*

ðŸ“¸ *Payment Screenshot Attached*

Please verify the payment and activate my courses. Thank you!`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      let icon = 'material-symbols:info';
      let title = 'Notification';
      let bgClass = 'bg-primary';
      
      if (type === 'warning') {
        icon = 'material-symbols:warning';
        title = 'Warning!';
        bgClass = 'bg-warning';
      } else if (type === 'success') {
        icon = 'material-symbols:check-circle';
        title = 'Success!';
        bgClass = 'bg-success';
      }
      
      const toastHTML = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header ${bgClass} text-white">
            <iconify-icon icon="${icon}" class="me-2"></iconify-icon>
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000
      });
      
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    }
  </script>
</body>
</html>

< ! - -   C a c h e   b u s t :   2 0 2 5 1 0 0 8 1 6 4 0 2 4   - - > 
 
 
